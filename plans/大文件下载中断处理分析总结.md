---
**Metaä¿¡æ¯**
- **é…ç½®æ–‡ä»¶**: `/home/celestial/dev/esdk-test/Edge-SDK/celestial_nasops/unified_config.json`
- **SSHé…ç½®**: `/home/celestial/.ssh/config` (host: nas-edge)
---

# å¤§æ–‡ä»¶ä¸‹è½½ä¸­æ–­å¤„ç†åˆ†ææ€»ç»“

## æ‰§è¡Œæ‘˜è¦

### é¡¹ç›®èƒŒæ™¯

æœ¬æ–‡æ¡£é’ˆå¯¹DJI Edge SDKç³»ç»Ÿä¸­å¤§æ–‡ä»¶ä¼ è¾“çš„ä¸­æ–­å¤„ç†é—®é¢˜ï¼Œæä¾›äº†å®Œæ•´çš„åˆ†æå’Œè§£å†³æ–¹æ¡ˆã€‚å½“å‰ç³»ç»Ÿåœ¨å¤„ç†å¤§æ–‡ä»¶(>50MB)ä¼ è¾“æ—¶å­˜åœ¨å¤šä¸ªå…³é”®é—®é¢˜ï¼Œä¸¥é‡å½±å“äº†ç³»ç»Ÿçš„å¯é æ€§å’Œç”¨æˆ·ä½“éªŒã€‚

### æ ¸å¿ƒé—®é¢˜è¯†åˆ«

**æŠ€æœ¯é—®é¢˜**:
- å†…å­˜æº¢å‡ºé£é™©ï¼šå¤§æ–‡ä»¶å…¨é‡åŠ è½½åˆ°å†…å­˜å¯¼è‡´ç³»ç»Ÿå´©æºƒ
- ç½‘ç»œä¸­æ–­æ— æ¢å¤ï¼šä¼ è¾“ä¸­æ–­åæ— æ³•æ–­ç‚¹ç»­ä¼ 
- å®Œæ•´æ€§éªŒè¯ç¼ºå¤±ï¼šæ— æ³•æ£€æµ‹ä¼ è¾“è¿‡ç¨‹ä¸­çš„æ•°æ®æŸå
- å­˜å‚¨ç©ºé—´ç®¡ç†ä¸è¶³ï¼šç¼ºä¹æ™ºèƒ½çš„å­˜å‚¨ç©ºé—´ç›‘æ§å’Œæ¸…ç†

**ä¸šåŠ¡å½±å“**:
- ä¼ è¾“æˆåŠŸç‡ä½äº85%ï¼Œä¸¥é‡å½±å“ä¸šåŠ¡è¿ç»­æ€§
- ç³»ç»Ÿèµ„æºæ¶ˆè€—è¿‡é«˜ï¼ŒCPUä½¿ç”¨ç‡è¾¾35%ï¼Œå†…å­˜å ç”¨800MB+
- æ•…éšœæ¢å¤æ—¶é—´é•¿è¾¾10åˆ†é’Ÿï¼Œå½±å“è¿ç»´æ•ˆç‡

### è§£å†³æ–¹æ¡ˆæ¦‚è§ˆ

**é˜¶æ®µäºŒæ ¸å¿ƒæ–¹æ¡ˆ**: EdgeæœåŠ¡å™¨åˆ°NASå­˜å‚¨çš„æ™ºèƒ½ä¼ è¾“ä¼˜åŒ–

1. **æ™ºèƒ½ä¼ è¾“ç®¡ç†**: åŸºäºrsyncçš„åˆ†å—ä¼ è¾“å’Œæ–­ç‚¹ç»­ä¼ 
2. **å­˜å‚¨ç©ºé—´æ™ºèƒ½åŒ–**: è‡ªåŠ¨ç›‘æ§ã€é¢„è­¦å’Œæ¸…ç†æœºåˆ¶
3. **å®Œæ•´æ€§å¤šå±‚éªŒè¯**: rsyncå†…ç½®æ ¡éªŒ + åº”ç”¨å±‚åˆ†å—éªŒè¯
4. **ç›‘æ§å‘Šè­¦ç³»ç»Ÿ**: å®æ—¶ç›‘æ§å’Œæ™ºèƒ½å‘Šè­¦è§„åˆ™å¼•æ“
5. **ç³»ç»Ÿé›†æˆä¼˜åŒ–**: ä¸ç°æœ‰ç³»ç»Ÿæ— ç¼é›†æˆï¼Œç»Ÿä¸€é…ç½®ç®¡ç†

### é¢„æœŸæ•ˆæœ

**æ€§èƒ½æå‡**:
- ä¼ è¾“æˆåŠŸç‡ï¼š85% â†’ 99.5%+
- CPUä½¿ç”¨ç‡ï¼š35% â†’ 20%
- å†…å­˜å ç”¨ï¼š800MB â†’ 500MB
- æ•…éšœæ¢å¤æ—¶é—´ï¼š10åˆ†é’Ÿ â†’ 5åˆ†é’Ÿ

**ä¸šåŠ¡ä»·å€¼**:
- ç³»ç»Ÿå¯é æ€§æ˜¾è‘—æå‡ï¼Œå‡å°‘äººå·¥å¹²é¢„
- è¿ç»´æ•ˆç‡æ”¹å–„ï¼Œè‡ªåŠ¨åŒ–ç¨‹åº¦æé«˜
- å­˜å‚¨èµ„æºåˆ©ç”¨ç‡ä¼˜åŒ–ï¼Œæˆæœ¬æ§åˆ¶æ”¹å–„
- å†…å­˜ä½¿ç”¨ä»æ–‡ä»¶å¤§å°çº§åˆ«é™ä½è‡³å›ºå®š100MBä»¥å†…
- ç½‘ç»œä¸­æ–­å30ç§’å†…è‡ªåŠ¨æ¢å¤ä¼ è¾“
- å®ç°100%çš„æ•°æ®å®Œæ•´æ€§éªŒè¯

## é¡¹ç›®èƒŒæ™¯ä¸ç›®æ ‡

### ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ
```
æ— äººæœºDock â†’ è¾¹ç¼˜æœåŠ¡å™¨(Edge) â†’ NASå­˜å‚¨è®¾å¤‡
     â†“              â†“              â†“
  æ–‡ä»¶å‘ç°        ä¸´æ—¶å­˜å‚¨        æ°¸ä¹…å­˜å‚¨
  çŠ¶æ€é€šçŸ¥        å¤„ç†è½¬å‘        å¤‡ä»½å½’æ¡£
```

### å½“å‰ç³»ç»Ÿé—®é¢˜åˆ†æ

åŸºäºå¯¹ç°æœ‰ç³»ç»Ÿ `/home/celestial/dev/esdk-test/Edge-SDK/celestial_works/src/dock_info_manager.cc` çš„æ·±åº¦åˆ†æï¼Œè¯†åˆ«å‡ºä»¥ä¸‹**å…³é”®é—®é¢˜**ï¼š

#### ğŸ”´ é«˜ä¼˜å…ˆçº§é—®é¢˜
1. **å†…å­˜æº¢å‡ºé£é™©**: å¤§æ–‡ä»¶(>100MB)ä¸€æ¬¡æ€§åŠ è½½åˆ°å†…å­˜vectorï¼Œå¯¼è‡´ç³»ç»ŸOOM
2. **æ— ä¸­æ–­æ¢å¤**: ç½‘ç»œä¸­æ–­æ—¶ä¼ è¾“å¤±è´¥ï¼Œæ— æ–­ç‚¹ç»­ä¼ æœºåˆ¶
3. **æ— å®Œæ•´æ€§éªŒè¯**: DJI SDKä¸æä¾›æ–‡ä»¶å“ˆå¸Œå€¼ï¼Œæ— æ³•æ£€æµ‹æ•°æ®æŸå

#### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§é—®é¢˜
4. **ç›‘æ§ç›²åŒº**: æ— ä¼ è¾“è¿›åº¦ã€é€Ÿåº¦ç›‘æ§ï¼Œæ•…éšœæ’æŸ¥å›°éš¾
5. **çŠ¶æ€ç®¡ç†ç¼ºå¤±**: æ— æ³•è·Ÿè¸ªä¼ è¾“çŠ¶æ€ï¼Œç³»ç»Ÿé‡å¯åä¸¢å¤±è¿›åº¦
6. **èµ„æºç«äº‰**: å¤šæ–‡ä»¶åŒæ—¶ä¼ è¾“æ—¶æ— å¹¶å‘æ§åˆ¶

#### ğŸŸ¢ ä½ä¼˜å…ˆçº§é—®é¢˜
7. **å­˜å‚¨ç©ºé—´æ£€æµ‹**: ä¼ è¾“å‰æœªæ£€æŸ¥å¯ç”¨ç©ºé—´
8. **æ€§èƒ½ä¼˜åŒ–**: ä¼ è¾“å‚æ•°æœªæ ¹æ®ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´

### è§£å†³æ–¹æ¡ˆæ¶æ„

**åˆ†é˜¶æ®µå®æ–½ç­–ç•¥**ï¼š
- **é˜¶æ®µä¸€** (æ ¸å¿ƒä¼˜åŒ–): Dockâ†’Edgeä¼ è¾“å¯é æ€§ (è§£å†³ğŸ”´é«˜ä¼˜å…ˆçº§é—®é¢˜)
- **é˜¶æ®µäºŒ** (åŠŸèƒ½å¢å¼º): Edgeâ†’NASä¼ è¾“ä¼˜åŒ– (è§£å†³ğŸŸ¡ğŸŸ¢é—®é¢˜)
- **é˜¶æ®µä¸‰** (ç³»ç»Ÿå®Œå–„): ç›‘æ§å‘Šè­¦å’Œè¿ç»´å·¥å…·

## é˜¶æ®µä¸€ï¼šDockâ†’Edgeä¼ è¾“å¯é æ€§ä¼˜åŒ– (æ ¸å¿ƒé˜¶æ®µ)

### 1.1 é˜¶æ®µç›®æ ‡

**ä¸»è¦ç›®æ ‡**: è§£å†³å¤§æ–‡ä»¶ä¼ è¾“çš„æ ¸å¿ƒå¯é æ€§é—®é¢˜

| ç›®æ ‡ | å½“å‰çŠ¶æ€ | ç›®æ ‡çŠ¶æ€ | æˆåŠŸæŒ‡æ ‡ |
|------|----------|----------|----------|
| å†…å­˜ä½¿ç”¨æ§åˆ¶ | æ–‡ä»¶å¤§å°çº§åˆ« | å›ºå®šâ‰¤100MB | 500MBæ–‡ä»¶å†…å­˜å³°å€¼<100MB |
| ä¼ è¾“æˆåŠŸç‡ | <70% (å¤§æ–‡ä»¶) | â‰¥95% | è¿ç»­100ä¸ªå¤§æ–‡ä»¶æµ‹è¯• |
| ä¸­æ–­æ¢å¤èƒ½åŠ› | æ—  | 30ç§’å†…æ¢å¤ | ç½‘ç»œä¸­æ–­åè‡ªåŠ¨ç»­ä¼  |
| å®Œæ•´æ€§éªŒè¯ | ä»…æ–‡ä»¶å¤§å° | MD5åˆ†å—æ ¡éªŒ | 100%æ•°æ®å®Œæ•´æ€§ |

**æŠ€æœ¯å®æ–½èŒƒå›´**:
- âœ… ä¿®æ”¹ `dock_info_manager.cc` æ ¸å¿ƒä¼ è¾“é€»è¾‘
- âœ… å®ç°åˆ†å—ä¼ è¾“ç®¡ç†å™¨ (`ChunkedTransferManager`)
- âœ… å»ºç«‹ä¼ è¾“çŠ¶æ€æ•°æ®åº“ (`dock_transfer_status.db`)
- âœ… é›†æˆç³»ç»Ÿæ¢å¤æœºåˆ¶ (`SystemRecoveryManager`)
- âœ… éµå¾ªå¤§ç–†å®˜æ–¹1MBåˆ†å—å»ºè®®

### 1.2 æ ¸å¿ƒæŠ€æœ¯æ–¹æ¡ˆ

#### 1.2.1 å…³é”®æŠ€æœ¯å†³ç­–

**ğŸ¯ åˆ†å—å¤§å°å†³ç­–**: ä¸¥æ ¼éµå¾ªå¤§ç–†å®˜æ–¹å»ºè®®
- **é€‰æ‹©**: 1MBåˆ†å— (1024 * 1024 bytes)
- **åŸå› **: å¤§ç–†å®˜æ–¹SDKä¼˜åŒ–ã€åè®®å…¼å®¹æ€§ã€ç¨³å®šæ€§ä¿è¯
- **æ›¿ä»£æ–¹æ¡ˆ**: æ›¾è€ƒè™‘4MBåˆ†å—ï¼Œä½†ä¸ºé¿å…å…¼å®¹æ€§é£é™©ï¼Œé‡‡ç”¨å®˜æ–¹å»ºè®®

**ğŸ”„ ä¼ è¾“ç­–ç•¥è®¾è®¡**:
```cpp
class ChunkedTransferManager {
private:
    static const size_t CHUNK_SIZE = 1024 * 1024; // ä¸¥æ ¼éµå¾ªå¤§ç–†1MBå»ºè®®
    static const int MAX_RETRIES = 3;              // æŒ‡æ•°é€€é¿é‡è¯•
    static const int TIMEOUT_SECONDS = 30;         // é˜²æ­¢åƒµå°¸è¿æ¥
    static const int MAX_CONCURRENT = 3;           // é¿å…èµ„æºç«äº‰
    
public:
    struct TransferProgress {
        size_t total_size;          // æ–‡ä»¶æ€»å¤§å°
        size_t downloaded_size;     // å·²ä¸‹è½½å¤§å°
        int chunks_completed;       // å®Œæˆåˆ†å—æ•°
        int chunks_total;          // æ€»åˆ†å—æ•°
        std::string status;        // ä¼ è¾“çŠ¶æ€
        double speed_mbps;         // ä¼ è¾“é€Ÿåº¦
        std::string last_error;    // æœ€åé”™è¯¯ä¿¡æ¯
    };
    
    // æ ¸å¿ƒæ¥å£
    ErrorCode StartTransfer(const MediaFile& file);
    ErrorCode ResumeTransfer(const std::string& file_path);
    TransferProgress GetProgress(const std::string& file_path);
};
```

#### 1.2.2 å®Œæ•´æ€§éªŒè¯ç­–ç•¥

**âš ï¸ é‡è¦å‘ç°**: DJI SDKä¸æä¾›æ–‡ä»¶å“ˆå¸Œå€¼ï¼Œéœ€è¦è‡ªè¡Œå®ç°å®Œæ•´æ€§éªŒè¯

**å¤šå±‚éªŒè¯æœºåˆ¶**:
1. **åˆ†å—MD5æ ¡éªŒ**: æ¯ä¸ª1MBåˆ†å—è®¡ç®—MD5ï¼Œæ£€æµ‹ä¼ è¾“é”™è¯¯
2. **æ–‡ä»¶å¤§å°éªŒè¯**: å¯¹æ¯”SDKæä¾›çš„file_sizeä¸å®é™…ä¸‹è½½å¤§å°
3. **åˆ†å—å®Œæ•´æ€§æ£€æŸ¥**: ç¡®ä¿æ‰€æœ‰åˆ†å—éƒ½æˆåŠŸä¸‹è½½å¹¶éªŒè¯

```cpp
class FileIntegrityValidator {
public:
    bool ValidateChunk(const std::vector<uint8_t>& chunk_data, 
                      const std::string& expected_md5);
    bool ValidateCompleteFile(const std::string& file_path, 
                             size_t expected_size);
    std::string CalculateChunkMD5(const std::vector<uint8_t>& data);
};
```

### 1.3 çŠ¶æ€ç®¡ç†ä¸æ¢å¤æœºåˆ¶

#### 1.3.1 æ•°æ®åº“è®¾è®¡ (`dock_transfer_status.db`)

**æ ¸å¿ƒè®¾è®¡åŸåˆ™**: æ”¯æŒæ–­ç‚¹ç»­ä¼ ã€æ•…éšœæ¢å¤ã€è¿›åº¦è·Ÿè¸ª

```sql
-- ä¼ è¾“ä»»åŠ¡ä¸»è¡¨
CREATE TABLE transfer_tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    file_path TEXT UNIQUE NOT NULL,        -- DJI SDKæ–‡ä»¶è·¯å¾„æ ‡è¯†
    file_name TEXT NOT NULL,               -- æ–‡ä»¶å
    file_size INTEGER NOT NULL,            -- æ–‡ä»¶æ€»å¤§å°
    total_chunks INTEGER NOT NULL,         -- æ€»åˆ†å—æ•°
    completed_chunks INTEGER DEFAULT 0,    -- å·²å®Œæˆåˆ†å—æ•°
    status TEXT DEFAULT 'pending',         -- pending/downloading/paused/completed/failed
    error_message TEXT,                    -- é”™è¯¯ä¿¡æ¯
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    started_at TIMESTAMP,                  -- å¼€å§‹ä¸‹è½½æ—¶é—´
    completed_at TIMESTAMP,               -- å®Œæˆæ—¶é—´
    last_heartbeat TIMESTAMP,             -- æœ€åå¿ƒè·³æ—¶é—´
    recovery_count INTEGER DEFAULT 0      -- æ¢å¤æ¬¡æ•°
);

-- åˆ†å—çŠ¶æ€è¯¦è¡¨
CREATE TABLE chunk_status (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id INTEGER REFERENCES transfer_tasks(id),
    chunk_index INTEGER NOT NULL,         -- åˆ†å—ç´¢å¼•(0å¼€å§‹)
    chunk_size INTEGER NOT NULL,          -- åˆ†å—å¤§å°(é€šå¸¸1MB)
    status TEXT DEFAULT 'pending',        -- pending/downloading/completed/failed
    retry_count INTEGER DEFAULT 0,        -- é‡è¯•æ¬¡æ•°
    checksum TEXT,                        -- MD5æ ¡éªŒå’Œ
    downloaded_at TIMESTAMP,              -- ä¸‹è½½å®Œæˆæ—¶é—´
    UNIQUE(task_id, chunk_index)
);

-- åˆ›å»ºç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_transfer_status ON transfer_tasks(status);
CREATE INDEX idx_chunk_task ON chunk_status(task_id, status);
```

#### 1.3.2 çŠ¶æ€è½¬æ¢æµç¨‹

```mermaid
stateDiagram-v2
    [*] --> pending: æ–‡ä»¶å‘ç°
    pending --> downloading: å¼€å§‹ä¼ è¾“
    downloading --> paused: ç½‘ç»œä¸­æ–­
    downloading --> completed: å…¨éƒ¨å®Œæˆ
    downloading --> failed: é‡è¯•è¶…é™
    paused --> downloading: æ¢å¤ä¼ è¾“
    failed --> downloading: æ‰‹åŠ¨é‡è¯•
    completed --> [*]: æ¸…ç†å®Œæˆ
```

**å…³é”®çŠ¶æ€ç®¡ç†é€»è¾‘**:
1. **ä»»åŠ¡åˆ›å»º**: `OnMediaFileUpdate` â†’ æ’å…¥transfer_tasks â†’ è®¡ç®—åˆ†å— â†’ åˆ›å»ºchunk_status
2. **ä¼ è¾“æ‰§è¡Œ**: é€å—ä¸‹è½½ â†’ æ›´æ–°chunk_status â†’ æ›´æ–°completed_chunks
3. **å¿ƒè·³æ›´æ–°**: æ¯10ç§’æ›´æ–°last_heartbeatï¼Œç”¨äºæ£€æµ‹åƒµå°¸ä»»åŠ¡
4. **æ¢å¤å¤„ç†**: ç³»ç»Ÿå¯åŠ¨æ—¶æ‰«æincompleteä»»åŠ¡ â†’ éªŒè¯å·²ä¸‹è½½åˆ†å— â†’ ç»§ç»­ä¼ è¾“

### 1.4 ç³»ç»Ÿä¸­æ–­æ¢å¤æœºåˆ¶

#### 1.4.1 æ¢å¤åœºæ™¯åˆ†æ

| ä¸­æ–­ç±»å‹ | æ£€æµ‹æ–¹å¼ | æ¢å¤ç­–ç•¥ | é¢„æœŸæ—¶é—´ |
|---------|---------|---------|----------|
| **è¿›ç¨‹é‡å¯** | å¯åŠ¨æ—¶æ‰«æpending/downloadingçŠ¶æ€ä»»åŠ¡ | éªŒè¯å·²ä¸‹è½½åˆ†å— â†’ ç»§ç»­ä¼ è¾“ | < 30ç§’ |
| **ç½‘ç»œä¸­æ–­** | ä¸‹è½½è¶…æ—¶ + å¿ƒè·³æ£€æµ‹ | æŒ‡æ•°é€€é¿é‡è¯• â†’ æ ‡è®°paused | < 5åˆ†é’Ÿ |
| **å­˜å‚¨å¼‚å¸¸** | ç£ç›˜ç©ºé—´/IOé”™è¯¯ | æ¸…ç†ç©ºé—´ â†’ é‡æ–°ä¸‹è½½æŸååˆ†å— | < 2åˆ†é’Ÿ |
| **Dockæ–­è¿** | SDKè¿æ¥çŠ¶æ€ç›‘æ§ | ç­‰å¾…é‡è¿ â†’ æ¢å¤ä¼ è¾“é˜Ÿåˆ— | å–å†³äºDock |

#### 1.4.2 æ¢å¤ç®¡ç†å™¨å®ç°

```cpp
class SystemRecoveryManager {
public:
    // ç³»ç»Ÿå¯åŠ¨æ—¶çš„æ¢å¤æ£€æŸ¥
    bool RecoverOnStartup() {
        auto incomplete_tasks = DetectIncompleteTransfers();
        for (const auto& task : incomplete_tasks) {
            if (ValidateDownloadedChunks(task)) {
                ResumeTransfer(task);
            } else {
                CleanupCorruptedTransfers(task.id);
            }
        }
        return true;
    }
    
    // æ£€æµ‹æœªå®Œæˆçš„ä¼ è¾“ä»»åŠ¡
    std::vector<TransferTask> DetectIncompleteTransfers() {
        return status_db_->Query(
            "SELECT * FROM transfer_tasks WHERE status IN ('pending', 'downloading', 'paused')"
        );
    }
    
    // éªŒè¯å·²ä¸‹è½½åˆ†å—çš„å®Œæ•´æ€§
    bool ValidateDownloadedChunks(const TransferTask& task) {
        auto completed_chunks = status_db_->GetCompletedChunks(task.id);
        for (const auto& chunk : completed_chunks) {
            if (!validator_->ValidateChunkChecksum(chunk)) {
                // æ ‡è®°åˆ†å—ä¸ºå¾…é‡æ–°ä¸‹è½½
                status_db_->UpdateChunkStatus(chunk.id, "pending");
            }
        }
        return true;
    }
    
    // æ¢å¤ä¼ è¾“ä»»åŠ¡
    bool ResumeTransfer(const TransferTask& task) {
        status_db_->UpdateTaskStatus(task.id, "downloading");
        return transfer_manager_->ResumeTask(task);
    }
    
private:
    std::unique_ptr<TransferStatusDB> status_db_;
    std::unique_ptr<ChunkedTransferManager> transfer_manager_;
    std::unique_ptr<FileIntegrityValidator> validator_;
};
```

#### 1.4.3 æ™ºèƒ½ç›‘æ§ä¸è‡ªæ„ˆæœºåˆ¶

**å¿ƒè·³ç›‘æ§ç³»ç»Ÿ**:
```cpp
class TransferHeartbeatMonitor {
public:
    void StartMonitoring() {
        monitor_thread_ = std::thread([this]() {
            while (running_) {
                CheckStaleTransfers();
                std::this_thread::sleep_for(std::chrono::seconds(30));
            }
        });
    }
    
private:
    void CheckStaleTransfers() {
        auto stale_tasks = status_db_->Query(
            "SELECT id FROM transfer_tasks WHERE status='downloading' "
            "AND last_heartbeat < datetime('now', '-60 seconds')"
        );
        
        for (const auto& task : stale_tasks) {
            recovery_manager_->ResumeTransfer(task);
        }
    }
    
    std::thread monitor_thread_;
    bool running_ = true;
};
```

**å¤±è´¥å¤„ç†ç­–ç•¥**:
- **åˆ†å—çº§é‡è¯•**: å•åˆ†å—æœ€å¤šé‡è¯•3æ¬¡ï¼ŒæŒ‡æ•°é€€é¿ (1s â†’ 2s â†’ 4s)
- **ä»»åŠ¡çº§é™çº§**: è¿ç»­å¤±è´¥è¶…è¿‡5æ¬¡çš„ä»»åŠ¡æ ‡è®°ä¸ºfailedï¼Œéœ€æ‰‹åŠ¨å¹²é¢„
- **ç³»ç»Ÿçº§ä¿æŠ¤**: å…¨å±€å¤±è´¥ç‡è¶…è¿‡30%æ—¶æš‚åœæ–°ä»»åŠ¡ï¼Œå‘é€å‘Šè­¦

```cpp
class ChunkFailureHandler {
public:
    enum class FailureAction { RETRY, SKIP, ABORT_TASK };
    
    FailureAction HandleChunkFailure(const ChunkStatus& chunk, 
                                   const std::string& error_msg) {
        if (chunk.retry_count < MAX_CHUNK_RETRIES) {
            int delay_seconds = std::pow(2, chunk.retry_count);  // æŒ‡æ•°é€€é¿
            ScheduleChunkRetry(chunk, delay_seconds);
            return FailureAction::RETRY;
        }
        
        // è®°å½•å¤±è´¥ç»Ÿè®¡
        failure_stats_->RecordChunkFailure(chunk.task_id, error_msg);
        
        return IsChunkCritical(chunk) ? FailureAction::ABORT_TASK : FailureAction::SKIP;
    }
    
private:
    static const int MAX_CHUNK_RETRIES = 3;
    std::unique_ptr<FailureStatistics> failure_stats_;
};
```

### 1.5 ç³»ç»Ÿé›†æˆæ–¹æ¡ˆ

#### 1.5.1 ä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆç‚¹

**é›†æˆæ¶æ„å›¾**:
```
ç°æœ‰ç³»ç»Ÿ                    æ–°å¢ç»„ä»¶
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DockInfoManager â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ ChunkedTransferManager â”‚
â”‚                 â”‚         â”‚                      â”‚
â”‚ OnMediaFileUpdateâ”‚         â”‚ - åˆ†å—ä¼ è¾“é€»è¾‘        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ - çŠ¶æ€ç®¡ç†           â”‚
                            â”‚ - æ¢å¤æœºåˆ¶           â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ TransferStatusDB     â”‚
                            â”‚ (SQLite)            â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.5.2 ä»£ç é›†æˆå®ç°

**dock_info_manager.cc å…³é”®ä¿®æ”¹**:
```cpp
class DockInfoManager {
public:
    // æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–åˆ†å—ä¼ è¾“ç®¡ç†å™¨
    DockInfoManager() {
        // åŠ è½½é…ç½®
        auto config = ConfigManager::LoadTransferConfig();
        
        // åˆå§‹åŒ–åˆ†å—ä¼ è¾“ç®¡ç†å™¨
        chunked_transfer_manager_ = std::make_unique<ChunkedTransferManager>(config);
        
        // åˆå§‹åŒ–æ¢å¤ç®¡ç†å™¨
        recovery_manager_ = std::make_unique<TransferRecoveryManager>();
        recovery_manager_->InitializeRecovery();
    }
    
    // åª’ä½“æ–‡ä»¶æ›´æ–°å›è°ƒçš„å¢å¼ºå®ç°
    void OnMediaFileUpdate(const MediaFileInfo& file_info) override {
        LogInfo("æ”¶åˆ°åª’ä½“æ–‡ä»¶: %s (%.2f MB)", 
                file_info.file_name.c_str(), 
                file_info.file_size / (1024.0 * 1024.0));
        
        // ğŸ”¥ æ ¸å¿ƒå†³ç­–: æ‰€æœ‰æ–‡ä»¶éƒ½ä½¿ç”¨åˆ†å—ä¼ è¾“ (éµå¾ªå¤§ç–†1MBåˆ†å—å»ºè®®)
        auto transfer_task = chunked_transfer_manager_->CreateTransferTask(file_info);
        
        // å¼‚æ­¥å¯åŠ¨ä¼ è¾“ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
        std::thread([this, transfer_task]() {
            chunked_transfer_manager_->StartTransfer(transfer_task);
        }).detach();
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        transfer_stats_.total_files++;
        transfer_stats_.total_bytes += file_info.file_size;
    }
    
private:
    std::unique_ptr<ChunkedTransferManager> chunked_transfer_manager_;
    std::unique_ptr<TransferRecoveryManager> recovery_manager_;
    TransferStatistics transfer_stats_;
};
```

#### 1.5.3 é…ç½®ç®¡ç†æ‰©å±•

**unified_config.json é…ç½®é¡¹**:
```json
{
  "dock_transfer_config": {
    "chunk_size_bytes": 1048576,           // 1MB (ä¸¥æ ¼éµå¾ªå¤§ç–†å»ºè®®)
    "max_concurrent_chunks": 3,            // æœ€å¤§å¹¶å‘åˆ†å—æ•°
    "max_retry_attempts": 3,               // åˆ†å—é‡è¯•æ¬¡æ•°
    "heartbeat_interval_ms": 10000,        // å¿ƒè·³é—´éš” 10ç§’
    "stale_task_timeout_ms": 60000,        // åƒµå°¸ä»»åŠ¡è¶…æ—¶ 60ç§’
    "enable_integrity_validation": true,    // å¯ç”¨å®Œæ•´æ€§æ ¡éªŒ
    "temp_download_path": "./celestial_works/temp_downloads",
    "final_download_path": "./celestial_works/media",
    "database_path": "./celestial_works/dock_transfer_status.db",
    "log_level": "INFO",                   // DEBUG/INFO/WARN/ERROR
    "enable_performance_metrics": true     // æ€§èƒ½æŒ‡æ ‡æ”¶é›†
  }
}
```

**é…ç½®åŠ è½½å™¨å®ç°**:
```cpp
class TransferConfigManager {
public:
    static TransferConfig LoadFromUnifiedConfig() {
        auto json_config = ConfigManager::LoadUnifiedConfig();
        auto transfer_section = json_config["dock_transfer_config"];
        
        TransferConfig config;
        config.chunk_size = transfer_section["chunk_size_bytes"].get<size_t>();
        config.max_concurrent = transfer_section["max_concurrent_chunks"].get<int>();
        config.max_retries = transfer_section["max_retry_attempts"].get<int>();
        // ... å…¶ä»–é…ç½®é¡¹
        
        return config;
    }
};
```

#### 1.5.4 ç³»ç»Ÿå¯åŠ¨æµç¨‹é›†æˆ

**ä¸»ç¨‹åºå¯åŠ¨æ—¶çš„åˆå§‹åŒ–åºåˆ—**:
```cpp
int main() {
    try {
        // 1. åŠ è½½ç»Ÿä¸€é…ç½®
        auto config = ConfigManager::LoadUnifiedConfig();
        
        // 2. åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
        LogManager::Initialize(config["dock_transfer_config"]["log_level"]);
        
        // 3. åˆå§‹åŒ–æ•°æ®åº“
        auto db_path = config["dock_transfer_config"]["database_path"];
        TransferStatusDB::Initialize(db_path);
        
        // 4. å¯åŠ¨æ¢å¤ç®¡ç†å™¨
        TransferRecoveryManager recovery_manager;
        recovery_manager.RecoverOnStartup();
        
        // 5. åˆå§‹åŒ–DockInfoManager
        DockInfoManager dock_manager(config);
        
        // 6. å¯åŠ¨ç›‘æ§çº¿ç¨‹
        std::thread monitor_thread([&dock_manager]() {
            dock_manager.StartMonitoring();
        });
        
        // 7. å¯åŠ¨ä¸»äº‹ä»¶å¾ªç¯
        dock_manager.Run();
        
    } catch (const std::exception& e) {
        ERROR("ç³»ç»Ÿå¯åŠ¨å¤±è´¥: %s", e.what());
        return -1;
    }
    
    return 0;
}
```

#### 1.5.5 é”™è¯¯å¤„ç†ä¸æ—¥å¿—é›†æˆ

**ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶**:
```cpp
class TransferErrorHandler {
public:
    enum class ErrorLevel { INFO, WARNING, ERROR, CRITICAL };
    
    static void HandleTransferError(const std::string& file_path, 
                                  const std::string& error_msg, 
                                  ErrorLevel level) {
        // è®°å½•åˆ°æ—¥å¿—
        switch (level) {
            case ErrorLevel::INFO:
                INFO("ä¼ è¾“ä¿¡æ¯ [%s]: %s", file_path.c_str(), error_msg.c_str());
                break;
            case ErrorLevel::WARNING:
                WARN("ä¼ è¾“è­¦å‘Š [%s]: %s", file_path.c_str(), error_msg.c_str());
                break;
            case ErrorLevel::ERROR:
                ERROR("ä¼ è¾“é”™è¯¯ [%s]: %s", file_path.c_str(), error_msg.c_str());
                break;
            case ErrorLevel::CRITICAL:
                ERROR("ä¼ è¾“ä¸¥é‡é”™è¯¯ [%s]: %s", file_path.c_str(), error_msg.c_str());
                // å‘é€å‘Šè­¦é€šçŸ¥
                AlertManager::SendAlert("ä¼ è¾“ç³»ç»Ÿä¸¥é‡é”™è¯¯", error_msg);
                break;
        }
        
        // è®°å½•åˆ°æ•°æ®åº“
        TransferStatusDB::RecordError(file_path, error_msg, level);
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        TransferStatistics::IncrementErrorCount(level);
    }
};
```

#### 1.5.6 æ€§èƒ½ç›‘æ§é›†æˆ

**å®æ—¶æ€§èƒ½æŒ‡æ ‡æ”¶é›†**:
```cpp
class TransferPerformanceMonitor {
public:
    struct PerformanceMetrics {
        double average_transfer_speed_mbps;     // å¹³å‡ä¼ è¾“é€Ÿåº¦
        double current_transfer_speed_mbps;     // å½“å‰ä¼ è¾“é€Ÿåº¦
        size_t active_transfers_count;          // æ´»è·ƒä¼ è¾“æ•°é‡
        size_t queued_transfers_count;          // é˜Ÿåˆ—ä¸­ä¼ è¾“æ•°é‡
        double success_rate_percentage;         // æˆåŠŸç‡ç™¾åˆ†æ¯”
        size_t total_bytes_transferred;         // æ€»ä¼ è¾“å­—èŠ‚æ•°
        double memory_usage_mb;                 // å†…å­˜ä½¿ç”¨é‡
        double cpu_usage_percentage;            // CPUä½¿ç”¨ç‡
    };
    
    PerformanceMetrics CollectMetrics() {
        PerformanceMetrics metrics;
        
        // æ”¶é›†ä¼ è¾“é€Ÿåº¦ç»Ÿè®¡
        metrics.average_transfer_speed_mbps = CalculateAverageSpeed();
        metrics.current_transfer_speed_mbps = CalculateCurrentSpeed();
        
        // æ”¶é›†é˜Ÿåˆ—ç»Ÿè®¡
        metrics.active_transfers_count = GetActiveTransfersCount();
        metrics.queued_transfers_count = GetQueuedTransfersCount();
        
        // æ”¶é›†æˆåŠŸç‡ç»Ÿè®¡
        metrics.success_rate_percentage = CalculateSuccessRate();
        
        // æ”¶é›†ç³»ç»Ÿèµ„æºä½¿ç”¨
        metrics.memory_usage_mb = GetMemoryUsage() / (1024.0 * 1024.0);
        metrics.cpu_usage_percentage = GetCpuUsage();
        
        return metrics;
    }
    
    void LogPerformanceReport() {
        auto metrics = CollectMetrics();
        
        INFO("=== ä¼ è¾“æ€§èƒ½æŠ¥å‘Š ===");
        INFO("å¹³å‡ä¼ è¾“é€Ÿåº¦: %.2f MB/s", metrics.average_transfer_speed_mbps);
        INFO("å½“å‰ä¼ è¾“é€Ÿåº¦: %.2f MB/s", metrics.current_transfer_speed_mbps);
        INFO("æ´»è·ƒä¼ è¾“: %zu, é˜Ÿåˆ—ä¼ è¾“: %zu", 
             metrics.active_transfers_count, metrics.queued_transfers_count);
        INFO("ä¼ è¾“æˆåŠŸç‡: %.2f%%", metrics.success_rate_percentage);
        INFO("å†…å­˜ä½¿ç”¨: %.2f MB, CPUä½¿ç”¨: %.2f%%", 
             metrics.memory_usage_mb, metrics.cpu_usage_percentage);
        INFO("æ€»ä¼ è¾“æ•°æ®: %.2f GB", 
             metrics.total_bytes_transferred / (1024.0 * 1024.0 * 1024.0));
    }
};
```

#### 1.5.7 å‘åå…¼å®¹æ€§ä¿è¯

**æ¸è¿›å¼è¿ç§»ç­–ç•¥**:
```cpp
class BackwardCompatibilityManager {
public:
    // æ£€æŸ¥æ˜¯å¦å¯ç”¨æ–°çš„åˆ†å—ä¼ è¾“ç³»ç»Ÿ
    bool IsChunkedTransferEnabled() {
        auto config = ConfigManager::LoadUnifiedConfig();
        return config["dock_transfer_config"].get("enable_chunked_transfer", true);
    }
    
    // å…¼å®¹æ€§æ–‡ä»¶å¤„ç†
    void HandleMediaFileUpdate(const MediaFile& file) {
        if (IsChunkedTransferEnabled()) {
            // ä½¿ç”¨æ–°çš„åˆ†å—ä¼ è¾“ç³»ç»Ÿ
            chunked_transfer_manager_->StartTransfer(file);
        } else {
            // å›é€€åˆ°åŸæœ‰çš„ä¼ è¾“æ–¹å¼
            LegacyFileDownloader::DownloadFile(file);
        }
    }
    
    // æ•°æ®åº“è¿ç§»
    bool MigrateExistingData() {
        try {
            // æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ—§çš„æ•°æ®åº“ç»“æ„
            if (HasLegacyDatabase()) {
                INFO("æ£€æµ‹åˆ°æ—§æ•°æ®åº“ï¼Œå¼€å§‹è¿ç§»...");
                
                // è¿ç§»ç°æœ‰çš„åª’ä½“æ–‡ä»¶è®°å½•
                auto legacy_files = LoadLegacyMediaFiles();
                for (const auto& file : legacy_files) {
                    TransferStatusDB::MigrateLegacyFile(file);
                }
                
                INFO("æ•°æ®åº“è¿ç§»å®Œæˆï¼Œè¿ç§»äº† %zu ä¸ªæ–‡ä»¶è®°å½•", legacy_files.size());
            }
            
            return true;
        } catch (const std::exception& e) {
            ERROR("æ•°æ®åº“è¿ç§»å¤±è´¥: %s", e.what());
            return false;
        }
    }
    
private:
    std::unique_ptr<ChunkedTransferManager> chunked_transfer_manager_;
};
```

**é…ç½®æ–‡ä»¶å‘åå…¼å®¹**:
```json
{
  "dock_transfer_config": {
    "enable_chunked_transfer": true,        // å¯ä»¥è®¾ä¸ºfalseå›é€€åˆ°æ—§ç³»ç»Ÿ
    "migration": {
      "auto_migrate_on_startup": true,      // å¯åŠ¨æ—¶è‡ªåŠ¨è¿ç§»
      "backup_legacy_db": true,             // è¿ç§»å‰å¤‡ä»½æ—§æ•°æ®åº“
      "migration_timeout_seconds": 300      // è¿ç§»è¶…æ—¶æ—¶é—´
    },
    "fallback": {
      "enable_legacy_mode": false,          // ç´§æ€¥æƒ…å†µä¸‹çš„å›é€€æ¨¡å¼
      "legacy_chunk_size_kb": 1024,         // æ—§ç³»ç»Ÿçš„å—å¤§å°
      "legacy_max_retries": 5               // æ—§ç³»ç»Ÿçš„é‡è¯•æ¬¡æ•°
    }
  }
}
```

**éƒ¨ç½²éªŒè¯æ¸…å•**:
```cpp
class DeploymentValidator {
public:
    struct ValidationResult {
        bool success;
        std::vector<std::string> warnings;
        std::vector<std::string> errors;
    };
    
    ValidationResult ValidateDeployment() {
        ValidationResult result;
        result.success = true;
        
        // 1. é…ç½®æ–‡ä»¶éªŒè¯
        if (!ValidateConfigFile()) {
            result.errors.push_back("é…ç½®æ–‡ä»¶éªŒè¯å¤±è´¥");
            result.success = false;
        }
        
        // 2. æ•°æ®åº“è¿æ¥éªŒè¯
        if (!ValidateDatabaseConnection()) {
            result.errors.push_back("æ•°æ®åº“è¿æ¥å¤±è´¥");
            result.success = false;
        }
        
        // 3. å­˜å‚¨è·¯å¾„éªŒè¯
        if (!ValidateStoragePaths()) {
            result.errors.push_back("å­˜å‚¨è·¯å¾„éªŒè¯å¤±è´¥");
            result.success = false;
        }
        
        // 4. DJI SDKå…¼å®¹æ€§éªŒè¯
        if (!ValidateSDKCompatibility()) {
            result.warnings.push_back("DJI SDKç‰ˆæœ¬å¯èƒ½å­˜åœ¨å…¼å®¹æ€§é—®é¢˜");
        }
        
        // 5. ç³»ç»Ÿèµ„æºéªŒè¯
        if (!ValidateSystemResources()) {
            result.warnings.push_back("ç³»ç»Ÿèµ„æºå¯èƒ½ä¸è¶³ï¼Œå»ºè®®ç›‘æ§æ€§èƒ½");
        }
        
        return result;
    }
    
private:
    bool ValidateConfigFile() {
        try {
            auto config = ConfigManager::LoadUnifiedConfig();
            return config.contains("dock_transfer_config");
        } catch (...) {
            return false;
        }
    }
    
    bool ValidateDatabaseConnection() {
        try {
            return TransferStatusDB::TestConnection();
        } catch (...) {
            return false;
        }
    }
    
    bool ValidateStoragePaths() {
        auto config = ConfigManager::LoadUnifiedConfig();
        auto temp_path = config["dock_transfer_config"]["temp_download_path"];
        auto final_path = config["dock_transfer_config"]["final_download_path"];
        
        return std::filesystem::exists(temp_path) && 
               std::filesystem::exists(final_path);
    }
    
    bool ValidateSDKCompatibility() {
        // æ£€æŸ¥DJI SDKç‰ˆæœ¬å…¼å®¹æ€§
        return true; // å®é™…å®ç°ä¸­éœ€è¦æ£€æŸ¥SDKç‰ˆæœ¬
    }
    
    bool ValidateSystemResources() {
        // æ£€æŸ¥å†…å­˜ã€ç£ç›˜ç©ºé—´ç­‰ç³»ç»Ÿèµ„æº
        return GetAvailableMemory() > 512 * 1024 * 1024; // è‡³å°‘512MBå¯ç”¨å†…å­˜
    }
};
```

**é›†æˆæµ‹è¯•è„šæœ¬**:
```bash
#!/bin/bash
# deploy_and_validate.sh - éƒ¨ç½²éªŒè¯è„šæœ¬

echo "=== å¤§æ–‡ä»¶ä¼ è¾“ç³»ç»Ÿéƒ¨ç½²éªŒè¯ ==="

# 1. ç¼–è¯‘æ–°ç‰ˆæœ¬
echo "[1/6] ç¼–è¯‘ç³»ç»Ÿ..."
make clean && make release
if [ $? -ne 0 ]; then
    echo "âŒ ç¼–è¯‘å¤±è´¥"
    exit 1
fi

# 2. å¤‡ä»½ç°æœ‰é…ç½®
echo "[2/6] å¤‡ä»½ç°æœ‰é…ç½®..."
cp unified_config.json unified_config.json.backup

# 3. éƒ¨ç½²æ–°é…ç½®
echo "[3/6] éƒ¨ç½²æ–°é…ç½®..."
cp unified_config_new.json unified_config.json

# 4. è¿è¡Œéƒ¨ç½²éªŒè¯
echo "[4/6] è¿è¡Œéƒ¨ç½²éªŒè¯..."
./celestial_works --validate-deployment
if [ $? -ne 0 ]; then
    echo "âŒ éƒ¨ç½²éªŒè¯å¤±è´¥ï¼Œå›æ»šé…ç½®"
    cp unified_config.json.backup unified_config.json
    exit 1
fi

# 5. å¯åŠ¨ç³»ç»Ÿæµ‹è¯•
echo "[5/6] å¯åŠ¨ç³»ç»Ÿæµ‹è¯•..."
./run_integration_tests.sh
if [ $? -ne 0 ]; then
    echo "âŒ é›†æˆæµ‹è¯•å¤±è´¥"
    exit 1
fi

# 6. éƒ¨ç½²å®Œæˆ
echo "[6/6] éƒ¨ç½²éªŒè¯å®Œæˆ"
echo "âœ… å¤§æ–‡ä»¶ä¼ è¾“ç³»ç»Ÿå·²æˆåŠŸéƒ¨ç½²å¹¶éªŒè¯"
echo "ğŸ“Š æŸ¥çœ‹æ€§èƒ½æŠ¥å‘Š: tail -f ./logs/transfer_performance.log"
echo "ğŸ” æŸ¥çœ‹ä¼ è¾“çŠ¶æ€: ./celestial_works --status"
```

### 1.6 é˜¶æ®µä¸€æµ‹è¯•è®¡åˆ’

#### 1.6.1 æµ‹è¯•ç­–ç•¥æ¦‚è§ˆ

| æµ‹è¯•ç±»å‹ | æµ‹è¯•èŒƒå›´ | æ‰§è¡Œç¯å¢ƒ | é¢„æœŸæ—¶é—´ | æˆåŠŸæ ‡å‡† |
|---------|---------|---------|----------|----------|
| **å•å…ƒæµ‹è¯•** | æ ¸å¿ƒç»„ä»¶åŠŸèƒ½ | å¼€å‘ç¯å¢ƒ | 2å¤© | ä»£ç è¦†ç›–ç‡>90% |
| **é›†æˆæµ‹è¯•** | ç³»ç»Ÿé—´åä½œ | æµ‹è¯•ç¯å¢ƒ | 3å¤© | æ‰€æœ‰ç”¨ä¾‹é€šè¿‡ |
| **æ€§èƒ½æµ‹è¯•** | ä¼ è¾“æ•ˆç‡ | ç”Ÿäº§ç¯å¢ƒ | 2å¤© | æ»¡è¶³æ€§èƒ½æŒ‡æ ‡ |
| **ç¨³å®šæ€§æµ‹è¯•** | é•¿æœŸè¿è¡Œ | ç”Ÿäº§ç¯å¢ƒ | 7å¤© | æ— å´©æºƒæ— æ³„æ¼ |

#### 1.6.2 å•å…ƒæµ‹è¯•è¯¦ç»†è®¡åˆ’

**A. ChunkedTransferManager æµ‹è¯•å¥—ä»¶**
- **åˆ†å—è®¡ç®—é€»è¾‘æµ‹è¯•**: éªŒè¯1MBåˆ†å—çš„å‡†ç¡®æ€§å’Œè¾¹ç•Œå¤„ç†
- **å¹¶å‘æ§åˆ¶æµ‹è¯•**: éªŒè¯æœ€å¤§3ä¸ªå¹¶å‘åˆ†å—çš„é™åˆ¶æœºåˆ¶
- **é”™è¯¯å¤„ç†æµ‹è¯•**: æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯ã€æ–‡ä»¶ä¸å­˜åœ¨ç­‰å¼‚å¸¸åœºæ™¯
- **çŠ¶æ€è½¬æ¢æµ‹è¯•**: éªŒè¯pendingâ†’downloadingâ†’completedçŠ¶æ€æµè½¬

**B. TransferStatusDB æµ‹è¯•å¥—ä»¶**
- **CRUDæ“ä½œæµ‹è¯•**: éªŒè¯ä»»åŠ¡å’Œåˆ†å—çŠ¶æ€çš„æ•°æ®åº“æ“ä½œ
- **å¹¶å‘è®¿é—®æµ‹è¯•**: å¤šçº¿ç¨‹åŒæ—¶è¯»å†™æ•°æ®åº“çš„å®‰å…¨æ€§
- **æ•°æ®ä¸€è‡´æ€§æµ‹è¯•**: éªŒè¯äº‹åŠ¡å¤„ç†å’Œæ•°æ®å®Œæ•´æ€§
- **ç´¢å¼•æ€§èƒ½æµ‹è¯•**: éªŒè¯æŸ¥è¯¢ä¼˜åŒ–å’Œå“åº”æ—¶é—´

**C. FileIntegrityValidator æµ‹è¯•å¥—ä»¶**
- **MD5æ ¡éªŒæµ‹è¯•**: éªŒè¯åˆ†å—å’Œæ•´æ–‡ä»¶çš„æ ¡éªŒç®—æ³•
- **æŸåæ£€æµ‹æµ‹è¯•**: æ¨¡æ‹Ÿæ–‡ä»¶æŸååœºæ™¯çš„æ£€æµ‹èƒ½åŠ›
- **æ€§èƒ½åŸºå‡†æµ‹è¯•**: æ ¡éªŒç®—æ³•çš„æ€§èƒ½å¼€é”€è¯„ä¼°

**D. TransferRecoveryManager æµ‹è¯•å¥—ä»¶**
- **å¯åŠ¨æ¢å¤æµ‹è¯•**: ç³»ç»Ÿé‡å¯åçš„ä»»åŠ¡æ¢å¤èƒ½åŠ›
- **ä¸­æ–­æ£€æµ‹æµ‹è¯•**: åƒµå°¸ä»»åŠ¡çš„è¯†åˆ«å’Œå¤„ç†
- **æ•°æ®ä¿®å¤æµ‹è¯•**: æŸååˆ†å—çš„é‡æ–°ä¸‹è½½æœºåˆ¶

#### 1.6.3 é›†æˆæµ‹è¯•è¯¦ç»†è®¡åˆ’

**A. ç«¯åˆ°ç«¯ä¼ è¾“æµ‹è¯•**
- **å®Œæ•´æµç¨‹æµ‹è¯•**: OnMediaFileUpdate â†’ åˆ†å—ä¼ è¾“ â†’ æ–‡ä»¶åˆå¹¶ â†’ æ ¡éªŒå®Œæˆ
- **å¤šæ–‡ä»¶å¹¶å‘æµ‹è¯•**: åŒæ—¶å¤„ç†5-10ä¸ªä¸åŒå¤§å°çš„åª’ä½“æ–‡ä»¶
- **å¤§æ–‡ä»¶ä¸“é¡¹æµ‹è¯•**: æµ‹è¯•100MB+ã€500MB+ã€1GB+æ–‡ä»¶çš„ä¼ è¾“ç¨³å®šæ€§

**B. ä¸­æ–­æ¢å¤é›†æˆæµ‹è¯•**
- **ç½‘ç»œä¸­æ–­æ¨¡æ‹Ÿ**: åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ–­å¼€ç½‘ç»œè¿æ¥ï¼ŒéªŒè¯æ¢å¤æœºåˆ¶
- **è¿›ç¨‹é‡å¯æµ‹è¯•**: å¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹åé‡å¯ï¼ŒéªŒè¯æ–­ç‚¹ç»­ä¼ 
- **å­˜å‚¨å¼‚å¸¸æµ‹è¯•**: æ¨¡æ‹Ÿç£ç›˜æ»¡ã€æƒé™é”™è¯¯ç­‰å­˜å‚¨é—®é¢˜
- **Dockæ–­è¿æµ‹è¯•**: æ¨¡æ‹ŸDockè®¾å¤‡æ–­å¼€è¿æ¥çš„æ¢å¤å¤„ç†

**C. è¾¹ç•Œæ¡ä»¶æµ‹è¯•**
- **æå°æ–‡ä»¶æµ‹è¯•**: <1MBæ–‡ä»¶çš„å¤„ç†æ•ˆç‡
- **æå¤§æ–‡ä»¶æµ‹è¯•**: >1GBæ–‡ä»¶çš„å†…å­˜æ§åˆ¶å’Œç¨³å®šæ€§
- **ç½‘ç»œè´¨é‡æµ‹è¯•**: é«˜å»¶è¿Ÿã€ä¸¢åŒ…ç¯å¢ƒä¸‹çš„ä¼ è¾“è¡¨ç°
- **å¹¶å‘æé™æµ‹è¯•**: è¶…è¿‡è®¾è®¡å¹¶å‘æ•°çš„å¤„ç†èƒ½åŠ›

#### 1.6.4 æ€§èƒ½æµ‹è¯•è¯¦ç»†è®¡åˆ’

**A. ä¼ è¾“é€Ÿåº¦åŸºå‡†æµ‹è¯•**
```bash
# æ€§èƒ½æµ‹è¯•è„šæœ¬ç¤ºä¾‹
#!/bin/bash
echo "=== ä¼ è¾“é€Ÿåº¦åŸºå‡†æµ‹è¯• ==="

# æµ‹è¯•ä¸åŒæ–‡ä»¶å¤§å°çš„ä¼ è¾“æ€§èƒ½
for size in 1 5 10 50 100 500; do
    echo "æµ‹è¯• ${size}MB æ–‡ä»¶ä¼ è¾“æ€§èƒ½..."
    
    # åˆ›å»ºæµ‹è¯•æ–‡ä»¶
    dd if=/dev/urandom of=test_${size}mb.dat bs=1M count=$size
    
    # è®°å½•ä¼ è¾“æ—¶é—´
    start_time=$(date +%s.%N)
    ./celestial_works --test-transfer test_${size}mb.dat
    end_time=$(date +%s.%N)
    
    # è®¡ç®—ä¼ è¾“é€Ÿåº¦
    duration=$(echo "$end_time - $start_time" | bc)
    speed=$(echo "scale=2; $size / $duration" | bc)
    
    echo "${size}MB æ–‡ä»¶ä¼ è¾“é€Ÿåº¦: ${speed} MB/s"
    
    # æ¸…ç†æµ‹è¯•æ–‡ä»¶
    rm -f test_${size}mb.dat
done
```

**B. èµ„æºä½¿ç”¨ç›‘æ§æµ‹è¯•**
- **å†…å­˜ä½¿ç”¨ç›‘æ§**: é•¿æœŸè¿è¡Œè¿‡ç¨‹ä¸­çš„å†…å­˜ä½¿ç”¨è¶‹åŠ¿
- **CPUä½¿ç”¨ç‡åˆ†æ**: ä¸åŒè´Ÿè½½ä¸‹çš„CPUå ç”¨æƒ…å†µ
- **ç£ç›˜I/Oç›‘æ§**: åˆ†å—è¯»å†™å¯¹ç£ç›˜æ€§èƒ½çš„å½±å“
- **ç½‘ç»œå¸¦å®½ä½¿ç”¨**: ä¼ è¾“è¿‡ç¨‹ä¸­çš„ç½‘ç»œèµ„æºå ç”¨

**C. ç¨³å®šæ€§å‹åŠ›æµ‹è¯•**
- **24å°æ—¶è¿ç»­è¿è¡Œ**: é•¿æœŸç¨³å®šæ€§éªŒè¯
- **é«˜å¹¶å‘å‹åŠ›æµ‹è¯•**: åŒæ—¶å¤„ç†å¤§é‡ä¼ è¾“ä»»åŠ¡
- **å†…å­˜æ³„æ¼æ£€æµ‹**: ä½¿ç”¨valgrindç­‰å·¥å…·æ£€æµ‹å†…å­˜é—®é¢˜
- **å¼‚å¸¸åœºæ™¯å‹æµ‹**: é¢‘ç¹çš„ç½‘ç»œä¸­æ–­å’Œæ¢å¤

#### 1.6.5 éªŒæ”¶æ ‡å‡†è¯¦ç»†å®šä¹‰

**A. åŠŸèƒ½éªŒæ”¶æ ‡å‡†**
| éªŒæ”¶é¡¹ç›® | æµ‹è¯•æ–¹æ³• | æˆåŠŸæ ‡å‡† | éªŒè¯æ–¹å¼ |
|---------|---------|---------|----------|
| **æ–‡ä»¶ä¼ è¾“å®Œæ•´æ€§** | ä¼ è¾“100ä¸ªä¸åŒå¤§å°æ–‡ä»¶ | 100%æˆåŠŸä¼ è¾“ | MD5æ ¡éªŒå¯¹æ¯” |
| **ä¸­æ–­æ¢å¤èƒ½åŠ›** | æ¨¡æ‹Ÿ10æ¬¡ç½‘ç»œä¸­æ–­ | >95%è‡ªåŠ¨æ¢å¤ | ä¼ è¾“çŠ¶æ€æ£€æŸ¥ |
| **å¹¶å‘ä¼ è¾“æ”¯æŒ** | åŒæ—¶ä¼ è¾“10ä¸ªæ–‡ä»¶ | å…¨éƒ¨æˆåŠŸå®Œæˆ | æ–‡ä»¶å®Œæ•´æ€§éªŒè¯ |
| **çŠ¶æ€è·Ÿè¸ªå‡†ç¡®æ€§** | å®æ—¶ç›‘æ§ä¼ è¾“è¿›åº¦ | è¿›åº¦è¯¯å·®<5% | æ•°æ®åº“çŠ¶æ€å¯¹æ¯” |

**B. æ€§èƒ½éªŒæ”¶æ ‡å‡†**
| æ€§èƒ½æŒ‡æ ‡ | åŸºå‡†å€¼ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|---------|-------|-------|----------|
| **ä¼ è¾“é€Ÿåº¦** | åŸç³»ç»Ÿé€Ÿåº¦ | â‰¥80%åŸºå‡†å€¼ | å¤šæ–‡ä»¶å¤§å°åŸºå‡†æµ‹è¯• |
| **å†…å­˜ä½¿ç”¨** | å½“å‰å†…å­˜ä½¿ç”¨ | å¢é‡â‰¤50MB | é•¿æœŸè¿è¡Œç›‘æ§ |
| **CPUä½¿ç”¨ç‡** | ç©ºé—²æ—¶<5% | ä¼ è¾“æ—¶<30% | ç³»ç»Ÿèµ„æºç›‘æ§ |
| **å“åº”æ—¶é—´** | ç”¨æˆ·æ“ä½œå“åº” | â‰¤2ç§’ | äº¤äº’æ“ä½œè®¡æ—¶ |
| **å¹¶å‘èƒ½åŠ›** | æ”¯æŒä¼ è¾“æ•°é‡ | â‰¥10ä¸ªä»»åŠ¡ | å¹¶å‘å‹åŠ›æµ‹è¯• |

**C. ç¨³å®šæ€§éªŒæ”¶æ ‡å‡†**
- **è¿ç»­è¿è¡Œç¨³å®šæ€§**: 24å°æ—¶æ— å´©æºƒé€€å‡º
- **ç½‘ç»œä¸­æ–­æ¢å¤**: æ¢å¤æ—¶é—´ â‰¤ 30ç§’ï¼ŒæˆåŠŸç‡ â‰¥ 95%
- **å†…å­˜å ç”¨æ§åˆ¶**: å³°å€¼ â‰¤ 100MB (ä¸è®ºæ–‡ä»¶å¤§å°)
- **ç³»ç»Ÿé‡å¯æ¢å¤**: ä»»åŠ¡æ¢å¤ç‡ = 100%
- **å®Œæ•´æ€§éªŒè¯**: é€šè¿‡ç‡ = 100% (åŸºäºMD5æ ¡éªŒ)
- **æ€§èƒ½å¼€é”€æ§åˆ¶**: æ ¡éªŒå¼€é”€ â‰¤ ä¼ è¾“æ—¶é—´çš„5%
- **æ•°æ®æŸåæ£€æµ‹**: æ£€æµ‹ç‡ â‰¥ 99.9% (é€šè¿‡åˆ†å—æ ¡éªŒ)

**D. éªŒæ”¶æµ‹è¯•æ‰§è¡Œæ¸…å•**
```bash
#!/bin/bash
# éªŒæ”¶æµ‹è¯•è‡ªåŠ¨åŒ–è„šæœ¬
echo "=== é˜¶æ®µä¸€éªŒæ”¶æµ‹è¯• ==="

TEST_RESULTS=()

# æ‰§è¡ŒåŠŸèƒ½æµ‹è¯•
echo "[1/4] åŠŸèƒ½éªŒæ”¶æµ‹è¯•..."
./test_functionality.sh && TEST_RESULTS+=("åŠŸèƒ½æµ‹è¯•:é€šè¿‡") || TEST_RESULTS+=("åŠŸèƒ½æµ‹è¯•:å¤±è´¥")

# æ‰§è¡Œæ€§èƒ½æµ‹è¯•
echo "[2/4] æ€§èƒ½éªŒæ”¶æµ‹è¯•..."
./test_performance.sh && TEST_RESULTS+=("æ€§èƒ½æµ‹è¯•:é€šè¿‡") || TEST_RESULTS+=("æ€§èƒ½æµ‹è¯•:å¤±è´¥")

# æ‰§è¡Œç¨³å®šæ€§æµ‹è¯•
echo "[3/4] ç¨³å®šæ€§éªŒæ”¶æµ‹è¯•..."
./test_stability.sh && TEST_RESULTS+=("ç¨³å®šæ€§æµ‹è¯•:é€šè¿‡") || TEST_RESULTS+=("ç¨³å®šæ€§æµ‹è¯•:å¤±è´¥")

# ç”ŸæˆéªŒæ”¶æŠ¥å‘Š
echo "[4/4] ç”ŸæˆéªŒæ”¶æŠ¥å‘Š..."
echo "éªŒæ”¶æµ‹è¯•ç»“æœ:" > acceptance_report.txt
for result in "${TEST_RESULTS[@]}"; do
    echo "- $result" >> acceptance_report.txt
done

echo "âœ… éªŒæ”¶æµ‹è¯•å®Œæˆï¼ŒæŠ¥å‘Šå·²ç”Ÿæˆ: acceptance_report.txt"
```

---

## é˜¶æ®µäºŒï¼šEdgeâ†’NASä¼ è¾“ä¼˜åŒ– (æ‰©å±•é˜¶æ®µ)

### 2.1 é˜¶æ®µç›®æ ‡

| ç›®æ ‡ç±»åˆ« | å½“å‰çŠ¶æ€ | ç›®æ ‡çŠ¶æ€ | æˆåŠŸæŒ‡æ ‡ |
|---------|---------|---------|----------|
| **ä¼ è¾“æ•ˆç‡** | å•æ–‡ä»¶é¡ºåºä¼ è¾“ | æ™ºèƒ½æ‰¹é‡å¹¶å‘ä¼ è¾“ | ååé‡æå‡50% |
| **å­˜å‚¨ç®¡ç†** | æ‰‹åŠ¨ç©ºé—´æ£€æŸ¥ | è‡ªåŠ¨ç©ºé—´ç›‘æ§é¢„è­¦ | ç©ºé—´é¢„è­¦å‡†ç¡®ç‡100% |
| **ç³»ç»Ÿç¨³å®šæ€§** | ä¼ è¾“å¤±è´¥éœ€æ‰‹åŠ¨é‡è¯• | è‡ªåŠ¨æ•…éšœæ¢å¤æœºåˆ¶ | ä¼ è¾“æˆåŠŸç‡â‰¥98% |
| **è¿ç»´æ•ˆç‡** | ç¼ºä¹ç›‘æ§å‘Šè­¦ | å®Œå–„çš„ç›‘æ§å‘Šè­¦ä½“ç³» | æ•…éšœå“åº”æ—¶é—´â‰¤5åˆ†é’Ÿ |
| **èµ„æºä¼˜åŒ–** | å›ºå®šä¼ è¾“å‚æ•° | ç½‘ç»œè‡ªé€‚åº”è°ƒæ•´ | ç½‘ç»œåˆ©ç”¨ç‡æå‡30% |

### 2.2 æŠ€æœ¯å®æ–½èŒƒå›´

**æ ¸å¿ƒä¼˜åŒ–æ¨¡å—**:
- âœ… **æ‰¹é‡ä¼ è¾“é˜Ÿåˆ—ç®¡ç†** - `NASTransferQueue` ç±»å®ç°
- âœ… **æ™ºèƒ½å­˜å‚¨ç©ºé—´ç®¡ç†** - `StorageSpaceManager` ç±»å®ç°  
- âœ… **ç½‘ç»œè‡ªé€‚åº”ä¼ è¾“** - `AdaptiveTransfer` ç±»å®ç°
- âœ… **ç›‘æ§å‘Šè­¦ç³»ç»Ÿ** - `TransferMonitor` ç±»å®ç°
- âœ… **ç³»ç»Ÿé›†æˆä¼˜åŒ–** - ä¸ç°æœ‰ `celestial_nasops` é›†æˆ

**æŠ€æœ¯å†³ç­–è¯´æ˜**:
- **ä¼ è¾“åè®®é€‰æ‹©**: ç»§ç»­ä½¿ç”¨rsyncï¼Œåˆ©ç”¨å…¶å†…ç½®æ ¡éªŒå’Œæ–­ç‚¹ç»­ä¼ èƒ½åŠ›
- **å¹¶å‘æ§åˆ¶**: é»˜è®¤5ä¸ªå¹¶å‘ä¼ è¾“ï¼Œå¯æ ¹æ®ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´
- **å­˜å‚¨ç­–ç•¥**: Edgeç«¯ä¼ è¾“å®Œæˆåå»¶è¿Ÿ2å°æ—¶æ¸…ç†ï¼Œç¡®ä¿ä¼ è¾“ç¨³å®šæ€§

### 2.3 æ ¸å¿ƒæŠ€æœ¯æ–¹æ¡ˆ

#### 2.3.1 å…³é”®æŠ€æœ¯å†³ç­–

**ä¸ºä»€ä¹ˆEdgeâ†’NASé˜¶æ®µä½¿ç”¨rsyncè€Œéè‡ªå®šä¹‰åˆ†å—ï¼Ÿ**

| å¯¹æ¯”ç»´åº¦ | rsyncæ–¹æ¡ˆ | è‡ªå®šä¹‰åˆ†å—æ–¹æ¡ˆ |
|---------|-----------|----------------|
| **å¼€å‘å¤æ‚åº¦** | ä½ï¼ˆæˆç†Ÿå·¥å…·ï¼‰ | é«˜ï¼ˆéœ€é‡æ–°å®ç°ï¼‰ |
| **ä¼ è¾“æ•ˆç‡** | é«˜ï¼ˆå¢é‡åŒæ­¥ï¼‰ | ä¸­ï¼ˆå…¨é‡ä¼ è¾“ï¼‰ |
| **æ–­ç‚¹ç»­ä¼ ** | å†…ç½®æ”¯æŒ | éœ€è‡ªè¡Œå®ç° |
| **å®Œæ•´æ€§æ ¡éªŒ** | å†…ç½®MD5+rolling checksum | éœ€è‡ªè¡Œå®ç° |
| **ç½‘ç»œé€‚åº”** | è‡ªåŠ¨ä¼˜åŒ– | éœ€æ‰‹åŠ¨è°ƒä¼˜ |
| **ç»´æŠ¤æˆæœ¬** | ä½ï¼ˆæ ‡å‡†å·¥å…·ï¼‰ | é«˜ï¼ˆè‡ªç»´æŠ¤ä»£ç ï¼‰ |

**æŠ€æœ¯é€‰æ‹©ç†ç”±**:
1. **æˆç†Ÿç¨³å®š**: rsyncæ˜¯ä¸šç•Œæ ‡å‡†çš„æ–‡ä»¶åŒæ­¥å·¥å…·ï¼Œç»è¿‡20+å¹´éªŒè¯
2. **æ€§èƒ½ä¼˜å¼‚**: å¢é‡ä¼ è¾“ç®—æ³•ï¼Œåªä¼ è¾“å˜åŒ–éƒ¨åˆ†
3. **å†…ç½®æ ¡éªŒ**: rolling checksum + MD5åŒé‡æ ¡éªŒæœºåˆ¶
4. **æ–­ç‚¹ç»­ä¼ **: ç½‘ç»œä¸­æ–­åè‡ªåŠ¨æ¢å¤ä¼ è¾“
5. **é…ç½®çµæ´»**: æ”¯æŒå¸¦å®½é™åˆ¶ã€å‹ç¼©ä¼ è¾“ç­‰å¤šç§ä¼˜åŒ–é€‰é¡¹

#### 2.3.2 æ™ºèƒ½ä¼ è¾“é˜Ÿåˆ—ç®¡ç†

```python
class NASTransferQueue:
    """NASä¼ è¾“é˜Ÿåˆ—ç®¡ç†å™¨ - æ”¯æŒä¼˜å…ˆçº§å’Œå¹¶å‘æ§åˆ¶"""
    
    def __init__(self, config):
        self.max_concurrent = config.get('max_concurrent_transfers', 5)  # æœ€å¤§å¹¶å‘æ•°
        self.priority_queue = PriorityQueue()  # ä¼˜å…ˆçº§é˜Ÿåˆ—
        self.active_transfers = {}  # æ´»è·ƒä¼ è¾“ä»»åŠ¡
        self.transfer_history = {}  # ä¼ è¾“å†å²è®°å½•
        self.bandwidth_limiter = BandwidthLimiter(config)  # å¸¦å®½æ§åˆ¶
        
    def add_transfer_task(self, file_info, priority='normal'):
        """æ·»åŠ ä¼ è¾“ä»»åŠ¡åˆ°é˜Ÿåˆ—
        
        Args:
            file_info: æ–‡ä»¶ä¿¡æ¯å¯¹è±¡
            priority: ä¼˜å…ˆçº§ (emergency/high/normal/low)
        """
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒä»»åŠ¡
        if self._is_duplicate_task(file_info):
            logger.info(f"è·³è¿‡é‡å¤ä»»åŠ¡: {file_info.local_path}")
            return False
            
        task = TransferTask(
            task_id=self._generate_task_id(),
            file_path=file_info.local_path,
            nas_path=file_info.nas_path,
            priority=self._get_priority_value(priority),
            file_size=file_info.size,
            created_time=datetime.now()
        )
        
        self.priority_queue.put(task)
        logger.info(f"ä»»åŠ¡å·²åŠ å…¥é˜Ÿåˆ—: {task.task_id}, ä¼˜å…ˆçº§: {priority}")
        return True
        
    def process_queue(self):
        """å¤„ç†ä¼ è¾“é˜Ÿåˆ— - ä¸»å¾ªç¯"""
        while not self.priority_queue.empty():
            # æ£€æŸ¥å¹¶å‘é™åˆ¶
            if len(self.active_transfers) >= self.max_concurrent:
                time.sleep(1)
                continue
                
            # è·å–ä¸‹ä¸€ä¸ªä»»åŠ¡
            task = self.priority_queue.get()
            
            # æ£€æŸ¥å­˜å‚¨ç©ºé—´
            if not self._check_storage_space(task.file_size):
                logger.warning(f"å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œä»»åŠ¡å»¶è¿Ÿ: {task.task_id}")
                self._delay_task(task, delay_seconds=300)  # å»¶è¿Ÿ5åˆ†é’Ÿ
                continue
                
            # å¯åŠ¨ä¼ è¾“
            self._start_transfer(task)
            
    def _start_transfer(self, task):
        """å¯åŠ¨å•ä¸ªä¼ è¾“ä»»åŠ¡"""
        try:
            # åˆ›å»ºä¼ è¾“è¿›ç¨‹
            transfer_process = RsyncTransferProcess(
                task=task,
                bandwidth_limit=self.bandwidth_limiter.get_current_limit(),
                callback=self._on_transfer_complete
            )
            
            # è®°å½•æ´»è·ƒä»»åŠ¡
            self.active_transfers[task.task_id] = {
                'task': task,
                'process': transfer_process,
                'start_time': datetime.now()
            }
            
            # å¯åŠ¨ä¼ è¾“
            transfer_process.start()
            logger.info(f"ä¼ è¾“å·²å¯åŠ¨: {task.task_id}")
            
        except Exception as e:
            logger.error(f"å¯åŠ¨ä¼ è¾“å¤±è´¥: {task.task_id}, é”™è¯¯: {e}")
            self._handle_transfer_error(task, e)
```

#### 2.3.3 æ™ºèƒ½ä¼ è¾“ç­–ç•¥è®¾è®¡

**A. ä¼˜å…ˆçº§ç®¡ç†ç­–ç•¥**
```python
class TransferPriorityManager:
    """ä¼ è¾“ä¼˜å…ˆçº§ç®¡ç†"""
    
    PRIORITY_LEVELS = {
        'emergency': 1,  # ç´§æ€¥æ–‡ä»¶ï¼ˆå‘Šè­¦ç›¸å…³ï¼‰
        'high': 2,       # é«˜ä¼˜å…ˆçº§ï¼ˆé‡è¦ä»»åŠ¡æ–‡ä»¶ï¼‰
        'normal': 3,     # æ™®é€šä¼˜å…ˆçº§ï¼ˆå¸¸è§„åª’ä½“æ–‡ä»¶ï¼‰
        'low': 4         # ä½ä¼˜å…ˆçº§ï¼ˆå†å²æ•°æ®ï¼‰
    }
    
    def determine_priority(self, file_info):
        """æ ¹æ®æ–‡ä»¶ç‰¹å¾è‡ªåŠ¨ç¡®å®šä¼˜å…ˆçº§"""
        # ç´§æ€¥æ–‡ä»¶åˆ¤æ–­
        if self._is_emergency_file(file_info):
            return 'emergency'
            
        # å¤§æ–‡ä»¶é™ä½ä¼˜å…ˆçº§
        if file_info.size > 500 * 1024 * 1024:  # >500MB
            return 'low'
            
        # æœ€æ–°æ–‡ä»¶æé«˜ä¼˜å…ˆçº§
        if self._is_recent_file(file_info, hours=2):
            return 'high'
            
        return 'normal'
```

**B. ç½‘ç»œè‡ªé€‚åº”ä¼ è¾“ç­–ç•¥**
```python
class NetworkAdaptiveStrategy:
    """ç½‘ç»œè‡ªé€‚åº”ä¼ è¾“ç­–ç•¥"""
    
    def __init__(self):
        self.network_monitor = NetworkMonitor()
        self.base_bandwidth_limit = 50  # MB/s åŸºç¡€å¸¦å®½é™åˆ¶
        
    def adjust_transfer_parameters(self):
        """æ ¹æ®ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´ä¼ è¾“å‚æ•°"""
        network_stats = self.network_monitor.get_current_stats()
        
        # ç½‘ç»œè´¨é‡è¯„ä¼°
        if network_stats.latency < 50 and network_stats.packet_loss < 0.1:
            # ç½‘ç»œä¼˜ç§€ï¼šæé«˜å¹¶å‘å’Œå¸¦å®½
            return {
                'max_concurrent': 8,
                'bandwidth_limit': self.base_bandwidth_limit * 1.5,
                'rsync_options': ['--compress-level=3', '--whole-file']
            }
        elif network_stats.latency > 200 or network_stats.packet_loss > 1.0:
            # ç½‘ç»œè¾ƒå·®ï¼šé™ä½å¹¶å‘ï¼Œå¯ç”¨å‹ç¼©
            return {
                'max_concurrent': 2,
                'bandwidth_limit': self.base_bandwidth_limit * 0.5,
                'rsync_options': ['--compress-level=9', '--partial']
            }
        else:
            # ç½‘ç»œä¸€èˆ¬ï¼šä½¿ç”¨é»˜è®¤å‚æ•°
            return {
                'max_concurrent': 5,
                'bandwidth_limit': self.base_bandwidth_limit,
                'rsync_options': ['--compress-level=6']
            }
```

**C. æ—¶é—´çª—å£ä¼ è¾“ç­–ç•¥**
```python
class TimeWindowStrategy:
    """æ—¶é—´çª—å£ä¼ è¾“ç­–ç•¥ - åœ¨ç½‘ç»œç©ºé—²æ—¶æ®µä¼ è¾“å¤§æ–‡ä»¶"""
    
    def __init__(self, config):
        # é…ç½®ä¼ è¾“æ—¶é—´çª—å£ï¼ˆ24å°æ—¶åˆ¶ï¼‰
        self.peak_hours = config.get('peak_hours', [8, 9, 10, 14, 15, 16, 17, 18])  # ç½‘ç»œç¹å¿™æ—¶æ®µ
        self.off_peak_hours = config.get('off_peak_hours', [22, 23, 0, 1, 2, 3, 4, 5, 6])  # ç½‘ç»œç©ºé—²æ—¶æ®µ
        self.large_file_threshold = config.get('large_file_threshold', 100 * 1024 * 1024)  # 100MB
        
    def should_transfer_now(self, file_size):
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥ç«‹å³ä¼ è¾“"""
        current_hour = datetime.now().hour
        
        # å°æ–‡ä»¶éšæ—¶ä¼ è¾“
        if file_size < self.large_file_threshold:
            return True
            
        # å¤§æ–‡ä»¶åœ¨ç©ºé—²æ—¶æ®µä¼ è¾“
        if current_hour in self.off_peak_hours:
            return True
            
        # ç¹å¿™æ—¶æ®µå»¶è¿Ÿå¤§æ–‡ä»¶ä¼ è¾“
        if current_hour in self.peak_hours:
            return False
            
        # å…¶ä»–æ—¶æ®µæ­£å¸¸ä¼ è¾“
        return True
```

### 2.4 æ™ºèƒ½å­˜å‚¨ç©ºé—´ç®¡ç†

#### 2.4.1 å­˜å‚¨ç©ºé—´ç›‘æ§ç³»ç»Ÿ

```python
class StorageSpaceManager:
    """æ™ºèƒ½å­˜å‚¨ç©ºé—´ç®¡ç†å™¨ - å¤šçº§é¢„è­¦å’Œè‡ªåŠ¨æ¸…ç†"""
    
    def __init__(self, config):
        # å­˜å‚¨é˜ˆå€¼é…ç½®
        self.edge_warning_threshold = config.get('edge_warning_threshold', 0.8)   # 80% è­¦å‘Š
        self.edge_critical_threshold = config.get('edge_critical_threshold', 0.9) # 90% ä¸¥é‡
        self.nas_warning_threshold = config.get('nas_warning_threshold', 0.85)    # 85% è­¦å‘Š
        self.nas_critical_threshold = config.get('nas_critical_threshold', 0.95)  # 95% ä¸¥é‡
        
        # ç›‘æ§é…ç½®
        self.check_interval = config.get('space_check_interval', 300)  # 5åˆ†é’Ÿæ£€æŸ¥é—´éš”
        self.cleanup_enabled = config.get('auto_cleanup_enabled', True)
        self.cleanup_delay_hours = config.get('cleanup_delay_hours', 2)  # ä¼ è¾“å®Œæˆ2å°æ—¶åæ¸…ç†
        
        # é¢„ç•™ç©ºé—´é…ç½®
        self.edge_reserved_gb = config.get('edge_reserved_space_gb', 5)  # Edgeé¢„ç•™5GB
        self.nas_reserved_gb = config.get('nas_reserved_space_gb', 50)   # NASé¢„ç•™50GB
        
    def check_storage_space(self):
        """å…¨é¢çš„å­˜å‚¨ç©ºé—´æ£€æŸ¥"""
        edge_stats = self._get_edge_storage_stats()
        nas_stats = self._get_nas_storage_stats()
        
        # è¯„ä¼°å­˜å‚¨çŠ¶æ€
        edge_status = self._evaluate_storage_status(edge_stats, 'edge')
        nas_status = self._evaluate_storage_status(nas_stats, 'nas')
        
        # å¤„ç†å‘Šè­¦
        self._handle_storage_alerts(edge_status, nas_status)
        
        # è§¦å‘è‡ªåŠ¨æ¸…ç†
        if self.cleanup_enabled:
            self._trigger_auto_cleanup(edge_status, nas_status)
            
        return {
            'edge': edge_stats,
            'nas': nas_stats,
            'overall_status': self._get_overall_status(edge_status, nas_status),
            'recommendations': self._get_storage_recommendations(edge_status, nas_status)
        }
        
    def _evaluate_storage_status(self, stats, storage_type):
        """è¯„ä¼°å­˜å‚¨çŠ¶æ€çº§åˆ«"""
        usage_ratio = stats['used'] / stats['total']
        
        if storage_type == 'edge':
            if usage_ratio >= self.edge_critical_threshold:
                return {'level': 'critical', 'usage': usage_ratio, 'action_required': True}
            elif usage_ratio >= self.edge_warning_threshold:
                return {'level': 'warning', 'usage': usage_ratio, 'action_required': False}
        else:  # nas
            if usage_ratio >= self.nas_critical_threshold:
                return {'level': 'critical', 'usage': usage_ratio, 'action_required': True}
            elif usage_ratio >= self.nas_warning_threshold:
                return {'level': 'warning', 'usage': usage_ratio, 'action_required': False}
                
        return {'level': 'normal', 'usage': usage_ratio, 'action_required': False}
        
    def can_accommodate_transfer(self, file_size, target='nas'):
        """æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿç©ºé—´è¿›è¡Œä¼ è¾“"""
        if target == 'nas':
            stats = self._get_nas_storage_stats()
            reserved_bytes = self.nas_reserved_gb * 1024 * 1024 * 1024
        else:
            stats = self._get_edge_storage_stats()
            reserved_bytes = self.edge_reserved_gb * 1024 * 1024 * 1024
            
        available_space = stats['free'] - reserved_bytes
        return available_space >= file_size
```

#### 2.4.2 æ™ºèƒ½æ¸…ç†ç­–ç•¥

```python
class StorageCleanupManager:
    """å­˜å‚¨æ¸…ç†ç®¡ç†å™¨ - æ™ºèƒ½æ¸…ç†ç­–ç•¥"""
    
    def __init__(self, config):
        self.cleanup_policies = {
            'transferred_files': {
                'enabled': config.get('cleanup_transferred_files', True),
                'delay_hours': config.get('cleanup_delay_hours', 2),
                'verify_nas_copy': True  # ç¡®è®¤NASå‰¯æœ¬å­˜åœ¨åæ‰æ¸…ç†
            },
            'failed_transfers': {
                'enabled': config.get('cleanup_failed_files', False),
                'retention_days': config.get('failed_files_retention_days', 7)
            },
            'temp_files': {
                'enabled': True,
                'max_age_hours': 24
            },
            'log_files': {
                'enabled': True,
                'retention_days': 30,
                'compress_after_days': 7
            }
        }
        
    def execute_cleanup(self, storage_status):
        """æ‰§è¡Œæ¸…ç†æ“ä½œ"""
        cleanup_results = []
        
        # æ ¹æ®å­˜å‚¨çŠ¶æ€ç¡®å®šæ¸…ç†ä¼˜å…ˆçº§
        if storage_status['edge']['level'] == 'critical':
            # ç´§æ€¥æ¸…ç†ï¼šç«‹å³æ¸…ç†æ‰€æœ‰å¯æ¸…ç†æ–‡ä»¶
            cleanup_results.extend(self._emergency_cleanup())
        elif storage_status['edge']['level'] == 'warning':
            # é¢„é˜²æ€§æ¸…ç†ï¼šæ¸…ç†è¿‡æœŸæ–‡ä»¶
            cleanup_results.extend(self._preventive_cleanup())
        else:
            # å¸¸è§„æ¸…ç†ï¼šæŒ‰ç­–ç•¥æ¸…ç†
            cleanup_results.extend(self._routine_cleanup())
            
        return cleanup_results
        
    def _emergency_cleanup(self):
        """ç´§æ€¥æ¸…ç†æ¨¡å¼"""
        logger.warning("æ‰§è¡Œç´§æ€¥å­˜å‚¨æ¸…ç†")
        results = []
        
        # 1. æ¸…ç†æ‰€æœ‰å·²ä¼ è¾“æ–‡ä»¶ï¼ˆå¿½ç•¥å»¶è¿Ÿæ—¶é—´ï¼‰
        results.extend(self._cleanup_transferred_files(ignore_delay=True))
        
        # 2. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        results.extend(self._cleanup_temp_files())
        
        # 3. å‹ç¼©æ—¥å¿—æ–‡ä»¶
        results.extend(self._compress_log_files())
        
        # 4. æ¸…ç†å¤±è´¥ä¼ è¾“æ–‡ä»¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if self.cleanup_policies['failed_transfers']['enabled']:
            results.extend(self._cleanup_failed_files())
            
        return results
```

### 2.5 rsyncä¼ è¾“ä¼˜åŒ–ä¸å®Œæ•´æ€§éªŒè¯

#### 2.5.1 rsyncä¼ è¾“ä¼˜åŒ–é…ç½®

**ä¸ºä»€ä¹ˆé€‰æ‹©rsyncè€Œéè‡ªå®šä¹‰åˆ†å—ä¼ è¾“ï¼Ÿ**

```python
class RsyncTransferOptimizer:
    """rsyncä¼ è¾“ä¼˜åŒ–å™¨ - æ ¹æ®ç½‘ç»œå’Œæ–‡ä»¶ç‰¹å¾ä¼˜åŒ–ä¼ è¾“å‚æ•°"""
    
    def __init__(self, config):
        self.base_config = {
            'archive': True,           # -a ä¿æŒæ–‡ä»¶å±æ€§
            'verbose': True,           # -v è¯¦ç»†è¾“å‡º
            'compress': True,          # -z å‹ç¼©ä¼ è¾“
            'partial': True,           # --partial æ”¯æŒæ–­ç‚¹ç»­ä¼ 
            'progress': True,          # --progress æ˜¾ç¤ºè¿›åº¦
            'checksum': True,          # --checksum ä½¿ç”¨æ ¡éªŒå’Œ
            'timeout': 300,            # --timeout è¶…æ—¶è®¾ç½®
            'contimeout': 30           # --contimeout è¿æ¥è¶…æ—¶
        }
        
    def get_optimized_rsync_command(self, file_info, network_stats):
        """æ ¹æ®æ–‡ä»¶å’Œç½‘ç»œç‰¹å¾ç”Ÿæˆä¼˜åŒ–çš„rsyncå‘½ä»¤"""
        options = self.base_config.copy()
        
        # æ ¹æ®æ–‡ä»¶å¤§å°è°ƒæ•´ç­–ç•¥
        if file_info.size > 100 * 1024 * 1024:  # >100MB
            options.update({
                'compress_level': 3,      # é™ä½å‹ç¼©çº§åˆ«ï¼Œå‡å°‘CPUå ç”¨
                'whole_file': True,       # å¤§æ–‡ä»¶ä½¿ç”¨whole-fileæ¨¡å¼
                'bwlimit': self._calculate_bandwidth_limit(network_stats)
            })
        else:
            options.update({
                'compress_level': 6,      # ä¸­ç­‰å‹ç¼©çº§åˆ«
                'whole_file': False       # å°æ–‡ä»¶ä½¿ç”¨å¢é‡ä¼ è¾“
            })
            
        # æ ¹æ®ç½‘ç»œçŠ¶å†µè°ƒæ•´
        if network_stats.latency > 100:  # é«˜å»¶è¿Ÿç½‘ç»œ
            options.update({
                'timeout': 600,           # å¢åŠ è¶…æ—¶æ—¶é—´
                'compress_level': 9,      # æœ€é«˜å‹ç¼©çº§åˆ«
                'delay_updates': True     # å»¶è¿Ÿæ›´æ–°ï¼Œå‡å°‘ç½‘ç»œå¾€è¿”
            })
            
        return self._build_rsync_command(file_info, options)
        
    def _build_rsync_command(self, file_info, options):
        """æ„å»ºrsyncå‘½ä»¤"""
        cmd_parts = ['rsync']
        
        # åŸºç¡€é€‰é¡¹
        if options.get('archive'): cmd_parts.append('-a')
        if options.get('verbose'): cmd_parts.append('-v')
        if options.get('compress'): cmd_parts.append('-z')
        if options.get('partial'): cmd_parts.append('--partial')
        if options.get('progress'): cmd_parts.append('--progress')
        if options.get('checksum'): cmd_parts.append('--checksum')
        
        # é«˜çº§é€‰é¡¹
        if options.get('whole_file'): cmd_parts.append('--whole-file')
        if options.get('delay_updates'): cmd_parts.append('--delay-updates')
        
        # æ•°å€¼é€‰é¡¹
        if options.get('compress_level'):
            cmd_parts.append(f"--compress-level={options['compress_level']}")
        if options.get('bwlimit'):
            cmd_parts.append(f"--bwlimit={options['bwlimit']}")
        if options.get('timeout'):
            cmd_parts.append(f"--timeout={options['timeout']}")
        if options.get('contimeout'):
            cmd_parts.append(f"--contimeout={options['contimeout']}")
            
        # æºæ–‡ä»¶å’Œç›®æ ‡è·¯å¾„
        cmd_parts.extend([file_info.local_path, file_info.nas_path])
        
        return cmd_parts
```

#### 2.5.2 å¤šå±‚å®Œæ•´æ€§éªŒè¯ç­–ç•¥

```python
class EdgeToNasIntegrityValidator:
    """Edgeåˆ°NASä¼ è¾“çš„å¤šå±‚å®Œæ•´æ€§éªŒè¯"""
    
    def __init__(self):
        self.validation_methods = {
            'size_check': True,        # æ–‡ä»¶å¤§å°éªŒè¯
            'md5_check': True,         # MD5æ ¡éªŒ
            'rsync_checksum': True,    # rsyncå†…ç½®æ ¡éªŒ
            'timestamp_check': True    # æ—¶é—´æˆ³éªŒè¯
        }
        
    def validate_transfer(self, local_file, remote_file):
        """æ‰§è¡Œå¤šå±‚ä¼ è¾“éªŒè¯"""
        validation_results = {
            'overall_success': True,
            'checks': {},
            'errors': []
        }
        
        try:
            # 1. æ–‡ä»¶å¤§å°éªŒè¯
            if self.validation_methods['size_check']:
                size_valid = self._validate_file_size(local_file, remote_file)
                validation_results['checks']['size_check'] = size_valid
                if not size_valid:
                    validation_results['overall_success'] = False
                    validation_results['errors'].append('æ–‡ä»¶å¤§å°ä¸åŒ¹é…')
                    
            # 2. MD5æ ¡éªŒ
            if self.validation_methods['md5_check']:
                md5_valid = self._validate_md5_checksum(local_file, remote_file)
                validation_results['checks']['md5_check'] = md5_valid
                if not md5_valid:
                    validation_results['overall_success'] = False
                    validation_results['errors'].append('MD5æ ¡éªŒå¤±è´¥')
                    
            # 3. æ—¶é—´æˆ³éªŒè¯
            if self.validation_methods['timestamp_check']:
                timestamp_valid = self._validate_timestamp(local_file, remote_file)
                validation_results['checks']['timestamp_check'] = timestamp_valid
                if not timestamp_valid:
                    validation_results['errors'].append('æ—¶é—´æˆ³ä¸åŒ¹é…ï¼ˆè­¦å‘Šï¼‰')
                    
        except Exception as e:
            validation_results['overall_success'] = False
            validation_results['errors'].append(f'éªŒè¯è¿‡ç¨‹å¼‚å¸¸: {str(e)}')
            
        return validation_results
        
    def _validate_md5_checksum(self, local_file, remote_file):
        """MD5æ ¡éªŒéªŒè¯"""
        try:
            # è®¡ç®—æœ¬åœ°æ–‡ä»¶MD5
            local_md5 = self._calculate_file_md5(local_file)
            
            # é€šè¿‡SSHè®¡ç®—è¿œç¨‹æ–‡ä»¶MD5
            remote_md5 = self._calculate_remote_file_md5(remote_file)
            
            return local_md5 == remote_md5
            
        except Exception as e:
            logger.error(f"MD5æ ¡éªŒå¼‚å¸¸: {e}")
            return False
```

#### 2.4.2 rsyncä¼ è¾“ä¸å®Œæ•´æ€§éªŒè¯

**Edgeåˆ°NASä¼ è¾“é‡‡ç”¨rsyncçš„ä¼˜åŠ¿**ï¼š

```bash
# rsyncå†…ç½®å®Œæ•´æ€§éªŒè¯å‘½ä»¤ç¤ºä¾‹
rsync -avz --checksum --progress \
  /home/celestial/dev/esdk-test/Edge-SDK/celestial_works/media/ \
  edge_sync@nas-edge:/volume1/drone_media/
```

**rsyncå†…ç½®æ ¡éªŒæœºåˆ¶**ï¼š
- **Rolling Checksum**: å¿«é€Ÿæ£€æµ‹æ–‡ä»¶å·®å¼‚
- **MD5æ ¡éªŒ**: ä¼ è¾“å®Œæˆåçš„å®Œæ•´æ€§éªŒè¯
- **å¢é‡ä¼ è¾“**: åªä¼ è¾“å˜åŒ–çš„éƒ¨åˆ†
- **æ–­ç‚¹ç»­ä¼ **: ç½‘ç»œä¸­æ–­åè‡ªåŠ¨æ¢å¤

**ä¸ºä»€ä¹ˆä»éœ€åº”ç”¨å±‚åˆ†å—æ ¡éªŒ**ï¼š

```python
class EdgeToNasTransferManager:
    def transfer_with_validation(self, local_file, remote_path):
        """Edgeåˆ°NASä¼ è¾“çš„å¤šå±‚éªŒè¯"""
        # 1. ä¼ è¾“å‰éªŒè¯ï¼ˆç¡®ä¿æºæ–‡ä»¶å®Œæ•´ï¼‰
        if not self._validate_source_integrity(local_file):
            return False, "æºæ–‡ä»¶å®Œæ•´æ€§éªŒè¯å¤±è´¥"
            
        # 2. rsyncä¼ è¾“ï¼ˆå†…ç½®æ ¡éªŒï¼‰
        rsync_result = self._rsync_transfer(local_file, remote_path)
        if not rsync_result.success:
            return False, f"rsyncä¼ è¾“å¤±è´¥: {rsync_result.error}"
            
        # 3. ä¼ è¾“åéªŒè¯ï¼ˆåŒé‡ä¿éšœï¼‰
        if not self._verify_remote_file(local_file, remote_path):
            return False, "ä¼ è¾“åéªŒè¯å¤±è´¥"
            
        return True, "ä¼ è¾“å®Œæˆå¹¶éªŒè¯é€šè¿‡"
        
    def _validate_source_integrity(self, file_path):
        """éªŒè¯æ¥è‡ªDockçš„æ–‡ä»¶å®Œæ•´æ€§"""
        # ç”±äºDockä¼ è¾“å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œéœ€è¦éªŒè¯Edgeç«¯æ–‡ä»¶
        return self.integrity_validator.validate_file(file_path)
```

**å¤šå±‚éªŒè¯ç­–ç•¥**ï¼š
1. **ä¼ è¾“å‰éªŒè¯**: ç¡®ä¿Edgeç«¯æ–‡ä»¶å®Œæ•´ï¼ˆæ¥è‡ªDockçš„æ–‡ä»¶å¯èƒ½æŸåï¼‰
2. **rsyncå†…ç½®éªŒè¯**: ä¼ è¾“è¿‡ç¨‹ä¸­çš„æ ¡éªŒå’ŒéªŒè¯
3. **ä¼ è¾“åéªŒè¯**: åº”ç”¨å±‚çš„é¢å¤–å®Œæ•´æ€§æ£€æŸ¥
4. **åˆ†å—ç›‘æ§**: æä¾›è¯¦ç»†çš„ä¼ è¾“è¿›åº¦å’Œæ•…éšœå®šä½

### 2.6 æ™ºèƒ½ç›‘æ§å‘Šè­¦ç³»ç»Ÿ

#### 2.6.1 å¤šç»´åº¦ç›‘æ§æŒ‡æ ‡æ”¶é›†

```python
class TransferMonitoringSystem:
    """ä¼ è¾“ç›‘æ§ç³»ç»Ÿ - å¤šç»´åº¦æŒ‡æ ‡æ”¶é›†å’Œåˆ†æ"""
    
    def __init__(self, config):
        self.monitoring_config = {
            'metrics_collection_interval': config.get('metrics_interval', 60),  # 1åˆ†é’Ÿ
            'alert_check_interval': config.get('alert_interval', 300),          # 5åˆ†é’Ÿ
            'metrics_retention_days': config.get('metrics_retention', 30),      # 30å¤©
            'performance_baseline_days': config.get('baseline_days', 7)         # 7å¤©åŸºçº¿
        }
        
        self.metrics_categories = {
            'transfer_performance': {
                'transfer_speed_mbps': [],
                'transfer_success_rate': 0.0,
                'average_file_size_mb': 0.0,
                'concurrent_transfers': 0,
                'queue_processing_rate': 0.0
            },
            'system_health': {
                'cpu_usage_percent': 0.0,
                'memory_usage_percent': 0.0,
                'disk_io_rate': 0.0,
                'network_utilization': 0.0
            },
            'storage_metrics': {
                'edge_storage_usage': 0.0,
                'nas_storage_usage': 0.0,
                'edge_free_space_gb': 0.0,
                'nas_free_space_gb': 0.0,
                'cleanup_efficiency': 0.0
            },
            'error_tracking': {
                'total_errors_today': 0,
                'network_errors': 0,
                'storage_errors': 0,
                'validation_errors': 0,
                'retry_success_rate': 0.0
            }
        }
        
    def collect_comprehensive_metrics(self):
        """æ”¶é›†å…¨é¢çš„ç›‘æ§æŒ‡æ ‡"""
        timestamp = datetime.now()
        
        # æ”¶é›†å„ç±»æŒ‡æ ‡
        transfer_metrics = self._collect_transfer_metrics()
        system_metrics = self._collect_system_metrics()
        storage_metrics = self._collect_storage_metrics()
        error_metrics = self._collect_error_metrics()
        
        # è®¡ç®—è¡ç”ŸæŒ‡æ ‡
        derived_metrics = self._calculate_derived_metrics(
            transfer_metrics, system_metrics, storage_metrics, error_metrics
        )
        
        # ç»„è£…å®Œæ•´æŒ‡æ ‡æ•°æ®
        comprehensive_metrics = {
            'timestamp': timestamp,
            'transfer_performance': transfer_metrics,
            'system_health': system_metrics,
            'storage_metrics': storage_metrics,
            'error_tracking': error_metrics,
            'derived_metrics': derived_metrics,
            'overall_health_score': self._calculate_health_score(transfer_metrics, system_metrics, storage_metrics)
        }
        
        # å­˜å‚¨æŒ‡æ ‡å†å²
        self._store_metrics_history(comprehensive_metrics)
        
        return comprehensive_metrics
        
    def _calculate_health_score(self, transfer_metrics, system_metrics, storage_metrics):
        """è®¡ç®—ç³»ç»Ÿæ•´ä½“å¥åº·è¯„åˆ† (0-100)"""
        scores = {
            'transfer_health': min(100, transfer_metrics['transfer_success_rate'] * 100),
            'system_health': max(0, 100 - max(system_metrics['cpu_usage_percent'], 
                                            system_metrics['memory_usage_percent'])),
            'storage_health': max(0, 100 - max(storage_metrics['edge_storage_usage'] * 100,
                                             storage_metrics['nas_storage_usage'] * 100))
        }
        
        # åŠ æƒå¹³å‡
        weights = {'transfer_health': 0.5, 'system_health': 0.3, 'storage_health': 0.2}
        overall_score = sum(scores[key] * weights[key] for key in scores)
        
        return round(overall_score, 2)
```

#### 2.6.2 æ™ºèƒ½å‘Šè­¦è§„åˆ™å¼•æ“

```python
class IntelligentAlertEngine:
    """æ™ºèƒ½å‘Šè­¦å¼•æ“ - å¤šçº§å‘Šè­¦å’Œè‡ªé€‚åº”é˜ˆå€¼"""
    
    def __init__(self, config):
        self.alert_rules = {
            'critical_alerts': {
                'storage_critical': {
                    'condition': 'storage_usage > 0.95',
                    'message': 'Critical: Storage usage exceeds 95%',
                    'cooldown_minutes': 30,
                    'escalation_minutes': 60
                },
                'transfer_failure_spike': {
                    'condition': 'error_rate > 0.5 AND consecutive_failures > 10',
                    'message': 'Critical: High transfer failure rate detected',
                    'cooldown_minutes': 15,
                    'escalation_minutes': 30
                },
                'system_overload': {
                    'condition': 'cpu_usage > 0.9 AND memory_usage > 0.9',
                    'message': 'Critical: System resource overload',
                    'cooldown_minutes': 10,
                    'escalation_minutes': 20
                }
            },
            'warning_alerts': {
                'storage_warning': {
                    'condition': 'storage_usage > 0.8',
                    'message': 'Warning: Storage usage exceeds 80%',
                    'cooldown_minutes': 60
                },
                'performance_degradation': {
                    'condition': 'transfer_speed < baseline_speed * 0.5',
                    'message': 'Warning: Transfer performance degraded',
                    'cooldown_minutes': 30
                },
                'queue_backlog': {
                    'condition': 'queue_length > 50 AND queue_age > 3600',
                    'message': 'Warning: Transfer queue backlog detected',
                    'cooldown_minutes': 45
                }
            },
            'info_alerts': {
                'daily_summary': {
                    'condition': 'daily_schedule',
                    'message': 'Info: Daily transfer summary',
                    'schedule': '08:00'
                },
                'maintenance_reminder': {
                    'condition': 'weekly_schedule',
                    'message': 'Info: Weekly maintenance reminder',
                    'schedule': 'monday 09:00'
                }
            }
        }
        
    def evaluate_alerts(self, metrics):
        """è¯„ä¼°å‘Šè­¦æ¡ä»¶å¹¶è§¦å‘é€šçŸ¥"""
        triggered_alerts = []
        
        # è¯„ä¼°å„çº§åˆ«å‘Šè­¦
        for alert_level in ['critical_alerts', 'warning_alerts', 'info_alerts']:
            for alert_name, alert_config in self.alert_rules[alert_level].items():
                if self._evaluate_alert_condition(alert_config['condition'], metrics):
                    # æ£€æŸ¥å†·å´æ—¶é—´
                    if self._is_alert_cooled_down(alert_name, alert_config):
                        alert_info = {
                            'name': alert_name,
                            'level': alert_level.replace('_alerts', ''),
                            'message': alert_config['message'],
                            'timestamp': datetime.now(),
                            'metrics_snapshot': metrics,
                            'recommended_actions': self._get_recommended_actions(alert_name)
                        }
                        
                        triggered_alerts.append(alert_info)
                        self._send_alert_notifications(alert_info)
                        
        return triggered_alerts
```

#### 2.6.3 å‘Šè­¦é€šçŸ¥ä¸å‡çº§æœºåˆ¶

| å‘Šè­¦çº§åˆ« | è§¦å‘æ¡ä»¶ | é€šçŸ¥æ–¹å¼ | å†·å´æ—¶é—´ | å‡çº§æ—¶é—´ |
|---------|---------|---------|---------|----------|
| **Critical** | å­˜å‚¨ä½¿ç”¨>95%ã€è¿ç»­å¤±è´¥>10æ¬¡ã€ç³»ç»Ÿè¿‡è½½ | é‚®ä»¶+æ—¥å¿—+Webhook | 15-30åˆ†é’Ÿ | 20-60åˆ†é’Ÿ |
| **Warning** | å­˜å‚¨ä½¿ç”¨>80%ã€æ€§èƒ½ä¸‹é™50%ã€é˜Ÿåˆ—ç§¯å‹ | é‚®ä»¶+æ—¥å¿— | 30-60åˆ†é’Ÿ | æ—  |
| **Info** | æ—¥å¸¸æ‘˜è¦ã€ç»´æŠ¤æé†’ | é‚®ä»¶ | 24å°æ—¶ | æ—  |

### 2.7 ç³»ç»Ÿé›†æˆæ–¹æ¡ˆ

#### 2.7.1 ä¸ç°æœ‰ç³»ç»Ÿçš„æ— ç¼é›†æˆ

```python
# æ‰©å±•ç°æœ‰çš„ media_finding_daemon.py
class EnhancedMediaFindingDaemon:
    """å¢å¼ºçš„åª’ä½“æ–‡ä»¶å‘ç°å®ˆæŠ¤è¿›ç¨‹ - é›†æˆNASä¼ è¾“åŠŸèƒ½"""
    
    def __init__(self, config):
        # ç°æœ‰ç»„ä»¶
        self.media_finder = MediaFinder(config)
        self.dock_transfer_manager = DockTransferManager(config)
        
        # æ–°å¢NASä¼ è¾“ç»„ä»¶
        self.nas_transfer_manager = NASTransferManager(config)
        self.storage_monitor = StorageSpaceManager(config)
        self.transfer_monitor = TransferMonitoringSystem(config)
        self.alert_engine = IntelligentAlertEngine(config)
        
        # é›†æˆé…ç½®
        self.integration_config = {
            'enable_auto_nas_transfer': config.get('auto_nas_transfer', True),
            'transfer_delay_seconds': config.get('transfer_delay', 30),  # Dockä¼ è¾“å®Œæˆåç­‰å¾…30ç§’
            'integrity_check_required': config.get('require_integrity_check', True),
            'cleanup_after_transfer': config.get('cleanup_after_transfer', True)
        }
        
    def run_integrated_workflow(self):
        """è¿è¡Œé›†æˆå·¥ä½œæµç¨‹"""
        while True:
            try:
                # 1. æ‰§è¡Œç°æœ‰çš„åª’ä½“å‘ç°å’ŒDockä¼ è¾“é€»è¾‘
                self._execute_dock_transfer_cycle()
                
                # 2. å¤„ç†å®Œæˆçš„Edgeç«¯æ–‡ä»¶
                self._process_completed_edge_files()
                
                # 3. ç›‘æ§ç³»ç»ŸçŠ¶æ€
                self._monitor_system_health()
                
                # 4. æ‰§è¡Œç»´æŠ¤ä»»åŠ¡
                self._execute_maintenance_tasks()
                
                time.sleep(self.integration_config['transfer_delay_seconds'])
                
            except Exception as e:
                logger.error(f"é›†æˆå·¥ä½œæµç¨‹å¼‚å¸¸: {e}")
                self._handle_workflow_exception(e)
                
    def _process_completed_edge_files(self):
        """å¤„ç†Edgeç«¯å®Œæˆçš„æ–‡ä»¶ - æ ¸å¿ƒé›†æˆé€»è¾‘"""
        # è·å–å·²å®Œæˆçš„Edgeç«¯æ–‡ä»¶
        completed_files = self._get_completed_edge_files()
        
        for file_info in completed_files:
            try:
                # 1. å®Œæ•´æ€§éªŒè¯ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                if self.integration_config['integrity_check_required']:
                    if not self._verify_file_integrity(file_info):
                        logger.warning(f"æ–‡ä»¶å®Œæ•´æ€§éªŒè¯å¤±è´¥ï¼Œè·³è¿‡ä¼ è¾“: {file_info.path}")
                        continue
                        
                # 2. å­˜å‚¨ç©ºé—´æ£€æŸ¥
                if not self.storage_monitor.can_accommodate_transfer(file_info.size):
                    self._handle_insufficient_storage(file_info)
                    continue
                    
                # 3. æ·»åŠ åˆ°NASä¼ è¾“é˜Ÿåˆ—
                transfer_task = self._create_transfer_task(file_info)
                self.nas_transfer_manager.add_transfer_task(transfer_task)
                
                logger.info(f"æ–‡ä»¶å·²æ·»åŠ åˆ°NASä¼ è¾“é˜Ÿåˆ—: {file_info.path}")
                
            except Exception as e:
                logger.error(f"å¤„ç†æ–‡ä»¶æ—¶å¼‚å¸¸ {file_info.path}: {e}")
                
    def _create_transfer_task(self, file_info):
        """åˆ›å»ºä¼ è¾“ä»»åŠ¡"""
        return {
            'id': self._generate_task_id(),
            'source_path': file_info.path,
            'target_path': self._determine_nas_path(file_info),
            'file_size': file_info.size,
            'priority': self._determine_priority(file_info),
            'created_at': datetime.now(),
            'metadata': {
                'drone_sn': file_info.drone_sn,
                'capture_time': file_info.capture_time,
                'file_type': file_info.file_type,
                'dock_transfer_completed_at': file_info.completed_at
            }
        }
        
    def _monitor_system_health(self):
        """ç›‘æ§ç³»ç»Ÿå¥åº·çŠ¶æ€"""
        # æ”¶é›†ç›‘æ§æŒ‡æ ‡
        metrics = self.transfer_monitor.collect_comprehensive_metrics()
        
        # è¯„ä¼°å‘Šè­¦æ¡ä»¶
        alerts = self.alert_engine.evaluate_alerts(metrics)
        
        # å¤„ç†è§¦å‘çš„å‘Šè­¦
        for alert in alerts:
            self._handle_system_alert(alert)
            
        # æ›´æ–°ç³»ç»ŸçŠ¶æ€
        self._update_system_status(metrics)
```

#### 2.7.2 é…ç½®ç®¡ç†ç»Ÿä¸€åŒ–

**æ‰©å±• `unified_config.json` é…ç½®**ï¼š

```json
{
  "nas_transfer": {
    "enabled": true,
    "connection": {
      "host": "nas-edge",
      "username": "edge_sync",
      "ssh_key_path": "/home/celestial/.ssh/id_rsa",
      "connection_timeout": 30,
      "max_retries": 3
    },
    "transfer_settings": {
      "max_concurrent_transfers": 5,
      "rsync_options": {
        "compress": true,
        "archive": true,
        "partial": true,
        "progress": true,
        "checksum": true,
        "timeout": 300
      },
      "bandwidth_limit_mbps": 0,
      "transfer_window": {
        "enabled": false,
        "start_hour": 22,
        "end_hour": 6
      }
    },
    "storage_management": {
      "edge_thresholds": {
        "warning": 0.8,
        "critical": 0.9
      },
      "nas_thresholds": {
        "warning": 0.85,
        "critical": 0.95
      },
      "auto_cleanup": {
        "enabled": true,
        "delay_hours": 2,
        "verify_nas_copy": true,
        "keep_failed_transfers": false
      },
      "reserved_space": {
        "edge_gb": 5,
        "nas_gb": 50
      }
    },
    "monitoring": {
      "metrics_interval_seconds": 60,
      "alert_check_interval_seconds": 300,
      "health_check_interval_seconds": 30,
      "performance_baseline_days": 7
    },
    "alerts": {
      "email_enabled": true,
      "email_recipients": ["admin@example.com"],
      "webhook_enabled": false,
      "webhook_url": "",
      "critical_alert_cooldown_minutes": 30,
      "warning_alert_cooldown_minutes": 60
    },
    "priorities": {
      "emergency": 1,
      "high": 2,
      "normal": 3,
      "low": 4
    },
    "file_patterns": {
      "high_priority": ["*.mp4", "*.mov"],
      "normal_priority": ["*.jpg", "*.jpeg"],
      "low_priority": ["*.log", "*.txt"]
    }
  },
  "integration": {
    "auto_nas_transfer": true,
    "transfer_delay_seconds": 30,
    "require_integrity_check": true,
    "cleanup_after_transfer": true,
    "max_transfer_retries": 3,
    "retry_delay_seconds": 60
  }
}
```

#### 2.7.3 æœåŠ¡å¯åŠ¨é›†æˆ

```python
class IntegratedServiceManager:
    """é›†æˆæœåŠ¡ç®¡ç†å™¨ - ç»Ÿä¸€å¯åŠ¨å’Œç®¡ç†æ‰€æœ‰æœåŠ¡"""
    
    def __init__(self, config_path):
        self.config = self._load_config(config_path)
        self.services = {}
        self.service_status = {}
        
    def start_all_services(self):
        """å¯åŠ¨æ‰€æœ‰é›†æˆæœåŠ¡"""
        startup_sequence = [
            ('config_validator', self._start_config_validator),
            ('storage_monitor', self._start_storage_monitor),
            ('transfer_monitor', self._start_transfer_monitor),
            ('nas_transfer_manager', self._start_nas_transfer_manager),
            ('alert_engine', self._start_alert_engine),
            ('media_finding_daemon', self._start_media_finding_daemon),
            ('health_checker', self._start_health_checker)
        ]
        
        for service_name, start_func in startup_sequence:
            try:
                logger.info(f"å¯åŠ¨æœåŠ¡: {service_name}")
                service_instance = start_func()
                self.services[service_name] = service_instance
                self.service_status[service_name] = 'running'
                logger.info(f"æœåŠ¡å¯åŠ¨æˆåŠŸ: {service_name}")
            except Exception as e:
                logger.error(f"æœåŠ¡å¯åŠ¨å¤±è´¥ {service_name}: {e}")
                self.service_status[service_name] = 'failed'
                raise
                
    def stop_all_services(self):
        """åœæ­¢æ‰€æœ‰æœåŠ¡"""
        for service_name, service_instance in reversed(list(self.services.items())):
            try:
                logger.info(f"åœæ­¢æœåŠ¡: {service_name}")
                if hasattr(service_instance, 'stop'):
                    service_instance.stop()
                self.service_status[service_name] = 'stopped'
            except Exception as e:
                logger.error(f"æœåŠ¡åœæ­¢å¼‚å¸¸ {service_name}: {e}")
                
    def get_service_status(self):
        """è·å–æ‰€æœ‰æœåŠ¡çŠ¶æ€"""
        return self.service_status.copy()
```

### 2.8 é˜¶æ®µäºŒæµ‹è¯•è®¡åˆ’

#### 2.8.1 æµ‹è¯•ç­–ç•¥æ¦‚è§ˆ

| æµ‹è¯•ç±»å‹ | æµ‹è¯•ç›®æ ‡ | æµ‹è¯•èŒƒå›´ | æˆåŠŸæ ‡å‡† | æµ‹è¯•å·¥å…· |
|---------|---------|---------|---------|----------|
| **åŠŸèƒ½æµ‹è¯•** | éªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£ç¡®æ€§ | å…¨éƒ¨æ ¸å¿ƒæ¨¡å— | 100%åŠŸèƒ½æ­£å¸¸ | è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶ |
| **æ€§èƒ½æµ‹è¯•** | éªŒè¯æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡ | ä¼ è¾“ã€å­˜å‚¨ã€ç›‘æ§ | è¾¾åˆ°æ€§èƒ½åŸºçº¿ | æ€§èƒ½æµ‹è¯•è„šæœ¬ |
| **ç¨³å®šæ€§æµ‹è¯•** | éªŒè¯é•¿æœŸè¿è¡Œç¨³å®šæ€§ | æ•´ä½“ç³»ç»Ÿ | 7x24å°æ—¶æ— æ•…éšœ | å‹åŠ›æµ‹è¯•å·¥å…· |
| **é›†æˆæµ‹è¯•** | éªŒè¯ç³»ç»Ÿé›†æˆæ•ˆæœ | ç«¯åˆ°ç«¯æµç¨‹ | ä¸šåŠ¡æµç¨‹å®Œæ•´ | é›†æˆæµ‹è¯•æ¡†æ¶ |
| **å®‰å…¨æµ‹è¯•** | éªŒè¯æ•°æ®ä¼ è¾“å®‰å…¨ | ä¼ è¾“é“¾è·¯ã€å­˜å‚¨ | æ— å®‰å…¨æ¼æ´ | å®‰å…¨æ‰«æå·¥å…· |

#### 2.8.2 åŠŸèƒ½æµ‹è¯•è¯¦ç»†è®¡åˆ’

**A. æ‰¹é‡ä¼ è¾“ç®¡ç†æµ‹è¯•**

```python
# test_nas_transfer_manager.py
import unittest
import tempfile
import os
from unittest.mock import Mock, patch
from celestial_nasops.nas_transfer_manager import NASTransferManager

class TestNASTransferManager(unittest.TestCase):
    """NASä¼ è¾“ç®¡ç†å™¨åŠŸèƒ½æµ‹è¯•å¥—ä»¶"""
    
    def setUp(self):
        self.config = {
            'nas_transfer': {
                'max_concurrent_transfers': 3,
                'connection': {'host': 'test-nas', 'username': 'test_user'}
            }
        }
        self.transfer_manager = NASTransferManager(self.config)
        
    def test_add_transfer_task(self):
        """æµ‹è¯•æ·»åŠ ä¼ è¾“ä»»åŠ¡"""
        task = {
            'id': 'test_001',
            'source_path': '/test/source.mp4',
            'target_path': '/nas/target.mp4',
            'file_size': 1024*1024*100,  # 100MB
            'priority': 2
        }
        
        result = self.transfer_manager.add_transfer_task(task)
        self.assertTrue(result)
        self.assertEqual(len(self.transfer_manager.pending_tasks), 1)
        
    def test_concurrent_transfer_limit(self):
        """æµ‹è¯•å¹¶å‘ä¼ è¾“é™åˆ¶"""
        # æ·»åŠ è¶…è¿‡é™åˆ¶æ•°é‡çš„ä»»åŠ¡
        for i in range(5):
            task = self._create_test_task(f'test_{i:03d}')
            self.transfer_manager.add_transfer_task(task)
            
        # å¯åŠ¨ä¼ è¾“
        self.transfer_manager.start_transfers()
        
        # éªŒè¯å¹¶å‘æ•°ä¸è¶…è¿‡é™åˆ¶
        active_transfers = len(self.transfer_manager.active_transfers)
        self.assertLessEqual(active_transfers, 3)
        
    def test_priority_queue_ordering(self):
        """æµ‹è¯•ä¼˜å…ˆçº§é˜Ÿåˆ—æ’åº"""
        # æ·»åŠ ä¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡
        tasks = [
            self._create_test_task('low', priority=4),
            self._create_test_task('high', priority=1),
            self._create_test_task('normal', priority=3)
        ]
        
        for task in tasks:
            self.transfer_manager.add_transfer_task(task)
            
        # è·å–ä¸‹ä¸€ä¸ªä»»åŠ¡åº”è¯¥æ˜¯é«˜ä¼˜å…ˆçº§
        next_task = self.transfer_manager._get_next_task()
        self.assertEqual(next_task['id'], 'high')
        
    def test_transfer_retry_mechanism(self):
        """æµ‹è¯•ä¼ è¾“é‡è¯•æœºåˆ¶"""
        task = self._create_test_task('retry_test')
        
        # æ¨¡æ‹Ÿä¼ è¾“å¤±è´¥
        with patch.object(self.transfer_manager, '_execute_rsync_transfer', return_value=False):
            result = self.transfer_manager._process_transfer_task(task)
            
        # éªŒè¯ä»»åŠ¡è¢«æ ‡è®°ä¸ºé‡è¯•
        self.assertFalse(result)
        self.assertEqual(task['retry_count'], 1)
        
    def _create_test_task(self, task_id, priority=2):
        return {
            'id': task_id,
            'source_path': f'/test/{task_id}.mp4',
            'target_path': f'/nas/{task_id}.mp4',
            'file_size': 1024*1024*50,
            'priority': priority,
            'retry_count': 0
        }
```

**B. å­˜å‚¨ç©ºé—´ç®¡ç†æµ‹è¯•**

```python
# test_storage_space_manager.py
class TestStorageSpaceManager(unittest.TestCase):
    """å­˜å‚¨ç©ºé—´ç®¡ç†å™¨æµ‹è¯•å¥—ä»¶"""
    
    def setUp(self):
        self.config = {
            'storage_management': {
                'edge_thresholds': {'warning': 0.8, 'critical': 0.9},
                'nas_thresholds': {'warning': 0.85, 'critical': 0.95}
            }
        }
        self.storage_manager = StorageSpaceManager(self.config)
        
    def test_space_threshold_detection(self):
        """æµ‹è¯•å­˜å‚¨ç©ºé—´é˜ˆå€¼æ£€æµ‹"""
        # æ¨¡æ‹Ÿä¸åŒçš„å­˜å‚¨ä½¿ç”¨ç‡
        test_cases = [
            (0.7, 'normal'),
            (0.85, 'warning'),
            (0.95, 'critical')
        ]
        
        for usage_ratio, expected_status in test_cases:
            with patch.object(self.storage_manager, '_get_disk_usage', return_value=usage_ratio):
                status = self.storage_manager.check_storage_status('/test/path')
                self.assertEqual(status, expected_status)
                
    def test_auto_cleanup_trigger(self):
        """æµ‹è¯•è‡ªåŠ¨æ¸…ç†è§¦å‘"""
        # æ¨¡æ‹Ÿå­˜å‚¨ç©ºé—´ä¸è¶³
        with patch.object(self.storage_manager, '_get_disk_usage', return_value=0.92):
            cleanup_triggered = self.storage_manager.check_and_cleanup('/test/path')
            self.assertTrue(cleanup_triggered)
            
    def test_cleanup_file_selection(self):
        """æµ‹è¯•æ¸…ç†æ–‡ä»¶é€‰æ‹©ç­–ç•¥"""
        # åˆ›å»ºæµ‹è¯•æ–‡ä»¶åˆ—è¡¨
        test_files = [
            {'path': '/test/old.mp4', 'age_hours': 48, 'size': 100*1024*1024},
            {'path': '/test/new.mp4', 'age_hours': 1, 'size': 50*1024*1024},
            {'path': '/test/medium.mp4', 'age_hours': 24, 'size': 200*1024*1024}
        ]
        
        cleanup_candidates = self.storage_manager._select_cleanup_candidates(test_files, target_size=150*1024*1024)
        
        # éªŒè¯é€‰æ‹©äº†åˆé€‚çš„æ–‡ä»¶è¿›è¡Œæ¸…ç†
        self.assertGreater(len(cleanup_candidates), 0)
        # éªŒè¯ä¼˜å…ˆé€‰æ‹©è¾ƒè€çš„æ–‡ä»¶
        self.assertIn('/test/old.mp4', [f['path'] for f in cleanup_candidates])
```

**C. ä¼ è¾“ä¼˜åŒ–æœºåˆ¶æµ‹è¯•**

```python
# test_transfer_optimization.py
class TestTransferOptimization(unittest.TestCase):
    """ä¼ è¾“ä¼˜åŒ–æœºåˆ¶æµ‹è¯•å¥—ä»¶"""
    
    def test_network_bandwidth_detection(self):
        """æµ‹è¯•ç½‘ç»œå¸¦å®½æ£€æµ‹"""
        optimizer = RsyncTransferOptimizer()
        
        # æ¨¡æ‹Ÿä¸åŒç½‘ç»œæ¡ä»¶
        with patch.object(optimizer, '_measure_network_speed', return_value=100):  # 100 Mbps
            bandwidth = optimizer.detect_available_bandwidth()
            self.assertGreater(bandwidth, 0)
            
    def test_rsync_parameter_optimization(self):
        """æµ‹è¯•rsyncå‚æ•°ä¼˜åŒ–"""
        optimizer = RsyncTransferOptimizer()
        
        # æµ‹è¯•ä¸åŒæ–‡ä»¶å¤§å°çš„å‚æ•°ä¼˜åŒ–
        small_file_params = optimizer.optimize_rsync_params(file_size=10*1024*1024)  # 10MB
        large_file_params = optimizer.optimize_rsync_params(file_size=1024*1024*1024)  # 1GB
        
        # éªŒè¯å¤§æ–‡ä»¶ä½¿ç”¨æ›´å¤§çš„å—å¤§å°
        self.assertGreater(
            large_file_params['block_size'],
            small_file_params['block_size']
        )
        
    def test_integrity_verification(self):
        """æµ‹è¯•å®Œæ•´æ€§éªŒè¯"""
        validator = EdgeToNasIntegrityValidator()
        
        # åˆ›å»ºæµ‹è¯•æ–‡ä»¶
        with tempfile.NamedTemporaryFile(delete=False) as temp_file:
            test_content = b"test content for integrity check"
            temp_file.write(test_content)
            temp_file_path = temp_file.name
            
        try:
            # è®¡ç®—æ ¡éªŒå’Œ
            checksum1 = validator.calculate_checksum(temp_file_path)
            checksum2 = validator.calculate_checksum(temp_file_path)
            
            # éªŒè¯æ ¡éªŒå’Œä¸€è‡´æ€§
            self.assertEqual(checksum1, checksum2)
            
        finally:
            os.unlink(temp_file_path)
```

#### 2.8.3 æ€§èƒ½æµ‹è¯•è¯¦ç»†è®¡åˆ’

**A. å¹¶å‘ä¼ è¾“æ€§èƒ½æµ‹è¯•**

```python
# performance_test_concurrent_transfer.py
import time
import threading
import statistics
from concurrent.futures import ThreadPoolExecutor

class ConcurrentTransferPerformanceTest:
    """å¹¶å‘ä¼ è¾“æ€§èƒ½æµ‹è¯•"""
    
    def __init__(self, config):
        self.config = config
        self.transfer_manager = NASTransferManager(config)
        self.results = []
        
    def test_concurrent_transfer_throughput(self):
        """æµ‹è¯•å¹¶å‘ä¼ è¾“ååé‡"""
        test_scenarios = [
            {'concurrent_count': 1, 'file_size_mb': 100},
            {'concurrent_count': 3, 'file_size_mb': 100},
            {'concurrent_count': 5, 'file_size_mb': 100},
            {'concurrent_count': 10, 'file_size_mb': 100}
        ]
        
        for scenario in test_scenarios:
            print(f"æµ‹è¯•åœºæ™¯: {scenario['concurrent_count']}ä¸ªå¹¶å‘ä¼ è¾“")
            
            start_time = time.time()
            
            # åˆ›å»ºå¹¶å‘ä¼ è¾“ä»»åŠ¡
            with ThreadPoolExecutor(max_workers=scenario['concurrent_count']) as executor:
                futures = []
                for i in range(scenario['concurrent_count']):
                    task = self._create_performance_test_task(i, scenario['file_size_mb'])
                    future = executor.submit(self._execute_transfer_task, task)
                    futures.append(future)
                    
                # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
                results = [future.result() for future in futures]
                
            end_time = time.time()
            total_time = end_time - start_time
            
            # è®¡ç®—æ€§èƒ½æŒ‡æ ‡
            successful_transfers = sum(1 for r in results if r['success'])
            total_data_mb = scenario['concurrent_count'] * scenario['file_size_mb']
            throughput_mbps = (total_data_mb / total_time) if total_time > 0 else 0
            
            performance_result = {
                'scenario': scenario,
                'total_time': total_time,
                'successful_transfers': successful_transfers,
                'throughput_mbps': throughput_mbps,
                'success_rate': successful_transfers / scenario['concurrent_count']
            }
            
            self.results.append(performance_result)
            print(f"ç»“æœ: ååé‡ {throughput_mbps:.2f} MB/s, æˆåŠŸç‡ {performance_result['success_rate']:.2%}")
            
    def test_network_adaptation_performance(self):
        """æµ‹è¯•ç½‘ç»œè‡ªé€‚åº”æ€§èƒ½"""
        # æ¨¡æ‹Ÿä¸åŒç½‘ç»œæ¡ä»¶
        network_conditions = [
            {'bandwidth_mbps': 10, 'latency_ms': 50, 'packet_loss': 0.01},
            {'bandwidth_mbps': 100, 'latency_ms': 20, 'packet_loss': 0.001},
            {'bandwidth_mbps': 1000, 'latency_ms': 5, 'packet_loss': 0.0001}
        ]
        
        for condition in network_conditions:
            print(f"æµ‹è¯•ç½‘ç»œæ¡ä»¶: {condition}")
            
            # é…ç½®ç½‘ç»œæ¨¡æ‹Ÿ
            self._simulate_network_condition(condition)
            
            # æ‰§è¡Œä¼ è¾“æµ‹è¯•
            start_time = time.time()
            task = self._create_performance_test_task(0, 500)  # 500MBæ–‡ä»¶
            result = self._execute_transfer_task(task)
            end_time = time.time()
            
            # è®°å½•ç»“æœ
            if result['success']:
                transfer_time = end_time - start_time
                effective_throughput = 500 / transfer_time  # MB/s
                efficiency = effective_throughput / condition['bandwidth_mbps']
                
                print(f"ä¼ è¾“æ—¶é—´: {transfer_time:.2f}s, æœ‰æ•ˆååé‡: {effective_throughput:.2f} MB/s, æ•ˆç‡: {efficiency:.2%}")
                
    def generate_performance_report(self):
        """ç”Ÿæˆæ€§èƒ½æµ‹è¯•æŠ¥å‘Š"""
        report = {
            'test_timestamp': time.strftime('%Y-%m-%d %H:%M:%S'),
            'test_results': self.results,
            'performance_summary': {
                'max_throughput_mbps': max(r['throughput_mbps'] for r in self.results),
                'avg_success_rate': statistics.mean(r['success_rate'] for r in self.results),
                'recommended_concurrent_count': self._calculate_optimal_concurrency()
            }
        }
        
        return report
```

#### 2.8.4 é›†æˆæµ‹è¯•è¯¦ç»†è®¡åˆ’

```bash
#!/bin/bash
# integration_test_suite.sh
# ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•å¥—ä»¶

set -e

echo "=== é˜¶æ®µäºŒé›†æˆæµ‹è¯•å¥—ä»¶ ==="
echo "æµ‹è¯•å¼€å§‹æ—¶é—´: $(date)"

# æµ‹è¯•ç¯å¢ƒå‡†å¤‡
echo "1. å‡†å¤‡æµ‹è¯•ç¯å¢ƒ..."
source /home/celestial/dev/esdk-test/Edge-SDK/.venv/bin/activate
cd /home/celestial/dev/esdk-test/Edge-SDK

# åˆ›å»ºæµ‹è¯•æ•°æ®
echo "2. åˆ›å»ºæµ‹è¯•æ•°æ®..."
TEST_DATA_DIR="/tmp/nas_transfer_test_data"
mkdir -p $TEST_DATA_DIR

# ç”Ÿæˆä¸åŒå¤§å°çš„æµ‹è¯•æ–‡ä»¶
dd if=/dev/urandom of="$TEST_DATA_DIR/small_file.mp4" bs=1M count=10  # 10MB
dd if=/dev/urandom of="$TEST_DATA_DIR/medium_file.mp4" bs=1M count=100 # 100MB
dd if=/dev/urandom of="$TEST_DATA_DIR/large_file.mp4" bs=1M count=500  # 500MB

echo "3. æµ‹è¯•NASè¿æ¥..."
ssh nas-edge "echo 'NASè¿æ¥æµ‹è¯•æˆåŠŸ'"

echo "4. æ‰§è¡ŒåŠŸèƒ½æµ‹è¯•..."
python -m pytest celestial_nasops/tests/test_nas_transfer_manager.py -v
python -m pytest celestial_nasops/tests/test_storage_space_manager.py -v
python -m pytest celestial_nasops/tests/test_transfer_optimization.py -v

echo "5. æ‰§è¡Œæ€§èƒ½æµ‹è¯•..."
python celestial_nasops/tests/performance_test_concurrent_transfer.py

echo "6. æ‰§è¡Œç«¯åˆ°ç«¯é›†æˆæµ‹è¯•..."
python celestial_nasops/tests/end_to_end_integration_test.py

echo "7. æ¸…ç†æµ‹è¯•æ•°æ®..."
rm -rf $TEST_DATA_DIR

echo "=== é›†æˆæµ‹è¯•å®Œæˆ ==="
echo "æµ‹è¯•ç»“æŸæ—¶é—´: $(date)"
```

#### 2.8.5 éªŒæ”¶æ ‡å‡†è¯¦ç»†å®šä¹‰

| éªŒæ”¶é¡¹ç›® | æµ‹è¯•æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• | éªŒæ”¶æ ‡å‡† |
|---------|---------|--------|----------|----------|
| **ä¼ è¾“æˆåŠŸç‡** | æ–‡ä»¶ä¼ è¾“æˆåŠŸç‡ | â‰¥ 99.5% | 1000ä¸ªæ–‡ä»¶ä¼ è¾“æµ‹è¯• | æˆåŠŸä¼ è¾“ â‰¥ 995ä¸ªæ–‡ä»¶ |
| **ä¼ è¾“æ€§èƒ½** | å¹³å‡ä¼ è¾“é€Ÿåº¦ | â‰¥ 80% ç½‘ç»œå¸¦å®½åˆ©ç”¨ç‡ | ä¸åŒæ–‡ä»¶å¤§å°æ€§èƒ½æµ‹è¯• | åœ¨100Mbpsç½‘ç»œä¸‹è¾¾åˆ°80Mbps+ |
| **å¹¶å‘å¤„ç†** | æœ€å¤§å¹¶å‘ä¼ è¾“æ•° | â‰¥ 5ä¸ªå¹¶å‘ä»»åŠ¡ | å¹¶å‘ä¼ è¾“å‹åŠ›æµ‹è¯• | 5ä¸ªå¹¶å‘ä»»åŠ¡ç¨³å®šè¿è¡Œ |
| **ç³»ç»Ÿèµ„æº** | CPUä½¿ç”¨ç‡ | â‰¤ 20% | é•¿æ—¶é—´è¿è¡Œç›‘æ§ | å¹³å‡CPUä½¿ç”¨ç‡ä¸è¶…è¿‡20% |
| **å†…å­˜ä½¿ç”¨** | å†…å­˜å ç”¨ | â‰¤ 500MB | å†…å­˜ä½¿ç”¨ç›‘æ§ | ç¨³å®šçŠ¶æ€å†…å­˜å ç”¨ä¸è¶…è¿‡500MB |
| **å­˜å‚¨ç®¡ç†** | è‡ªåŠ¨æ¸…ç†æ•ˆç‡ | é‡Šæ”¾ç©ºé—´ â‰¥ ç›®æ ‡ç©ºé—´çš„90% | å­˜å‚¨ç©ºé—´æ¸…ç†æµ‹è¯• | æ¸…ç†åå¯ç”¨ç©ºé—´è¾¾åˆ°é¢„æœŸ |
| **å‘Šè­¦å“åº”** | å‘Šè­¦å“åº”æ—¶é—´ | â‰¤ 30ç§’ | å‘Šè­¦ç³»ç»Ÿæµ‹è¯• | ä»å¼‚å¸¸å‘ç”Ÿåˆ°å‘Šè­¦å‘å‡ºâ‰¤30ç§’ |
| **æ•…éšœæ¢å¤** | è‡ªåŠ¨æ¢å¤æ—¶é—´ | â‰¤ 5åˆ†é’Ÿ | æ•…éšœæ³¨å…¥æµ‹è¯• | ç½‘ç»œä¸­æ–­å5åˆ†é’Ÿå†…è‡ªåŠ¨æ¢å¤ |
| **æ•°æ®å®Œæ•´æ€§** | æ–‡ä»¶å®Œæ•´æ€§éªŒè¯ | 100% | æ ¡éªŒå’ŒéªŒè¯æµ‹è¯• | æ‰€æœ‰ä¼ è¾“æ–‡ä»¶æ ¡éªŒå’Œä¸€è‡´ |
| **ç³»ç»Ÿç¨³å®šæ€§** | è¿ç»­è¿è¡Œæ—¶é—´ | â‰¥ 7å¤© | é•¿æœŸç¨³å®šæ€§æµ‹è¯• | 7x24å°æ—¶æ— å´©æºƒè¿è¡Œ |

**éªŒæ”¶æµ‹è¯•æ‰§è¡Œæ¸…å•**ï¼š

```bash
#!/bin/bash
# acceptance_test_checklist.sh
# éªŒæ”¶æµ‹è¯•æ‰§è¡Œæ¸…å•

echo "=== é˜¶æ®µäºŒéªŒæ”¶æµ‹è¯•æ¸…å• ==="

# 1. ä¼ è¾“æˆåŠŸç‡æµ‹è¯•
echo "â–¡ 1. ä¼ è¾“æˆåŠŸç‡æµ‹è¯• (ç›®æ ‡: â‰¥99.5%)"
echo "   - å‡†å¤‡1000ä¸ªæµ‹è¯•æ–‡ä»¶"
echo "   - æ‰§è¡Œæ‰¹é‡ä¼ è¾“"
echo "   - ç»Ÿè®¡æˆåŠŸç‡"
echo "   - éªŒè¯: æˆåŠŸä¼ è¾“ â‰¥ 995ä¸ªæ–‡ä»¶"

# 2. æ€§èƒ½åŸºå‡†æµ‹è¯•
echo "â–¡ 2. æ€§èƒ½åŸºå‡†æµ‹è¯• (ç›®æ ‡: â‰¥80%å¸¦å®½åˆ©ç”¨ç‡)"
echo "   - æµ‹è¯•ä¸åŒæ–‡ä»¶å¤§å°ä¼ è¾“é€Ÿåº¦"
echo "   - è®°å½•ç½‘ç»œå¸¦å®½åˆ©ç”¨ç‡"
echo "   - éªŒè¯: è¾¾åˆ°80%+å¸¦å®½åˆ©ç”¨ç‡"

# 3. å¹¶å‘å¤„ç†èƒ½åŠ›æµ‹è¯•
echo "â–¡ 3. å¹¶å‘å¤„ç†èƒ½åŠ›æµ‹è¯• (ç›®æ ‡: â‰¥5ä¸ªå¹¶å‘)"
echo "   - å¯åŠ¨5ä¸ªå¹¶å‘ä¼ è¾“ä»»åŠ¡"
echo "   - ç›‘æ§ç³»ç»Ÿç¨³å®šæ€§"
echo "   - éªŒè¯: 5ä¸ªä»»åŠ¡åŒæ—¶ç¨³å®šè¿è¡Œ"

# 4. ç³»ç»Ÿèµ„æºä½¿ç”¨æµ‹è¯•
echo "â–¡ 4. ç³»ç»Ÿèµ„æºä½¿ç”¨æµ‹è¯• (ç›®æ ‡: CPUâ‰¤20%, å†…å­˜â‰¤500MB)"
echo "   - é•¿æ—¶é—´è¿è¡Œç›‘æ§"
echo "   - è®°å½•CPUå’Œå†…å­˜ä½¿ç”¨æƒ…å†µ"
echo "   - éªŒè¯: èµ„æºä½¿ç”¨åœ¨é™åˆ¶èŒƒå›´å†…"

# 5. å­˜å‚¨ç®¡ç†æ•ˆç‡æµ‹è¯•
echo "â–¡ 5. å­˜å‚¨ç®¡ç†æ•ˆç‡æµ‹è¯• (ç›®æ ‡: â‰¥90%æ¸…ç†æ•ˆç‡)"
echo "   - æ¨¡æ‹Ÿå­˜å‚¨ç©ºé—´ä¸è¶³"
echo "   - è§¦å‘è‡ªåŠ¨æ¸…ç†"
echo "   - éªŒè¯: æ¸…ç†æ•ˆç‡è¾¾åˆ°90%+"

# 6. å‘Šè­¦ç³»ç»Ÿå“åº”æµ‹è¯•
echo "â–¡ 6. å‘Šè­¦ç³»ç»Ÿå“åº”æµ‹è¯• (ç›®æ ‡: â‰¤30ç§’å“åº”)"
echo "   - æ¨¡æ‹Ÿå„ç§å¼‚å¸¸æƒ…å†µ"
echo "   - è®°å½•å‘Šè­¦å“åº”æ—¶é—´"
echo "   - éªŒè¯: å‘Šè­¦å“åº”æ—¶é—´â‰¤30ç§’"

# 7. æ•…éšœæ¢å¤èƒ½åŠ›æµ‹è¯•
echo "â–¡ 7. æ•…éšœæ¢å¤èƒ½åŠ›æµ‹è¯• (ç›®æ ‡: â‰¤5åˆ†é’Ÿæ¢å¤)"
echo "   - æ¨¡æ‹Ÿç½‘ç»œä¸­æ–­"
echo "   - è®°å½•è‡ªåŠ¨æ¢å¤æ—¶é—´"
echo "   - éªŒè¯: 5åˆ†é’Ÿå†…è‡ªåŠ¨æ¢å¤"

# 8. æ•°æ®å®Œæ•´æ€§éªŒè¯æµ‹è¯•
echo "â–¡ 8. æ•°æ®å®Œæ•´æ€§éªŒè¯æµ‹è¯• (ç›®æ ‡: 100%ä¸€è‡´æ€§)"
echo "   - ä¼ è¾“å„ç§ç±»å‹æ–‡ä»¶"
echo "   - è®¡ç®—æºæ–‡ä»¶å’Œç›®æ ‡æ–‡ä»¶æ ¡éªŒå’Œ"
echo "   - éªŒè¯: æ‰€æœ‰æ–‡ä»¶æ ¡éªŒå’Œä¸€è‡´"

# 9. é•¿æœŸç¨³å®šæ€§æµ‹è¯•
echo "â–¡ 9. é•¿æœŸç¨³å®šæ€§æµ‹è¯• (ç›®æ ‡: â‰¥7å¤©è¿ç»­è¿è¡Œ)"
echo "   - å¯åŠ¨ç³»ç»Ÿè¿ç»­è¿è¡Œ"
echo "   - ç›‘æ§ç³»ç»ŸçŠ¶æ€"
echo "   - éªŒè¯: 7x24å°æ—¶æ— å´©æºƒ"

echo "\n=== éªŒæ”¶æµ‹è¯•å®Œæˆåè¯·ç¡®è®¤ ==="
echo "â–¡ æ‰€æœ‰æµ‹è¯•é¡¹ç›®é€šè¿‡"
echo "â–¡ æ€§èƒ½æŒ‡æ ‡è¾¾åˆ°è¦æ±‚"
echo "â–¡ ç³»ç»Ÿç¨³å®šæ€§æ»¡è¶³è¦æ±‚"
echo "â–¡ æ–‡æ¡£å’Œä»£ç å®¡æŸ¥å®Œæˆ"
echo "â–¡ éƒ¨ç½²å’Œè¿ç»´æ–‡æ¡£å°±ç»ª"
```
- **ç«¯åˆ°ç«¯å®Œæ•´æ€§éªŒè¯é€šè¿‡ç‡** = 100%
- **å¤šå±‚æ¬¡æ ¡éªŒä¸€è‡´æ€§** â‰¥ 99.99% (æ–‡ä»¶å¤§å°+MD5+åˆ†å—æ ¡éªŒ)
- **å®Œæ•´æ€§éªŒè¯æ•…éšœæ¢å¤æ—¶é—´** â‰¤ 10ç§’

---

## 3. å®æ–½è®¡åˆ’

### 3.1 é¡¹ç›®å®æ–½è·¯çº¿å›¾

#### 3.1.1 å®æ–½é˜¶æ®µæ€»è§ˆ

| é˜¶æ®µ | æ—¶é—´å‘¨æœŸ | ä¸»è¦ç›®æ ‡ | å…³é”®äº¤ä»˜ç‰© | æˆåŠŸæ ‡å‡† | é£é™©ç­‰çº§ |
|------|---------|---------|-----------|----------|----------|
| **å‡†å¤‡é˜¶æ®µ** | 1å‘¨ | ç¯å¢ƒæ­å»ºä¸åŸºç¡€è®¾æ–½ | å¼€å‘ç¯å¢ƒã€æµ‹è¯•æ•°æ® | ç¯å¢ƒå°±ç»ª | ä½ |
| **æ ¸å¿ƒå¼€å‘** | 3-4å‘¨ | æ ¸å¿ƒåŠŸèƒ½æ¨¡å—å¼€å‘ | ä¼ è¾“ç®¡ç†ã€å­˜å‚¨ç®¡ç† | åŠŸèƒ½å®Œæ•´ | ä¸­ |
| **é›†æˆæµ‹è¯•** | 2å‘¨ | ç³»ç»Ÿé›†æˆä¸æµ‹è¯• | é›†æˆç³»ç»Ÿã€æµ‹è¯•æŠ¥å‘Š | æµ‹è¯•é€šè¿‡ | é«˜ |
| **ä¼˜åŒ–éƒ¨ç½²** | 1å‘¨ | æ€§èƒ½ä¼˜åŒ–ä¸éƒ¨ç½² | ç”Ÿäº§ç³»ç»Ÿã€è¿ç»´æ–‡æ¡£ | ç³»ç»Ÿç¨³å®š | ä¸­ |

#### 3.1.2 è¯¦ç»†å®æ–½è®¡åˆ’

**é˜¶æ®µä¸€ï¼šå‡†å¤‡é˜¶æ®µ (ç¬¬1å‘¨)**

```bash
# ç¯å¢ƒå‡†å¤‡æ¸…å•
#!/bin/bash
# setup_development_environment.sh

echo "=== é˜¶æ®µäºŒå¼€å‘ç¯å¢ƒå‡†å¤‡ ==="

# 1. Pythonç¯å¢ƒé…ç½®
source /home/celestial/dev/esdk-test/Edge-SDK/.venv/bin/activate
pip install -r celestial_nasops/requirements.txt

# 2. æµ‹è¯•ç¯å¢ƒéªŒè¯
ssh nas-edge "mkdir -p /nas/test_data && echo 'NASæµ‹è¯•ç›®å½•åˆ›å»ºæˆåŠŸ'"

# 3. é…ç½®æ–‡ä»¶åˆå§‹åŒ–
cp celestial_nasops/unified_config.json.template celestial_nasops/unified_config.json

# 4. æ—¥å¿—ç›®å½•åˆ›å»º
mkdir -p celestial_nasops/logs/{transfer,storage,monitoring}

# 5. æ•°æ®åº“åˆå§‹åŒ–
python celestial_nasops/scripts/init_database.py

echo "å¼€å‘ç¯å¢ƒå‡†å¤‡å®Œæˆ"
```

**é˜¶æ®µäºŒï¼šæ ¸å¿ƒå¼€å‘é˜¶æ®µ (ç¬¬2-5å‘¨)**

*ç¬¬2å‘¨ï¼šä¼ è¾“ç®¡ç†æ ¸å¿ƒæ¨¡å—*
- [ ] `NASTransferManager` ç±»å®ç°
- [ ] `TransferTaskQueue` ä¼˜å…ˆçº§é˜Ÿåˆ—
- [ ] `RsyncTransferOptimizer` ä¼ è¾“ä¼˜åŒ–
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 90%

*ç¬¬3å‘¨ï¼šå­˜å‚¨ç®¡ç†ä¸ç›‘æ§æ¨¡å—*
- [ ] `StorageSpaceManager` å­˜å‚¨ç›‘æ§
- [ ] `StorageCleanupManager` è‡ªåŠ¨æ¸…ç†
- [ ] `TransferMonitoringSystem` ç›‘æ§ç³»ç»Ÿ
- [ ] é›†æˆæµ‹è¯•æ¡†æ¶æ­å»º

*ç¬¬4å‘¨ï¼šæ™ºèƒ½å‘Šè­¦ä¸å®Œæ•´æ€§éªŒè¯*
- [ ] `IntelligentAlertEngine` å‘Šè­¦å¼•æ“
- [ ] `EdgeToNasIntegrityValidator` å®Œæ•´æ€§éªŒè¯
- [ ] `AdaptiveTransferScheduler` è‡ªé€‚åº”è°ƒåº¦
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•

*ç¬¬5å‘¨ï¼šç³»ç»Ÿé›†æˆä¸ä¼˜åŒ–*
- [ ] `IntegratedServiceManager` æœåŠ¡ç®¡ç†
- [ ] `EnhancedMediaFindingDaemon` é›†æˆä¼˜åŒ–
- [ ] é…ç½®ç®¡ç†ç»Ÿä¸€åŒ–
- [ ] ç«¯åˆ°ç«¯åŠŸèƒ½æµ‹è¯•

**é˜¶æ®µä¸‰ï¼šé›†æˆæµ‹è¯•é˜¶æ®µ (ç¬¬6-7å‘¨)**

```python
# integration_test_schedule.py
# é›†æˆæµ‹è¯•æ—¶é—´è¡¨

test_schedule = {
    'ç¬¬6å‘¨': {
        'å‘¨ä¸€-å‘¨äºŒ': 'åŠŸèƒ½æµ‹è¯•å¥—ä»¶æ‰§è¡Œ',
        'å‘¨ä¸‰-å‘¨å››': 'æ€§èƒ½æµ‹è¯•ä¸ä¼˜åŒ–',
        'å‘¨äº”': 'ç¨³å®šæ€§æµ‹è¯•å¯åŠ¨ï¼ˆ7å¤©ï¼‰'
    },
    'ç¬¬7å‘¨': {
        'å‘¨ä¸€-å‘¨ä¸‰': 'é›†æˆæµ‹è¯•é—®é¢˜ä¿®å¤',
        'å‘¨å››-å‘¨äº”': 'ç”¨æˆ·éªŒæ”¶æµ‹è¯•å‡†å¤‡'
    }
}

# æµ‹è¯•æ‰§è¡Œè„šæœ¬
def execute_integration_tests():
    test_suites = [
        'test_nas_transfer_manager.py',
        'test_storage_space_manager.py', 
        'test_transfer_optimization.py',
        'performance_test_concurrent_transfer.py',
        'end_to_end_integration_test.py'
    ]
    
    for suite in test_suites:
        print(f"æ‰§è¡Œæµ‹è¯•å¥—ä»¶: {suite}")
        # æ‰§è¡Œæµ‹è¯•é€»è¾‘
```

**é˜¶æ®µå››ï¼šä¼˜åŒ–éƒ¨ç½²é˜¶æ®µ (ç¬¬8å‘¨)**

- [ ] ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è„šæœ¬
- [ ] ç›‘æ§å‘Šè­¦é…ç½®
- [ ] è¿ç»´æ–‡æ¡£ç¼–å†™
- [ ] ç”¨æˆ·åŸ¹è®­ææ–™
- [ ] ä¸Šçº¿æ£€æŸ¥æ¸…å•

### 3.2 é£é™©ç®¡ç†ä¸ç¼“è§£ç­–ç•¥

#### 3.2.1 æŠ€æœ¯é£é™©è¯„ä¼°

| é£é™©ç±»åˆ« | é£é™©æè¿° | å½±å“ç¨‹åº¦ | å‘ç”Ÿæ¦‚ç‡ | é£é™©ç­‰çº§ | ç¼“è§£ç­–ç•¥ |
|---------|---------|---------|---------|---------|----------|
| **SDKå…¼å®¹æ€§** | DJI SDKç‰ˆæœ¬å‡çº§å¯¼è‡´æ¥å£å˜æ›´ | é«˜ | ä¸­ | é«˜ | ç‰ˆæœ¬é”å®š+å…¼å®¹æ€§æµ‹è¯• |
| **ç½‘ç»œç¨³å®šæ€§** | ç½‘ç»œä¸­æ–­å½±å“ä¼ è¾“è¿ç»­æ€§ | ä¸­ | é«˜ | é«˜ | å¤šé‡é‡è¯•+é™çº§ç­–ç•¥ |
| **å­˜å‚¨æ€§èƒ½** | å¤§é‡å¹¶å‘I/Oå¯¼è‡´æ€§èƒ½ç“¶é¢ˆ | ä¸­ | ä¸­ | ä¸­ | æ€§èƒ½ç›‘æ§+åŠ¨æ€è°ƒæ•´ |
| **å†…å­˜æ³„æ¼** | é•¿æ—¶é—´è¿è¡Œå¯¼è‡´å†…å­˜æº¢å‡º | é«˜ | ä½ | ä¸­ | å†…å­˜ç›‘æ§+å®šæœŸé‡å¯ |
| **æ•°æ®ä¸€è‡´æ€§** | å¹¶å‘æ“ä½œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ | é«˜ | ä½ | ä¸­ | äº‹åŠ¡æ§åˆ¶+é”æœºåˆ¶ |

#### 3.2.2 ç¼“è§£ç­–ç•¥å®æ–½

**A. SDKå…¼å®¹æ€§é£é™©ç¼“è§£**

```python
# sdk_compatibility_manager.py
class SDKCompatibilityManager:
    """SDKå…¼å®¹æ€§ç®¡ç†å™¨"""
    
    def __init__(self):
        self.supported_versions = ['1.0.0', '1.1.0', '1.2.0']
        self.current_version = self._detect_sdk_version()
        
    def check_compatibility(self):
        """æ£€æŸ¥SDKç‰ˆæœ¬å…¼å®¹æ€§"""
        if self.current_version not in self.supported_versions:
            self._handle_incompatible_version()
            
    def _handle_incompatible_version(self):
        """å¤„ç†ä¸å…¼å®¹ç‰ˆæœ¬"""
        # è®°å½•è­¦å‘Šæ—¥å¿—
        # å°è¯•é™çº§ç­–ç•¥
        # å‘é€å‘Šè­¦é€šçŸ¥
        pass
```

**B. ç½‘ç»œç¨³å®šæ€§é£é™©ç¼“è§£**

```python
# network_resilience_manager.py
class NetworkResilienceManager:
    """ç½‘ç»œå¼¹æ€§ç®¡ç†å™¨"""
    
    def __init__(self, config):
        self.retry_config = config['retry_strategy']
        self.fallback_config = config['fallback_strategy']
        
    def execute_with_retry(self, operation, *args, **kwargs):
        """å¸¦é‡è¯•çš„æ“ä½œæ‰§è¡Œ"""
        max_retries = self.retry_config['max_retries']
        base_delay = self.retry_config['base_delay']
        
        for attempt in range(max_retries + 1):
            try:
                return operation(*args, **kwargs)
            except NetworkError as e:
                if attempt == max_retries:
                    return self._execute_fallback_strategy(operation, *args, **kwargs)
                    
                delay = base_delay * (2 ** attempt)  # æŒ‡æ•°é€€é¿
                time.sleep(delay)
                
    def _execute_fallback_strategy(self, operation, *args, **kwargs):
        """æ‰§è¡Œé™çº§ç­–ç•¥"""
        # é™ä½ä¼ è¾“é€Ÿåº¦
        # å‡å°‘å¹¶å‘æ•°
        # å¯ç”¨å‹ç¼©ä¼ è¾“
        pass
```

### 3.3 è´¨é‡ä¿è¯ä½“ç³»

#### 3.3.1 ä»£ç è´¨é‡æ ‡å‡†

```python
# quality_assurance_config.py
QUALITY_STANDARDS = {
    'code_coverage': {
        'unit_tests': 0.90,      # å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 90%
        'integration_tests': 0.80, # é›†æˆæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
        'e2e_tests': 0.70        # ç«¯åˆ°ç«¯æµ‹è¯•è¦†ç›–ç‡ â‰¥ 70%
    },
    'code_quality': {
        'pylint_score': 8.5,     # Pylintè¯„åˆ† â‰¥ 8.5
        'complexity_threshold': 10, # åœˆå¤æ‚åº¦ â‰¤ 10
        'duplication_ratio': 0.05   # ä»£ç é‡å¤ç‡ â‰¤ 5%
    },
    'performance_standards': {
        'response_time_p95': 2.0,    # 95%å“åº”æ—¶é—´ â‰¤ 2ç§’
        'throughput_min': 50,        # æœ€å°ååé‡ â‰¥ 50MB/s
        'error_rate_max': 0.01       # é”™è¯¯ç‡ â‰¤ 1%
    }
}
```

#### 3.3.2 æŒç»­é›†æˆæµæ°´çº¿

```bash
#!/bin/bash
# ci_pipeline.sh
# æŒç»­é›†æˆæµæ°´çº¿

set -e

echo "=== æŒç»­é›†æˆæµæ°´çº¿å¯åŠ¨ ==="

# 1. ä»£ç è´¨é‡æ£€æŸ¥
echo "1. æ‰§è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
pylint celestial_nasops/ --rcfile=.pylintrc
flake8 celestial_nasops/ --config=.flake8

# 2. å•å…ƒæµ‹è¯•
echo "2. æ‰§è¡Œå•å…ƒæµ‹è¯•..."
python -m pytest celestial_nasops/tests/unit/ -v --cov=celestial_nasops --cov-report=html

# 3. é›†æˆæµ‹è¯•
echo "3. æ‰§è¡Œé›†æˆæµ‹è¯•..."
python -m pytest celestial_nasops/tests/integration/ -v

# 4. æ€§èƒ½æµ‹è¯•
echo "4. æ‰§è¡Œæ€§èƒ½æµ‹è¯•..."
python celestial_nasops/tests/performance/benchmark_suite.py

# 5. å®‰å…¨æ‰«æ
echo "5. æ‰§è¡Œå®‰å…¨æ‰«æ..."
bandit -r celestial_nasops/ -f json -o security_report.json

# 6. æ„å»ºéƒ¨ç½²åŒ…
echo "6. æ„å»ºéƒ¨ç½²åŒ…..."
python setup.py sdist bdist_wheel

echo "=== æŒç»­é›†æˆæµæ°´çº¿å®Œæˆ ==="
```

### 3.4 æˆåŠŸæŒ‡æ ‡ä¸éªŒæ”¶æ ‡å‡†

#### 3.4.1 å…³é”®æ€§èƒ½æŒ‡æ ‡ (KPI)

| æŒ‡æ ‡ç±»åˆ« | æŒ‡æ ‡åç§° | å½“å‰åŸºçº¿ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• | éªŒæ”¶æ ‡å‡† |
|---------|---------|---------|--------|----------|----------|
| **ä¼ è¾“æ€§èƒ½** | æ–‡ä»¶ä¼ è¾“æˆåŠŸç‡ | 85% | â‰¥ 99.5% | ç»Ÿè®¡åˆ†æ | 1000æ¬¡ä¼ è¾“ä¸­â‰¥995æ¬¡æˆåŠŸ |
| **ä¼ è¾“æ€§èƒ½** | å¹³å‡ä¼ è¾“é€Ÿåº¦ | 30MB/s | â‰¥ 80MB/s | æ€§èƒ½ç›‘æ§ | 100Mbpsç½‘ç»œä¸‹è¾¾åˆ°80%åˆ©ç”¨ç‡ |
| **ç³»ç»Ÿèµ„æº** | CPUä½¿ç”¨ç‡ | 35% | â‰¤ 20% | ç³»ç»Ÿç›‘æ§ | é•¿æœŸè¿è¡Œå¹³å‡CPUâ‰¤20% |
| **ç³»ç»Ÿèµ„æº** | å†…å­˜å ç”¨ | 800MB | â‰¤ 500MB | å†…å­˜ç›‘æ§ | ç¨³å®šçŠ¶æ€å†…å­˜â‰¤500MB |
| **å¯é æ€§** | ç³»ç»Ÿå¯ç”¨æ€§ | 95% | â‰¥ 99.5% | å¯ç”¨æ€§ç›‘æ§ | æœˆåº¦å¯ç”¨æ€§â‰¥99.5% |
| **å“åº”æ€§** | æ•…éšœæ¢å¤æ—¶é—´ | 10åˆ†é’Ÿ | â‰¤ 5åˆ†é’Ÿ | æ•…éšœæ¼”ç»ƒ | ç½‘ç»œä¸­æ–­å5åˆ†é’Ÿå†…æ¢å¤ |

#### 3.4.2 ä¸šåŠ¡ä»·å€¼æŒ‡æ ‡

```python
# business_value_metrics.py
class BusinessValueMetrics:
    """ä¸šåŠ¡ä»·å€¼æŒ‡æ ‡è®¡ç®—å™¨"""
    
    def calculate_improvement_metrics(self, before_stats, after_stats):
        """è®¡ç®—æ”¹è¿›æŒ‡æ ‡"""
        improvements = {
            'transfer_success_rate_improvement': (
                after_stats['success_rate'] - before_stats['success_rate']
            ) / before_stats['success_rate'],
            
            'system_efficiency_improvement': (
                after_stats['throughput'] - before_stats['throughput']
            ) / before_stats['throughput'],
            
            'operational_cost_reduction': (
                before_stats['manual_intervention_hours'] - after_stats['manual_intervention_hours']
            ) / before_stats['manual_intervention_hours'],
            
            'storage_utilization_improvement': (
                after_stats['storage_efficiency'] - before_stats['storage_efficiency']
            ) / before_stats['storage_efficiency']
        }
        
        return improvements
        
    def generate_roi_report(self, improvements, implementation_cost):
        """ç”ŸæˆROIæŠ¥å‘Š"""
        # è®¡ç®—æŠ•èµ„å›æŠ¥ç‡
        # ç”Ÿæˆä¸šåŠ¡ä»·å€¼æŠ¥å‘Š
        pass
```

#### 3.4.3 éªŒæ”¶æµ‹è¯•æ‰§è¡Œè®¡åˆ’

```bash
#!/bin/bash
# acceptance_test_execution_plan.sh
# éªŒæ”¶æµ‹è¯•æ‰§è¡Œè®¡åˆ’

echo "=== éªŒæ”¶æµ‹è¯•æ‰§è¡Œè®¡åˆ’ ==="

# ç¬¬1å¤©ï¼šåŠŸèƒ½éªŒæ”¶æµ‹è¯•
echo "ç¬¬1å¤©ï¼šåŠŸèƒ½éªŒæ”¶æµ‹è¯•"
echo "- 09:00-12:00: ä¼ è¾“ç®¡ç†åŠŸèƒ½æµ‹è¯•"
echo "- 14:00-17:00: å­˜å‚¨ç®¡ç†åŠŸèƒ½æµ‹è¯•"
echo "- 19:00-21:00: ç›‘æ§å‘Šè­¦åŠŸèƒ½æµ‹è¯•"

# ç¬¬2å¤©ï¼šæ€§èƒ½éªŒæ”¶æµ‹è¯•
echo "ç¬¬2å¤©ï¼šæ€§èƒ½éªŒæ”¶æµ‹è¯•"
echo "- 09:00-12:00: å¹¶å‘ä¼ è¾“æ€§èƒ½æµ‹è¯•"
echo "- 14:00-17:00: å¤§æ–‡ä»¶ä¼ è¾“æ€§èƒ½æµ‹è¯•"
echo "- 19:00-21:00: ç³»ç»Ÿèµ„æºä½¿ç”¨æµ‹è¯•"

# ç¬¬3å¤©ï¼šç¨³å®šæ€§éªŒæ”¶æµ‹è¯•
echo "ç¬¬3å¤©ï¼šç¨³å®šæ€§éªŒæ”¶æµ‹è¯•"
echo "- 09:00: å¯åŠ¨7x24å°æ—¶ç¨³å®šæ€§æµ‹è¯•"
echo "- å…¨å¤©: ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€"

# ç¬¬4-10å¤©ï¼šé•¿æœŸç¨³å®šæ€§æµ‹è¯•
echo "ç¬¬4-10å¤©ï¼šé•¿æœŸç¨³å®šæ€§æµ‹è¯•"
echo "- æŒç»­ç›‘æ§ç³»ç»Ÿè¿è¡Œ"
echo "- è®°å½•æ€§èƒ½æŒ‡æ ‡"
echo "- æ•…éšœæ³¨å…¥æµ‹è¯•"

# ç¬¬11å¤©ï¼šéªŒæ”¶æŠ¥å‘Š
echo "ç¬¬11å¤©ï¼šéªŒæ”¶æŠ¥å‘Š"
echo "- 09:00-12:00: æµ‹è¯•ç»“æœåˆ†æ"
echo "- 14:00-17:00: éªŒæ”¶æŠ¥å‘Šç¼–å†™"
echo "- 19:00-21:00: éªŒæ”¶ä¼šè®®"
```

---

## é™„å½•ï¼šå½“å‰ç³»ç»Ÿæ¶æ„åˆ†æä¸æµ‹è¯•æ–¹æ¡ˆ

### A.1 ä¼ è¾“æ–¹å¼æ¶æ„åˆ†æ

#### A.1.1 ä¸¤é˜¶æ®µä¼ è¾“æ¶æ„å¯¹æ¯”

**é˜¶æ®µä¸€ï¼šDock â†’ EdgeæœåŠ¡å™¨**
- **ä¼ è¾“åè®®**: DJI Edge SDKä¸“æœ‰åè®®ï¼ˆérsyncï¼‰
- **æŠ€æœ¯é™åˆ¶**: 
  - å¿…é¡»ä½¿ç”¨SDKæä¾›çš„`MediaFilesReader`æ¥å£
  - æ— æ³•ç›´æ¥ä½¿ç”¨rsyncç­‰æ ‡å‡†æ–‡ä»¶ä¼ è¾“åè®®
  - SDKå°è£…äº†åº•å±‚é€šä¿¡åè®®ï¼Œåº”ç”¨å±‚æ— æ³•æ§åˆ¶
- **å®Œæ•´æ€§éªŒè¯**: SDKä¸æä¾›å“ˆå¸Œå€¼ï¼Œéœ€è¦åº”ç”¨å±‚å®ç°
- **ä¸­æ–­å¤„ç†**: SDKå±‚é¢æ— æ–­ç‚¹ç»­ä¼ ï¼Œéœ€è¦è‡ªè¡Œå®ç°

**é˜¶æ®µäºŒï¼šEdgeæœåŠ¡å™¨ â†’ NASå­˜å‚¨**
- **ä¼ è¾“åè®®**: rsyncï¼ˆæ ‡å‡†æ–‡ä»¶åŒæ­¥åè®®ï¼‰
- **æŠ€æœ¯ä¼˜åŠ¿**:
  - rsyncå†…ç½®å¢é‡ä¼ è¾“å’Œæ ¡éªŒæœºåˆ¶
  - æ”¯æŒæ–­ç‚¹ç»­ä¼ å’Œç½‘ç»œä¸­æ–­æ¢å¤
  - æä¾›å¤šç§æ ¡éªŒç®—æ³•ï¼ˆé»˜è®¤ä½¿ç”¨rolling checksum + MD5ï¼‰
- **ä¸ºä»€ä¹ˆä»éœ€åˆ†å—æ ¡éªŒ**:
  - **ä¼ è¾“å‰éªŒè¯**: ç¡®ä¿Edgeç«¯æ–‡ä»¶å®Œæ•´æ€§ï¼ˆæ¥è‡ªDockçš„æ–‡ä»¶å¯èƒ½å·²æŸåï¼‰
  - **å¤šå±‚é˜²æŠ¤**: rsyncæ ¡éªŒ + åº”ç”¨å±‚æ ¡éªŒï¼ŒåŒé‡ä¿éšœ
  - **æ•…éšœè¯Šæ–­**: åˆ†å—æ ¡éªŒå¯ç²¾ç¡®å®šä½æŸåä½ç½®
  - **æ€§èƒ½ç›‘æ§**: åˆ†å—ä¼ è¾“å¯æä¾›è¯¦ç»†çš„ä¼ è¾“è¿›åº¦å’Œæ€§èƒ½æŒ‡æ ‡

#### A.1.2 ä¸ºä»€ä¹ˆDockåˆ°Edgeä¸èƒ½ä½¿ç”¨rsync

1. **åè®®å°è£…é™åˆ¶**
   ```cpp
   // DJI SDKå¼ºåˆ¶ä½¿ç”¨ä¸“æœ‰æ¥å£
   auto media_file_reader = media_manager->CreateMediaFilesReader();
   auto fd = media_file_reader->open(media_file.file_path);
   auto nread = media_file_reader->Read(fd, buf, sizeof(buf));
   ```

2. **ç½‘ç»œæ¶æ„é™åˆ¶**
   - Dockè®¾å¤‡è¿è¡ŒDJIå›ºä»¶ï¼Œä¸æ”¯æŒæ ‡å‡†SSH/rsyncæœåŠ¡
   - é€šä¿¡åŸºäºDJIä¸“æœ‰åè®®æ ˆï¼Œæ— æ³•ç»•è¿‡SDK
   - å®‰å…¨è®¤è¯æœºåˆ¶ä¸æ ‡å‡†Linuxå·¥å…·ä¸å…¼å®¹

3. **è®¾å¤‡è®¿é—®é™åˆ¶**
   - Dockä½œä¸ºåµŒå…¥å¼è®¾å¤‡ï¼Œä¸æä¾›shellè®¿é—®
   - æ–‡ä»¶ç³»ç»Ÿè®¿é—®å®Œå…¨é€šè¿‡SDKæ¥å£æ§åˆ¶
   - æ— æ³•å®‰è£…æˆ–è¿è¡Œç¬¬ä¸‰æ–¹ä¼ è¾“å·¥å…·

### A.2 å½“å‰ç³»ç»Ÿå·¥ä½œæœºåˆ¶åˆ†æ

#### A.2.1 æ–‡ä»¶å‘ç°æœºåˆ¶
åŸºäºå¯¹ `dock_info_manager.cc` çš„åˆ†æï¼Œå½“å‰ç³»ç»Ÿé‡‡ç”¨**è¢«åŠ¨ç›‘å¬**æ¨¡å¼ï¼š

```cpp
// æ³¨å†Œåª’ä½“æ–‡ä»¶æ›´æ–°å›è°ƒ - è¢«åŠ¨æ¥æ”¶é€šçŸ¥
auto rc = media_manager->RegisterMediaFilesObserver(OnMediaFileUpdate);
```

**å·¥ä½œæµç¨‹**ï¼š
1. **SDKä¸»åŠ¨é€šçŸ¥**: DJI Edge SDK æ£€æµ‹åˆ°Dockä¸Šæ–°æ–‡ä»¶æ—¶ï¼Œä¸»åŠ¨è°ƒç”¨ `OnMediaFileUpdate` å›è°ƒ
2. **æ–‡ä»¶ä¿¡æ¯ä¼ é€’**: SDKä¼ é€’ `MediaFile` ç»“æ„ä½“ï¼ŒåŒ…å«ï¼š
   - `file_path`: æ–‡ä»¶åœ¨Dockä¸Šçš„è·¯å¾„æ ‡è¯†
   - `file_name`: æ–‡ä»¶å
   - `file_size`: æ–‡ä»¶å¤§å°
   - `create_time`: åˆ›å»ºæ—¶é—´
   - `file_type`: æ–‡ä»¶ç±»å‹

3. **ä¸‹è½½æœºåˆ¶**: é€šè¿‡SDKçš„ `MediaFilesReader` æ¥å£è¯»å–æ–‡ä»¶å†…å®¹ï¼š
   ```cpp
   auto fd = reader->Open(file.file_path);  // æ‰“å¼€è¿œç¨‹æ–‡ä»¶
   auto nread = reader->Read(fd, buf, sizeof(buf));  // è¯»å–æ•°æ®å—
   ```

**å…³é”®å‘ç°**ï¼š
- ç³»ç»Ÿ**ä¸æ˜¯ä¸»åŠ¨æ‰«æ**Dockæ–‡ä»¶ï¼Œè€Œæ˜¯**è¢«åŠ¨æ¥æ”¶SDKé€šçŸ¥**
- `file_path` æ˜¯SDKå†…éƒ¨çš„æ–‡ä»¶æ ‡è¯†ç¬¦ï¼Œä¸æ˜¯å®é™…æ–‡ä»¶ç³»ç»Ÿè·¯å¾„
- ä¸‹è½½è¿‡ç¨‹é€šè¿‡SDKå°è£…çš„è¯»å–æ¥å£ï¼Œæ— æ³•ç›´æ¥æ§åˆ¶ç½‘ç»œä¼ è¾“

#### A.1.2 æ–‡ä»¶å®Œæ•´æ€§éªŒè¯ç°çŠ¶
**é‡è¦å‘ç°**ï¼šé€šè¿‡åˆ†æDJI Edge SDKçš„ `MediaFile` ç»“æ„ä½“å’Œå®˜æ–¹æ–‡æ¡£ï¼Œç¡®è®¤ï¼š
1. **æ— å“ˆå¸Œå€¼æä¾›**ï¼š`MediaFile` ç»“æ„ä½“ä¸åŒ…å«MD5ã€SHA256ç­‰å“ˆå¸Œå­—æ®µ
2. **ä»…æœ‰æ–‡ä»¶å¤§å°**ï¼šåªèƒ½é€šè¿‡ `file_size` å­—æ®µè¿›è¡ŒåŸºç¡€å®Œæ•´æ€§æ£€æŸ¥
3. **æ— æ ¡éªŒå’Œæœºåˆ¶**ï¼šSDKå±‚é¢æœªæä¾›ä»»ä½•æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒåŠŸèƒ½
4. **å®Œæ•´æ€§éªŒè¯æŒ‘æˆ˜**ï¼šéœ€è¦åœ¨åº”ç”¨å±‚å®ç°è‡ªå®šä¹‰çš„å®Œæ•´æ€§éªŒè¯æœºåˆ¶

#### A.1.3 å½“å‰ä¸‹è½½æµç¨‹é—®é¢˜
```cpp
do {
    auto nread = reader->Read(fd, buf, sizeof(buf));  // 1MBç¼“å†²åŒº
    if (nread > 0) {
        image.insert(image.end(), (uint8_t*)buf, (uint8_t*)(buf + nread));
    } else {
        reader->Close(fd);
        break;
    }
} while (1);
```

**æ ¸å¿ƒé—®é¢˜**ï¼š
- **å†…å­˜ç´¯ç§¯**: æ‰€æœ‰æ•°æ®å…ˆåŠ è½½åˆ°å†…å­˜ `vector<uint8_t> image`
- **åŒæ­¥é˜»å¡**: æ•´ä¸ªä¸‹è½½è¿‡ç¨‹é˜»å¡ä¸»çº¿ç¨‹
- **æ— ä¸­æ–­å¤„ç†**: ç½‘ç»œä¸­æ–­æ—¶æ— æ³•æ¢å¤
- **æ— è¿›åº¦ç›‘æ§**: æ— æ³•è·çŸ¥ä¸‹è½½è¿›åº¦
- **æ— å®Œæ•´æ€§éªŒè¯**: ä»…ä¾èµ–æ–‡ä»¶å¤§å°åˆ¤æ–­ï¼Œæ— æ³•æ£€æµ‹æ•°æ®æŸåæˆ–ä¼ è¾“é”™è¯¯

### A.2 æ— Dockç¯å¢ƒæµ‹è¯•æ–¹æ¡ˆ

#### A.2.1 æ¨¡æ‹Ÿæµ‹è¯•æ¶æ„
ç”±äºå½“å‰ç³»ç»Ÿä¾èµ–DJI SDKçš„å›è°ƒæœºåˆ¶ï¼Œæ— æ³•ç›´æ¥æ¨¡æ‹ŸDockç¯å¢ƒã€‚å»ºè®®é‡‡ç”¨**åˆ†å±‚æµ‹è¯•**æ–¹æ¡ˆï¼š

**æ–¹æ¡ˆä¸€ï¼šå•å…ƒæµ‹è¯•ï¼ˆæ¨èï¼‰**
```cpp
// åˆ›å»ºæµ‹è¯•ç”¨çš„å¤§æ–‡ä»¶ä¸‹è½½æ¨¡å—
class TestableFileDownloader {
public:
    // æ¨¡æ‹ŸSDKçš„æ–‡ä»¶è¯»å–æ¥å£
    class MockMediaReader {
    public:
        int Open(const std::string& file_path) {
            // æ‰“å¼€æœ¬åœ°å¤§æ–‡ä»¶è¿›è¡Œæ¨¡æ‹Ÿ
            test_file_ = fopen(file_path.c_str(), "rb");
            return test_file_ ? 1 : -1;
        }
        
        int Read(int fd, char* buf, size_t size) {
            // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿå’Œä¸­æ–­
            if (simulate_network_failure_) {
                return -1;  // æ¨¡æ‹Ÿç½‘ç»œä¸­æ–­
            }
            
            // æ¨¡æ‹Ÿå®Œæ•´æ€§é—®é¢˜
            if (simulate_integrity_issues_) {
                return SimulateIntegrityIssue(buf, size);
            }
            
            return fread(buf, 1, size, test_file_);
        }
        
        void Close(int fd) {
            if (test_file_) fclose(test_file_);
        }
        
        // æ¨¡æ‹Ÿç½‘ç»œä¸­æ–­
        void SimulateNetworkInterruption(int after_bytes) {
            interruption_point_ = after_bytes;
            simulate_network_failure_ = true;
        }
        
        // æ¨¡æ‹Ÿæ…¢é€Ÿç½‘ç»œ
        void SimulateSlowNetwork(int bytes_per_second) {
            slow_network_speed_ = bytes_per_second;
        }
        
        // æ¨¡æ‹Ÿæ–‡ä»¶æŸå
        void SimulateFileCorruption(int at_position) {
            corruption_position_ = at_position;
            simulate_integrity_issues_ = true;
        }
        
    private:
        FILE* test_file_ = nullptr;
        bool simulate_network_failure_ = false;
        bool simulate_integrity_issues_ = false;
        int interruption_point_ = -1;
        int slow_network_speed_ = -1;
        int corruption_position_ = -1;
        
        int SimulateIntegrityIssue(char* buf, size_t size) {
            int bytes_read = fread(buf, 1, size, test_file_);
            
            // åœ¨æŒ‡å®šä½ç½®æ³¨å…¥é”™è¯¯æ•°æ®
            if (corruption_position_ >= 0 && corruption_position_ < bytes_read) {
                buf[corruption_position_] = ~buf[corruption_position_]; // ç¿»è½¬å­—èŠ‚
            }
            
            return bytes_read;
        }
    };
};
```

**æ–¹æ¡ˆäºŒï¼šé›†æˆæµ‹è¯•**
```bash
# 1. åˆ›å»ºæµ‹è¯•å¤§æ–‡ä»¶
dd if=/dev/zero of=/tmp/test_large_file.mp4 bs=1M count=100  # 100MBæµ‹è¯•æ–‡ä»¶

# 2. ä¿®æ”¹æµ‹è¯•ç‰ˆæœ¬çš„dock_info_manager
# ç»•è¿‡SDKåˆå§‹åŒ–ï¼Œç›´æ¥è°ƒç”¨æ–‡ä»¶å¤„ç†é€»è¾‘
```

#### A.2.2 æµ‹è¯•ç”¨ä¾‹è®¾è®¡

**æµ‹è¯•åœºæ™¯1ï¼šå¤§æ–‡ä»¶å†…å­˜æ§åˆ¶æµ‹è¯•**
```cpp
void TestLargeFileMemoryUsage() {
    // åˆ›å»º500MBæµ‹è¯•æ–‡ä»¶
    CreateTestFile("/tmp/large_test.mp4", 500 * 1024 * 1024);
    
    // ç›‘æ§å†…å­˜ä½¿ç”¨
    MemoryMonitor monitor;
    monitor.Start();
    
    // æ‰§è¡Œä¸‹è½½
    TestableFileDownloader downloader;
    downloader.DownloadFile("/tmp/large_test.mp4");
    
    // éªŒè¯å†…å­˜å³°å€¼ä¸è¶…è¿‡100MB
    ASSERT_LT(monitor.GetPeakMemoryUsage(), 100 * 1024 * 1024);
}
```

**æµ‹è¯•åœºæ™¯2ï¼šç½‘ç»œä¸­æ–­æ¢å¤æµ‹è¯•**
```cpp
void TestNetworkInterruptionRecovery() {
    MockMediaReader reader;
    reader.SimulateNetworkInterruption(50 * 1024 * 1024);  // åœ¨50MBå¤„æ¨¡æ‹Ÿä¸­æ–­
    
    auto result = DownloadWithRecovery(reader, "test_file.mp4");
    
    ASSERT_TRUE(result.success);
    ASSERT_EQ(result.resume_count, 1);  // éªŒè¯æ¢å¤äº†1æ¬¡
}
```

**æµ‹è¯•åœºæ™¯3ï¼šå®Œæ•´æ€§éªŒè¯æµ‹è¯•**
```cpp
void TestFileIntegrityValidation() {
    // æµ‹è¯•æ–‡ä»¶å¤§å°ä¸åŒ¹é…
    {
        MockMediaReader reader;
        reader.SimulateFileCorruption(1024);  // åœ¨1KBå¤„æŸåæ•°æ®
        
        auto result = DownloadWithIntegrityCheck(reader, "test_file.mp4");
        
        ASSERT_FALSE(result.success);
        ASSERT_EQ(result.error_type, IntegrityError::CHECKSUM_MISMATCH);
    }
    
    // æµ‹è¯•MD5æ ¡éªŒå¤±è´¥
    {
        TestableFileDownloader downloader;
        auto original_md5 = downloader.CalculateFileMD5("/tmp/original.mp4");
        
        // ä¸‹è½½å¹¶éªŒè¯
        auto result = downloader.DownloadWithVerification("/tmp/original.mp4", "/tmp/downloaded.mp4");
        auto downloaded_md5 = downloader.CalculateFileMD5("/tmp/downloaded.mp4");
        
        ASSERT_TRUE(result.success);
        ASSERT_EQ(original_md5, downloaded_md5);
    }
    
    // æµ‹è¯•åˆ†å—æ ¡éªŒ
    {
        ChunkedTransferManager manager;
        auto result = manager.DownloadWithChunkValidation("large_file.mp4");
        
        ASSERT_TRUE(result.success);
        ASSERT_EQ(result.failed_chunks.size(), 0);  // æ— å¤±è´¥åˆ†å—
        ASSERT_TRUE(result.integrity_verified);     // å®Œæ•´æ€§éªŒè¯é€šè¿‡
    }
}
```

**æµ‹è¯•åœºæ™¯4ï¼šå­˜å‚¨ç©ºé—´ç®¡ç†æµ‹è¯•**
```cpp
void TestStorageSpaceManagement() {
    StorageSpaceManager space_manager;
    
    // æ¨¡æ‹Ÿå­˜å‚¨ç©ºé—´ä¸è¶³
    space_manager.SetAvailableSpace(10 * 1024 * 1024);  // 10MBå¯ç”¨ç©ºé—´
    
    MediaFile large_file;
    large_file.file_size = 50 * 1024 * 1024;  // 50MBæ–‡ä»¶
    
    auto can_download = space_manager.CheckSpaceAvailability(large_file);
    ASSERT_FALSE(can_download.sufficient);
    ASSERT_EQ(can_download.required_space, 50 * 1024 * 1024);
    ASSERT_EQ(can_download.available_space, 10 * 1024 * 1024);
}
```

### A.3 æ–°ä»£ç æ¶æ„è®¾è®¡

#### A.3.1 æ–°å¢ç»„ä»¶
è®¡åˆ’ä¸­å°†æ–°å¢ä»¥ä¸‹ç‹¬ç«‹ç»„ä»¶ï¼š

**1. åˆ†å—ä¼ è¾“ç®¡ç†å™¨** (`ChunkedTransferManager`)
```cpp
class ChunkedTransferManager {
public:
    // æ›¿ä»£å½“å‰çš„åŒæ­¥ä¸‹è½½é€»è¾‘
    ErrorCode StartChunkedDownload(const MediaFile& file);
    ErrorCode ResumeDownload(const std::string& file_path);
    
private:
    std::unique_ptr<TransferStatusDB> status_db_;
    std::thread download_thread_;
};
```

**2. ä¼ è¾“çŠ¶æ€æ•°æ®åº“** (`TransferStatusDB`)
```cpp
class TransferStatusDB {
public:
    bool SaveChunkProgress(const std::string& file_path, int chunk_id, bool completed);
    std::vector<int> GetIncompleteChunks(const std::string& file_path);
    bool SetFileStatus(const std::string& file_path, TransferStatus status);
};
```

**3. ç³»ç»Ÿæ¢å¤ç®¡ç†å™¨** (`SystemRecoveryManager`)
```cpp
class SystemRecoveryManager {
public:
    // ç³»ç»Ÿå¯åŠ¨æ—¶æ¢å¤æœªå®Œæˆçš„ä¸‹è½½
    void RecoverIncompleteTransfers();
    
    // æ£€æµ‹åƒµå°¸ä»»åŠ¡
    void DetectAndResetStuckTasks();
};
```

#### A.3.2 ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ
**é›†æˆæ–¹å¼**ï¼š
- **ä¿æŒç°æœ‰å›è°ƒ**: ç»§ç»­ä½¿ç”¨ `OnMediaFileUpdate` ä½œä¸ºå…¥å£
- **æ›¿æ¢ä¸‹è½½é€»è¾‘**: å°†å½“å‰çš„åŒæ­¥ä¸‹è½½æ›¿æ¢ä¸ºåˆ†å—å¼‚æ­¥ä¸‹è½½
- **æ•°æ®åº“æ‰©å±•**: æ‰©å±•ç°æœ‰çš„ `MediaStatusDB` æ”¯æŒåˆ†å—çŠ¶æ€

```cpp
// ä¿®æ”¹åçš„OnMediaFileUpdate
edge_sdk::ErrorCode OnMediaFileUpdate(const edge_sdk::MediaFile& file) {
    INFO("åª’ä½“æ–‡ä»¶æ›´æ–°é€šçŸ¥: %s", file.file_name.c_str());
    
    // è®°å½•åˆ°æ•°æ®åº“
    if (g_media_db && !g_media_db->FileExists(file.file_path)) {
        g_media_db->InsertMediaFile(file.file_path, file.file_name, file.file_size);
    }
    
    // ä½¿ç”¨æ–°çš„åˆ†å—ä¼ è¾“ç®¡ç†å™¨
    if (g_chunked_transfer_manager) {
        return g_chunked_transfer_manager->StartChunkedDownload(file);
    }
    
    return edge_sdk::ErrorCode::kOk;
}
```

#### A.3.3 è¿›ç¨‹æ¶æ„
**å•è¿›ç¨‹å¤šçº¿ç¨‹è®¾è®¡**ï¼š
- **ä¸»çº¿ç¨‹**: ç»§ç»­å¤„ç†SDKå›è°ƒå’Œç³»ç»Ÿç›‘æ§
- **ä¸‹è½½çº¿ç¨‹æ± **: å¤„ç†å¹¶å‘çš„åˆ†å—ä¸‹è½½ä»»åŠ¡
- **ç›‘æ§çº¿ç¨‹**: å¿ƒè·³æ£€æµ‹å’Œæ¢å¤ç®¡ç†
- **æ•°æ®åº“çº¿ç¨‹**: å¼‚æ­¥æ•°æ®åº“æ“ä½œ

```cpp
class DockInfoManager {
private:
    std::thread main_monitor_thread_;           // ä¸»ç›‘æ§çº¿ç¨‹
    ThreadPool download_thread_pool_;           // ä¸‹è½½çº¿ç¨‹æ± 
    std::thread recovery_monitor_thread_;       // æ¢å¤ç›‘æ§çº¿ç¨‹
    std::thread db_maintenance_thread_;         // æ•°æ®åº“ç»´æŠ¤çº¿ç¨‹
};
```

### A.4 æµ‹è¯•æ‰§è¡Œè®¡åˆ’

#### A.4.1 å¼€å‘ç¯å¢ƒæµ‹è¯•
```bash
# 1. ç¼–è¯‘æµ‹è¯•ç‰ˆæœ¬
make test_version

# 2. åˆ›å»ºæµ‹è¯•æ–‡ä»¶
./create_test_files.sh  # åˆ›å»ºä¸åŒå¤§å°çš„æµ‹è¯•æ–‡ä»¶

# 3. è¿è¡Œå•å…ƒæµ‹è¯•
./run_unit_tests.sh

# 4. è¿è¡Œé›†æˆæµ‹è¯•
./run_integration_tests.sh
```

#### A.4.2 ç”Ÿäº§ç¯å¢ƒéªŒè¯
```bash
# 1. éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
./deploy_test_version.sh

# 2. ç›‘æ§ç³»ç»ŸæŒ‡æ ‡
./monitor_system_metrics.sh

# 3. éªŒè¯æ¢å¤æœºåˆ¶
./test_recovery_scenarios.sh
```

**æ€»ç»“**ï¼šå½“å‰ç³»ç»Ÿé‡‡ç”¨è¢«åŠ¨ç›‘å¬æ¨¡å¼ï¼Œä¾èµ–DJI SDKé€šçŸ¥ã€‚æµ‹è¯•æ–¹æ¡ˆéœ€è¦é€šè¿‡æ¨¡æ‹Ÿå’Œå•å…ƒæµ‹è¯•æ¥éªŒè¯ä¼˜åŒ–æ•ˆæœã€‚æ–°æ¶æ„å°†åœ¨ä¿æŒç°æœ‰é›†æˆçš„åŸºç¡€ä¸Šï¼Œæ·»åŠ åˆ†å—ä¼ è¾“ã€çŠ¶æ€ç®¡ç†å’Œæ¢å¤æœºåˆ¶ç­‰ç»„ä»¶ã€‚
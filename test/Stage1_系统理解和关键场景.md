# Stage 1 — 系统理解和关键场景识别

## 系统理解

### 系统目标
本系统是一个**边缘服务器到NAS的媒体文件同步系统**，主要目标：
1. **自动发现**：监控本地媒体目录，发现新的媒体文件
2. **可靠传输**：将媒体文件从边缘服务器传输到NAS存储
3. **状态管理**：跟踪文件传输状态，支持重试和错误处理
4. **存储优化**：管理NAS存储空间，自动清理旧文件
5. **并发控制**：防止多个同步进程冲突

### 系统架构

#### 核心组件
1. **MediaFindingDaemon** - 主守护进程
   - 文件发现和注册
   - 传输任务调度
   - 状态更新管理

2. **MediaStatusDB** - 数据库管理
   - SQLite数据库操作
   - 文件状态跟踪
   - 并发安全控制

3. **StorageManager** - 存储管理
   - NAS空间监控
   - 自动清理策略
   - 存储预警机制

4. **SyncLockManager** - 同步锁管理
   - 进程级互斥控制
   - 锁超时机制
   - 死锁预防

#### 数据流程
```
本地媒体目录 → 文件发现 → 数据库注册 → 传输队列 → NAS传输 → 状态更新
     ↓              ↓           ↓          ↓         ↓
  文件监控      哈希计算    状态跟踪    优先级排序   完整性验证
```

#### 关键约束
1. **单进程模式**：同时只能有一个守护进程运行
2. **线性传输**：文件按优先级顺序传输，不支持并发传输
3. **SQLite限制**：数据库并发能力有限
4. **网络依赖**：依赖SSH连接到NAS
5. **存储限制**：NAS存储空间有限，需要清理策略

### 系统流程

#### 主要用户/系统旅程

**Journey 1: 新文件发现和传输**
1. 守护进程扫描媒体目录
2. 发现新文件，计算哈希值
3. 检查数据库去重
4. 注册新文件为PENDING状态
5. 按优先级选择文件传输
6. 更新状态为TRANSFERRING
7. 执行rsync传输到NAS
8. 验证传输完整性
9. 更新状态为TRANSFERRED

**Journey 2: 存储空间管理**
1. 定期检查NAS存储使用率
2. 达到警告阈值时发送通知
3. 达到临界阈值时触发自动清理
4. 按清理规则删除旧文件
5. 验证空间释放效果

**Journey 3: 错误恢复**
1. 传输失败时更新状态为FAILED
2. 记录错误信息和重试次数
3. 下次扫描时重新尝试失败文件
4. 超过最大重试次数后标记为永久失败

## 关键测试场景识别

### 1. 功能性场景

#### 1.1 文件发现和过滤
- **正常文件发现**：标准媒体文件(.mp4, .jpg等)正确识别
- **文件过滤策略**：隐藏文件、临时文件、不支持格式被正确过滤
- **嵌套目录扫描**：多层目录结构中的文件能被发现
- **符号链接处理**：符号链接文件的处理策略

#### 1.2 去重和哈希计算
- **小文件哈希**：<100MB文件的完整哈希计算
- **大文件采样哈希**：>100MB文件的采样哈希策略
- **重复文件检测**：相同内容文件的去重机制
- **哈希冲突处理**：极低概率的哈希冲突场景

#### 1.3 传输功能
- **正常传输**：标准大小文件的成功传输
- **传输验证**：传输完整性的验证机制
- **目录结构创建**：NAS端目录自动创建
- **文件权限保持**：文件权限和时间戳保持

### 2. 边缘情况和异常场景

#### 2.1 大文件处理
- **超大文件传输**：20-30GB文件的传输稳定性
- **传输超时**：长时间传输的超时处理
- **部分传输恢复**：中断后的断点续传能力
- **磁盘空间不足**：传输过程中目标空间不足

#### 2.2 网络异常
- **网络中断**：传输过程中网络连接丢失
- **SSH连接失败**：NAS连接不可用时的处理
- **网络延迟**：高延迟网络环境下的表现
- **带宽限制**：低带宽环境下的传输策略

#### 2.3 系统异常
- **意外重启**：系统断电或重启后的状态恢复
- **进程崩溃**：守护进程异常退出后的恢复
- **数据库损坏**：SQLite数据库文件损坏
- **磁盘满**：本地磁盘空间耗尽

#### 2.4 并发和竞争条件
- **多进程启动**：意外启动多个守护进程实例
- **文件正在写入**：源文件仍在被其他进程写入
- **数据库锁竞争**：多个操作同时访问数据库
- **锁文件过期**：同步锁超时后的处理

#### 2.5 数据完整性
- **传输中断**：文件传输过程中的中断恢复
- **源文件变更**：传输过程中源文件被修改
- **目标文件冲突**：NAS端已存在同名文件
- **哈希不匹配**：传输后文件哈希验证失败

### 3. 性能和扩展性场景

#### 3.1 大量文件处理
- **批量文件发现**：一次性发现大量新文件
- **数据库性能**：大量记录时的查询性能
- **内存使用**：长时间运行的内存泄漏
- **日志文件增长**：日志文件的轮转和管理

#### 3.2 存储管理
- **存储空间监控**：准确的空间使用率计算
- **自动清理触发**：清理策略的正确执行
- **清理效果验证**：清理后空间释放的验证
- **清理过程中断**：清理过程被中断的处理

## 关键未知因素

### 1. 技术未知因素
- **rsync行为**：在各种异常情况下rsync的具体行为
- **SQLite并发**：高并发场景下SQLite的表现
- **SSH连接池**：SSH连接的复用和管理策略
- **文件系统特性**：不同文件系统的兼容性

### 2. 业务未知因素
- **文件生成模式**：媒体文件的实际生成频率和大小分布
- **网络环境**：实际部署环境的网络质量
- **存储需求**：实际的存储空间需求和增长模式
- **运维要求**：实际的监控和维护需求

### 3. 影响测试范围的关键问题
1. **最大文件大小**：系统需要支持的最大单文件大小？
2. **并发文件数量**：同时处理的最大文件数量？
3. **网络环境**：最差网络条件下的性能要求？
4. **恢复时间要求**：系统故障后的最大恢复时间？
5. **数据丢失容忍度**：是否允许在极端情况下丢失部分文件？

---

**下一步**：基于以上分析，需要进入Stage 2进行详细的风险评估和控制措施设计。
# 媒体文件同步系统 - 高优先级测试执行记录

**项目**: Celestial NAS Operations (媒体文件同步系统)  
**测试对象**: DJI Edge SDK 媒体文件管理系统  
**测试环境**: Ubuntu 24.04 边缘服务器 → NAS (192.168.200.103)  
**创建日期**: 2025-01-06  
**最后更新**: ___________  
**测试执行工程师**: ___________  

---

## 📋 测试执行状态说明

**状态标记**:
- ⏳ **待执行** - 尚未开始测试
- 🔄 **执行中** - 正在进行测试
- ✅ **通过** - 测试通过，功能正常
- ❌ **失败** - 测试失败，发现问题
- ⚠️ **部分通过** - 部分功能正常，存在轻微问题
- 🚫 **阻塞** - 因依赖问题无法执行

**执行记录格式**:
```
执行日期: YYYY-MM-DD HH:MM
执行人员: [姓名]
测试结果: [状态]
备注说明: [详细说明]
```

---

## 🔥 P0级 - 关键功能测试 (必须通过)

### TC-P0-001: 系统服务基础功能验证
**状态**: ⏳ **待执行**

**测试目标**: 验证两个核心服务能够正常启动和运行

**前置条件**:
- 系统已部署完成
- 数据库已初始化
- SSH密钥配置完成

**测试步骤**:
1. **检查服务状态**
   ```bash
   sudo systemctl status dock-info-manager.service
   sudo systemctl status media_finding_daemon.service
   ```
   **预期结果**: 两个服务状态为 `active (running)`

2. **检查服务日志**
   ```bash
   journalctl -u dock-info-manager.service -n 20
   journalctl -u media_finding_daemon.service -n 20
   ```
   **预期结果**: 无ERROR级别日志，服务正常启动

3. **检查进程运行**
   ```bash
   ps aux | grep dock_info_manager
   ps aux | grep media_finding_daemon
   ```
   **预期结果**: 进程正常运行，无僵尸进程

**执行记录**:
```
执行日期: ___________
执行人员: ___________
测试结果: ___________
备注说明: ___________
```

---

### TC-P0-002: 数据库连接和基础操作
**状态**: ⏳ **待执行**

**测试目标**: 验证数据库连接正常，基础CRUD操作可用

**测试步骤**:
1. **检查数据库文件**
   ```bash
   ls -la /data/temp/dji/media_status.db
   sqlite3 /data/temp/dji/media_status.db ".tables"
   ```
   **预期结果**: 数据库文件存在，包含 `media_transfer_status` 表

2. **验证表结构**
   ```bash
   sqlite3 /data/temp/dji/media_status.db ".schema media_transfer_status"
   ```
   **预期结果**: 表结构完整，包含所有必需字段

3. **测试数据库写入**
   ```bash
   cd /home/celestial/dev/esdk-test/Edge-SDK/celestial_nasops
   python3 -c "from media_status_db import MediaStatusDB; db=MediaStatusDB('/data/temp/dji/media_status.db'); db.connect(); print('连接成功')"
   ```
   **预期结果**: 连接成功，无异常

4. **检查数据库记录**
   ```bash
   sqlite3 /data/temp/dji/media_status.db "SELECT COUNT(*) FROM media_transfer_status;"
   ```
   **预期结果**: 返回记录数量，无错误

**执行记录**:
```
执行日期: ___________
执行人员: ___________
测试结果: ___________
备注说明: ___________
```

---

### TC-P0-003: NAS网络连接验证
**状态**: ⏳ **待执行**

**测试目标**: 验证到NAS的网络连接和SSH认证正常

**测试步骤**:
1. **网络连通性测试**
   ```bash
   ping -c 3 192.168.200.103
   ```
   **预期结果**: 3个包全部成功，延迟 < 10ms

2. **SSH连接测试**
   ```bash
   ssh nas-edge "echo 'SSH连接成功'"
   ```
   **预期结果**: 成功输出 "SSH连接成功"，无密码提示

3. **远程目录访问**
   ```bash
   ssh nas-edge "ls -la /volume1/homes/edge_sync/drone_media/"
   ```
   **预期结果**: 成功列出目录内容

4. **写入权限测试**
   ```bash
   ssh nas-edge "touch /volume1/homes/edge_sync/drone_media/test_write_$(date +%s).tmp && echo '写入权限正常'"
   ```
   **预期结果**: 成功创建文件，输出 "写入权限正常"

**执行记录**:
```
执行日期: ___________
执行人员: ___________
测试结果: ___________
备注说明: ___________
```

---

### TC-P0-004: 小文件端到端传输测试
**状态**: ⏳ **待执行**

**测试目标**: 验证完整的文件传输流程正常工作

**测试步骤**:
1. **创建测试文件**
   ```bash
   cd /data/temp/dji/media/
   echo "测试内容 $(date)" > test_small_$(date +%s).txt
   ls -la test_small_*.txt
   ```
   **预期结果**: 成功创建测试文件

2. **触发文件发现**
   - 等待 media_finding_daemon 自动扫描（约30秒）
   - 或重启服务强制扫描：`sudo systemctl restart media_finding_daemon`

3. **检查数据库记录**
   ```bash
   sqlite3 /data/temp/dji/media_status.db "SELECT file_name, download_status, transfer_status FROM media_transfer_status WHERE file_name LIKE 'test_small_%' ORDER BY created_at DESC LIMIT 1;"
   ```
   **预期结果**: 文件已记录，状态为 completed/transferring

4. **验证远程文件**
   ```bash
   ssh nas-edge "find /volume1/homes/edge_sync/drone_media/EdgeBackup/ -name 'test_small_*' -type f"
   ```
   **预期结果**: 在NAS上找到对应文件

5. **验证文件内容**
   ```bash
   # 获取本地文件内容
   cat /data/temp/dji/media/test_small_*.txt
   # 获取远程文件内容
   ssh nas-edge "cat \$(find /volume1/homes/edge_sync/drone_media/EdgeBackup/ -name 'test_small_*' -type f | head -1)"
   ```
   **预期结果**: 本地和远程文件内容完全一致

**执行记录**:
```
执行日期: ___________
执行人员: ___________
测试结果: ___________
备注说明: ___________
```

---

## 🔥 P1级 - 高风险场景测试 (强烈建议执行)

### TC-P1-001: 大文件传输完整性测试
**状态**: ⏳ **待执行**

**测试目标**: 验证大文件（>100MB）传输的完整性和稳定性

**测试步骤**:
1. **创建大文件**
   ```bash
   cd /data/temp/dji/media/
   dd if=/dev/urandom of=test_large_$(date +%s).bin bs=1M count=150
   sha256sum test_large_*.bin > test_large_checksum.txt
   ```
   **预期结果**: 成功创建150MB测试文件

2. **监控传输过程**
   ```bash
   # 实时监控日志
   tail -f /home/celestial/dev/esdk-test/Edge-SDK/celestial_nasops/logs/media_finding.log
   ```
   **预期结果**: 传输过程无ERROR，显示进度信息

3. **验证传输完成**
   - 等待传输完成（预计5-10分钟）
   - 检查数据库状态：
   ```bash
   sqlite3 /data/temp/dji/media_status.db "SELECT file_name, file_size, transfer_status, transfer_end_time FROM media_transfer_status WHERE file_name LIKE 'test_large_%';"
   ```
   **预期结果**: transfer_status = 'completed'

4. **校验文件完整性**
   ```bash
   # 计算远程文件校验和
   ssh nas-edge "sha256sum \$(find /volume1/homes/edge_sync/drone_media/EdgeBackup/ -name 'test_large_*.bin' | head -1)"
   # 对比本地校验和
   cat test_large_checksum.txt
   ```
   **预期结果**: 本地和远程文件SHA256值完全一致

**执行记录**:
```
执行日期: ___________
执行人员: ___________
测试结果: ___________
备注说明: ___________
```

---

### TC-P1-002: 网络中断恢复测试
**状态**: ⏳ **待执行**

**测试目标**: 验证网络中断后系统的恢复能力

**测试步骤**:
1. **准备测试文件**
   ```bash
   cd /data/temp/dji/media/
   dd if=/dev/urandom of=test_network_$(date +%s).bin bs=1M count=50
   ```

2. **开始传输并中断网络**
   - 启动传输后立即执行：
   ```bash
   # 模拟网络中断（谨慎操作）
   sudo iptables -A OUTPUT -d 192.168.200.103 -j DROP
   sleep 30
   # 恢复网络
   sudo iptables -D OUTPUT -d 192.168.200.103 -j DROP
   ```

3. **观察恢复过程**
   ```bash
   tail -f /home/celestial/dev/esdk-test/Edge-SDK/celestial_nasops/logs/media_finding.log | grep -E "(ERROR|retry|failed|completed)"
   ```
   **预期结果**: 系统检测到网络错误，进行重试，最终传输成功

4. **验证最终结果**
   ```bash
   sqlite3 /data/temp/dji/media_status.db "SELECT file_name, transfer_status, transfer_retry_count FROM media_transfer_status WHERE file_name LIKE 'test_network_%';"
   ```
   **预期结果**: transfer_status = 'completed', retry_count > 0

**⚠️ 注意**: 此测试会临时中断到NAS的网络连接，请在非生产时间执行

**执行记录**:
```
执行日期: ___________
执行人员: ___________
测试结果: ___________
备注说明: ___________
```

---

### TC-P1-003: 系统重启后状态一致性测试
**状态**: ⏳ **待执行**

**测试目标**: 验证系统重启后能正确恢复传输状态

**测试步骤**:
1. **创建多个测试文件**
   ```bash
   cd /data/temp/dji/media/
   for i in {1..3}; do
     dd if=/dev/urandom of=test_restart_${i}_$(date +%s).bin bs=1M count=20
   done
   ```

2. **记录重启前状态**
   ```bash
   sqlite3 /data/temp/dji/media_status.db "SELECT file_name, download_status, transfer_status FROM media_transfer_status WHERE file_name LIKE 'test_restart_%';"
   ```

3. **系统重启**
   ```bash
   sudo systemctl restart media_finding_daemon
   sudo systemctl restart dock-info-manager
   ```

4. **验证服务恢复**
   ```bash
   sleep 10
   sudo systemctl status media_finding_daemon dock-info-manager
   ```
   **预期结果**: 两个服务都正常启动

5. **检查状态恢复**
   ```bash
   # 等待2分钟让系统处理
   sleep 120
   sqlite3 /data/temp/dji/media_status.db "SELECT file_name, download_status, transfer_status FROM media_transfer_status WHERE file_name LIKE 'test_restart_%';"
   ```
   **预期结果**: 未完成的传输能够继续进行

**执行记录**:
```
执行日期: ___________
执行人员: ___________
测试结果: ___________
备注说明: ___________
```

---

### TC-P1-004: 存储空间不足处理测试
**状态**: ⏳ **待执行**

**测试目标**: 验证本地存储空间不足时的处理机制

**测试步骤**:
1. **检查当前存储空间**
   ```bash
   df -h /data/temp/dji/
   ```

2. **模拟存储空间不足**
   ```bash
   # 创建大文件占用空间（根据实际可用空间调整）
   cd /data/temp/dji/
   fallocate -l 1G temp_space_filler.bin
   df -h /data/temp/dji/
   ```

3. **尝试创建新文件**
   ```bash
   cd /data/temp/dji/media/
   dd if=/dev/urandom of=test_storage_$(date +%s).bin bs=1M count=100
   ```

4. **观察系统行为**
   ```bash
   tail -f /home/celestial/dev/esdk-test/Edge-SDK/celestial_nasops/logs/media_finding.log | grep -E "(storage|space|disk|ERROR)"
   ```
   **预期结果**: 系统检测到存储空间问题，记录相应日志

5. **清理并验证恢复**
   ```bash
   rm /data/temp/dji/temp_space_filler.bin
   df -h /data/temp/dji/
   ```
   **预期结果**: 清理后系统恢复正常

**执行记录**:
```
执行日期: ___________
执行人员: ___________
测试结果: ___________
备注说明: ___________
```

---

## 🔥 P2级 - 并发和性能测试 (建议执行)

### TC-P2-001: 多文件并发传输测试
**状态**: ⏳ **待执行**

**测试目标**: 验证系统处理多个文件同时传输的能力

**测试步骤**:
1. **批量创建测试文件**
   ```bash
   cd /data/temp/dji/media/
   for i in {1..10}; do
     dd if=/dev/urandom of=test_concurrent_${i}_$(date +%s).bin bs=1M count=10 &
   done
   wait
   ls -la test_concurrent_*.bin
   ```

2. **监控处理过程**
   ```bash
   tail -f /home/celestial/dev/esdk-test/Edge-SDK/celestial_nasops/logs/media_finding.log | grep -E "(processing|transferring|completed)"
   ```

3. **检查处理结果**
   ```bash
   sqlite3 /data/temp/dji/media_status.db "SELECT COUNT(*) as total, transfer_status, COUNT(*) as count FROM media_transfer_status WHERE file_name LIKE 'test_concurrent_%' GROUP BY transfer_status;"
   ```
   **预期结果**: 所有文件最终都成功传输

**执行记录**:
```
执行日期: ___________
执行人员: ___________
测试结果: ___________
备注说明: ___________
```

---

### TC-P2-002: 长时间运行稳定性测试
**状态**: ⏳ **待执行**

**测试目标**: 验证系统长时间运行的稳定性

**测试步骤**:
1. **设置监控脚本**
   ```bash
   # 创建监控脚本
   cat > /tmp/stability_monitor.sh << 'EOF'
   #!/bin/bash
   for i in {1..60}; do  # 监控1小时
     echo "=== $(date) ==="
     systemctl is-active dock-info-manager media_finding_daemon
     ps aux | grep -E "(dock_info_manager|media_finding_daemon)" | grep -v grep
     free -h
     df -h /data/temp/dji/
     sleep 60
   done
   EOF
   chmod +x /tmp/stability_monitor.sh
   ```

2. **启动监控**
   ```bash
   /tmp/stability_monitor.sh > /tmp/stability_log_$(date +%s).txt 2>&1 &
   ```

3. **定期创建测试文件**
   ```bash
   # 每10分钟创建一个文件
   for i in {1..6}; do
     sleep 600  # 10分钟
     cd /data/temp/dji/media/
     dd if=/dev/urandom of=test_stability_${i}_$(date +%s).bin bs=1M count=5
   done
   ```

4. **检查最终状态**
   ```bash
   # 检查所有测试文件是否成功处理
   sqlite3 /data/temp/dji/media_status.db "SELECT file_name, transfer_status FROM media_transfer_status WHERE file_name LIKE 'test_stability_%';"
   ```

**执行记录**:
```
执行日期: ___________
执行人员: ___________
测试结果: ___________
备注说明: ___________
```

---

## 📊 测试执行总结

### 测试完成情况统计

| 优先级 | 总数 | 通过 | 失败 | 部分通过 | 阻塞 | 待执行 |
|--------|------|------|------|----------|------|--------|
| P0级   | 4    | __   | __   | __       | __   | __     |
| P1级   | 4    | __   | __   | __       | __   | __     |
| P2级   | 2    | __   | __   | __       | __   | __     |
| **总计** | **10** | **__** | **__** | **__** | **__** | **__** |

### 关键问题记录

| 问题ID | 优先级 | 问题描述 | 发现日期 | 状态 | 负责人 |
|--------|--------|----------|----------|------|--------|
| BUG-001 | | | | | |
| BUG-002 | | | | | |
| BUG-003 | | | | | |

### 测试环境信息

**系统信息**:
- 操作系统: Ubuntu 24.04
- 边缘服务器IP: 192.168.200.55
- NAS服务器IP: 192.168.200.103
- 数据库路径: /data/temp/dji/media_status.db
- 媒体文件路径: /data/temp/dji/media/

**服务版本**:
- dock-info-manager: ___________
- media_finding_daemon: ___________
- SQLite版本: ___________

### 测试执行注意事项

1. **执行顺序**: 必须按P0 → P1 → P2的顺序执行，P0级全部通过后才能进行P1级测试
2. **环境要求**: 确保测试环境与生产环境配置一致
3. **数据清理**: 每个测试用例执行完成后，及时清理测试数据
4. **日志保存**: 保存所有测试过程中的日志文件，便于问题分析
5. **网络测试**: TC-P1-002网络中断测试请在非生产时间执行
6. **存储测试**: TC-P1-004存储空间测试请确保有足够的恢复空间

### 联系信息

**技术支持**: ___________  
**项目负责人**: ___________  
**紧急联系**: ___________  

---

**文档版本**: v1.0  
**最后更新**: 2025-01-06  
**下次审查**: ___________